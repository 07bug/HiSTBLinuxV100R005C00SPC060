/******************************************************************************
*
* Copyright (C) 2016 Hisilicon Technologies Co., Ltd.  All rights reserved.
*
* This program is confidential and proprietary to Hisilicon  Technologies Co., Ltd. (Hisilicon),
*  and may not be copied, reproduced, modified, disclosed to others, published or used, in
* whole or in part, without the express prior written permission of Hisilicon.
*
*****************************************************************************

  File Name    : pq_hal_hdr.c
  Version       : Initial Draft
  Author        : sdk
                      sdk
  Created      : 2016/06/15
  Description  :

******************************************************************************/
#include <linux/string.h>

#include "hi_type.h"
#include "hi_math.h"

#include "pq_hal_comm.h"
#include "drv_pq_ext.h"
#include "pq_hal_hdr.h"

#define HDR_MIN(x, y) (((x) > (y)) ? (y) : (x))
#define HDR_MAX(x, y) (((x) > (y)) ? (x) : (y))
#define HDR_CLIP3(low,high,x)  (HDR_MAX(HDR_MIN((high),(x)),(low)))

typedef HI_S32 (*PF_PQ_Hal_GetHdrPathCfg) (HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg);

static HI_PQ_HDR_MODE_E aenPqHalHdrPathMode[HI_DRV_VIDEO_FRAME_TYPE_BUTT][HI_PQ_DISP_TYPE_BUTT] =
{
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_HDR10,    HI_PQ_HDR_MODE_SDR_TO_HLG   },   /* sdr */
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* bl */  //offer sdr para
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* el */  //offer sdr para
    {HI_PQ_HDR_MODE_HDR10_TO_SDR,   HI_PQ_HDR_MODE_HDR10_TO_HDR10,  HI_PQ_HDR_MODE_HDR10_TO_HLG },   /* hdr10 */
    {HI_PQ_HDR_MODE_HLG_TO_SDR,     HI_PQ_HDR_MODE_HLG_TO_HDR10,    HI_PQ_HDR_MODE_HLG_TO_HLG   },   /* hlg */
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* slf */
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* tech */
};

static const HI_S32 g_au32SinTable[61] =
{
    -500, -485, -469, -454, -438, -422, -407, -391,
    -374, -358, -342, -325, -309, -292, -276, -259,
    -242, -225, -208, -191, -174, -156, -139, -122,
    -104,  -87,  -70,  -52,  -35,  -17,    0,   17,
    35,     52,   70,   87,  104,  122,  139,  156,
    174,   191,  208,  225,  242,  259,  276,  292,
    309,   325,  342,  358,  374,  391,  407,  422,
    438,   454,  469,  485,  500
};

static const HI_U32 g_au32CosTable[61] =
{
    866, 875, 883, 891, 899,  906,  914,  921,
    927, 934, 940, 946, 951,  956,  961,  966,
    970, 974, 978, 982, 985,  988,  990,  993,
    995, 996, 998, 999, 999, 1000, 1000, 1000,
    999, 999, 998, 996, 995,  993,  990,  988,
    985, 982, 978, 974, 970,  966,  961,  956,
    951, 946, 940, 934, 927,  921,  914,  906,
    899, 891, 883, 875, 866
};

static HI_PQ_HDR_CFG *pg_stPqHdrCfg     = HI_NULL;
static PQ_HDR_TM_COEF_S sg_stHdrTmClutBinOrCode;
static PQ_PARAM_S *sg_pstHdrBinPara  = HI_NULL;
static HI_PQ_HDR_MODE_E sg_enHDRMode    = HI_PQ_HDR_MODE_HDR10_TO_SDR;

static DM_INFO_S stDminfo = {0};

static HI_U32 sg_u32ToolHdrTmMode = 0;//选择HDR参数模式。0:固定参数，1:工具调试参数
static HI_U32 sg_u32ToolHdrSmMode = 0;//选择HDR参数模式。0:固定参数，1:.工具调试参数

static HI_U16 sg_au16ToolTmScale = 8;

HI_S16 g_aDstCSCTable[3][3];
HI_S16 g_as16DcOutR2Y[3] = { 64,  512,  512 };

static HI_U32 g_au32Sdr2HdrTMLutBasicLut[256] =      // U24.0
{
    85,      85,      85,      85,      85,      85,      85,      85,
    85,      85,      85,      85,      88,      95,     104,     119,
    141,     221,     287,     349,     410,     468,     527,     584,
    638,     697,     757,     815,     869,     920,     971,    1026,
    1083,    1136,    1186,    1239,    1296,    1353,    1407,    1458,
    1509,    1560,    1612,    1663,    1715,    1922,    2128,    2336,
    2543,    2751,    2959,    3169,    3361,    3768,    4164,    4572,
    4958,    5353,    5761,    6142,    6517,    6934,    7309,    7683,
    8101,    8482,    8853,    9253,    9662,   10410,   11161,   11907,
    12721,   13477,   14228,   14979,   15729,   16479,   17229,   17979,
    18729,   19478,   20228,   20977,   21727,   22476,   23226,   23975,
    24725,   27725,   30727,   33731,   36591,   39591,   42595,   45602,
    48613,   51462,   54441,   57453,   60469,   63488,   66528,   69298,
    72308,   75332,   78359,   81389,   84423,   87460,   90500,   93543,
    96589,   99638,  102691,  105746,  108804,  111865,  114929,  117996,
    121065,  124137,  127212,  130290,  133371,  136454,  139539,  142627,
    145687,  148940,  152394,  155502,  158601,  161712,  164826,  167911,
    171123,  174648,  177885,  180984,  184120,  187238,  190383,  193862,
    197309,  210163,  223199,  236648,  250175,  263813,  277903,  291445,
    306069,  319666,  334398,  348533,  362968,  377848,  392807,  407843,
    422873,  439248,  454631,  469943,  486154,  502314,  517800,  534934,
    550767,  568132,  584137,  601832,  619570,  637238,  653532,  671587,
    689681,  707875,  726167,  744421,  763975,  783788,  802343,  821146,
    841860,  861235,  881102,  901997,  921164,  942060,  963515,  984987,
    1006587, 1028314, 1050166, 1072143, 1094244, 1116467, 1138811, 1161277,
    1183826, 1206384, 1230502, 1255618, 1280914, 1305136, 1328256, 1353208,
    1379069, 1483144, 1589427, 1705480, 1821074, 1944581, 2072822, 2206172,
    2348807, 2494317, 2650839, 2809902, 2977802, 3157838, 3337980, 3532184,
    3732155, 3949307, 4172173, 4402177, 4651658, 4908006, 5171077, 5455412,
    5751030, 6070628, 6399038, 6744628, 7111678, 7499749, 7910258, 8332163,
    8778848, 9262486, 9771750, 10307621, 10877046, 11469037, 12113218, 12877825,
    13620506, 14388091, 15209051, 16139633, 16777216, 16777216, 16777216, 16777216,
};


HI_S16 g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_BUTT][3][3];
HI_S16 g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_BUTT][3] =
{
    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 },

    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 },

    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 },

    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 }
};

/* ------------------Y2R:YUV2RGB---------------------------- */

/* YUV to RGB params: 10bit in, 10bit out */
static const HI_U16 u16Y2RScale   = 13;    /*U4.0  [0,15] */
static const HI_U16 u16Y2RClipMin = 0;     /* U10.0  [0,1023] */
static const HI_U16 u16Y2RClipMax = 1023;  /* U10.0  [0,1023] */
static const HI_U16 u16ClipMaxY2R_1000 = 770;
static const HI_U16 u16ClipMaxY2R_1500 = 815;

static const HI_S16 as16Y2RDcInLimit[3] =       /* S10.0  [-1024, 1023] */
{
    -64,
    -512,
    -512
};

static const HI_S16 as16Y2RDcInFull[3] =
{
    0,
    -512,
    -512
};

static const HI_S16 as16Y2RM33_601L[3][3] =
{
    {9567 , 0      ,  13113} ,
    {9567 , -3219 ,  -6679},
    {9567 , 16557 ,  0    }
};

static const HI_S16 as16Y2RM33_601F[3][3] =
{
    {8192 ,  0      ,   11485} ,
    {8192 ,  -2819  ,  -5850 },
    {8192 , 14501  ,    0   }
};

static const HI_S16 as16Y2RM33_709L[3][3] =
{
    {9567,           0,       14729},
    {9567,       -1752,       -4379},
    {9567,       17356,           0}
};

static const HI_S16 as16Y2RM33_709F[3][3] =
{
    {8192,           0 ,      12901},
    {8192,       -1535 ,      -3835},
    {8192 ,       15201 ,          0}
};

static const HI_S16 as16Y2RM33_2020L[3][3] =
{
    {9567,           0 ,      13792},
    {9567,       -1539 ,      -5344},
    {9567 ,       17597,           0}
};

static const HI_S16 as16Y2RM33_2020F[3][3] =
{
    {8192,           0 ,      12080},
    {8192 ,      -1348  ,     -4681},
    {8192 ,      15412 ,          0}
};

static const HI_S16 as16Y2RDcOut[3] =      /*  S10.0 [-1024, 1023] */
{
    0,
    0,
    0
};

/* ---------------------------------------------- */

/************* DeGamma Params **************/
static const HI_U32 au32DeGmm_step[PQ_DEGMM_SEG_SIZE] =
{
    3, 4, 5, 6
};          /*U4.0  [0,15] */

static const HI_U32 au32DeGmm_pos[PQ_DEGMM_SEG_SIZE]  =
{
    208, 640, 896, 1023
};/*U10.0 [0,1023] */

static const HI_U32 au32DeGmm_num[PQ_DEGMM_SEG_SIZE]  =
{
    26, 27, 8, 2
};        /*U6.0  [0,63] */

/* DePQ curve: HDR10 */
static const HI_U32 au32DeGmmLut_PQ[PQ_DEGMM_LUT_SIZE] =                            //U20.0 [0,1048575]
{
    0 ,         0 ,         1 ,         1 ,         2 ,         4 ,         5 ,         8 ,        11 ,        14 ,        18 ,        23 ,        29 ,        35 ,        43 ,        52 ,
    62 ,        74 ,        87 ,       102 ,       118 ,       137 ,       158 ,       181 ,       207 ,       236 ,       268 ,       342 ,       432 ,       540 ,       671 ,       826 ,
    1012 ,      1231 ,      1491 ,      1796 ,      2155 ,      2576 ,      3068 ,      3643 ,      4312 ,      5091 ,      5997 ,      7047 ,      8264 ,      9673 ,     11302 ,     13186 ,
    15362 ,     17873 ,     20770 ,     24111 ,     27962 ,     32399 ,     43403 ,     58004 ,     77382 ,    103115 ,    137324 ,    182875 ,    243651 ,    324943 ,    580813 ,   1048575 ,
};

/* DeHLG Curve: BBC HDR */
static const HI_U32 au32DeGmmLut_HLG[PQ_DEGMM_LUT_SIZE] =                               //U20.0 [0,1048575]
{
    0 ,        21 ,        85 ,       192 ,       341 ,       533 ,       768 ,      1045 ,      1365 ,      1728 ,      2133 ,      2581 ,      3072 ,      3605 ,      4181 ,      4800 ,
    5461 ,      6165 ,      6912 ,      7701 ,      8533 ,      9408 ,     10325 ,     11285 ,     12288 ,     13333 ,     14421 ,     16725 ,     19200 ,     21845 ,     24661 ,     27648 ,
    30805 ,     34133 ,     37632 ,     41301 ,     45141 ,     49152 ,     53333 ,     57685 ,     62208 ,     66901 ,     71765 ,     76800 ,     82005 ,     87381 ,     93088 ,     99316 ,
    106113 ,    113530 ,    121625 ,    130458 ,    140098 ,    150619 ,    174628 ,    203223 ,    237277 ,    277833 ,    326133 ,    383656 ,    452163 ,    533750 ,    746633 ,   1048575
};

// DeGamma Curve: SDR
static const HI_U32 au32DeGmmLut_24[PQ_DEGMM_LUT_SIZE] =                            //U20.0 [0,1048575]
{
    0 ,         9 ,        49 ,       128 ,       256 ,       437 ,       677 ,       981 ,      1351 ,      1793 ,      2308 ,      2902 ,      3575 ,      4333 ,      5176 ,      6108 ,
    7132 ,      8248 ,      9461 ,     10772 ,     12183 ,     13697 ,     15315 ,     17039 ,     18871 ,     20814 ,     22868 ,     27320 ,     32239 ,     37641 ,     43536 ,     49937 ,
    56856 ,     64304 ,     72293 ,     80832 ,     89932 ,     99603 ,    109856 ,    120699 ,    132142 ,    144194 ,    156864 ,    170160 ,    184092 ,    198668 ,    213895 ,    229783 ,
    246338 ,    263569 ,    281483 ,    300088 ,    319391 ,    339400 ,    381563 ,    426633 ,    474664 ,    525710 ,    579823 ,    637053 ,    697449 ,    761060 ,    898112 ,   1048575
};

static const HI_U32 au32DeGmmLut_22[PQ_DEGMM_LUT_SIZE] =                            //U20.0 [0,1048575]
{
    0 ,        24 ,       111 ,       272 ,       512 ,       837 ,      1249 ,      1754 ,      2353 ,      3048 ,      3844 ,      4740 ,      5740 ,      6846 ,      8058 ,      9379 ,
    10809 ,     12352 ,     14007 ,     15776 ,     17661 ,     19662 ,     21780 ,     24018 ,     26376 ,     28854 ,     31454 ,     37024 ,     43093 ,     49667 ,     56753 ,     64358 ,
    72487 ,     81146 ,     90341 ,    100077 ,    110358 ,    121190 ,    132578 ,    144526 ,    157038 ,    170118 ,    183772 ,    198002 ,    212814 ,    228209 ,    244194 ,    260770 ,
    277941 ,    295712 ,    314085 ,    333064 ,    352651 ,    372851 ,    415099 ,    459832 ,    507073 ,    556845 ,    609169 ,    664065 ,    721556 ,    781659 ,    909780 ,   1048575 ,

};

/* ------------------ToneMapping---------------------------- */

/* ToneMapping Tmap Params: 20bit in, 20bit out */
static const HI_U16 u16TmScaleLumaCal       = 15;                   /* U4.0  [0,15] */
static const HI_U16 au16TmM3LumaCal_2020[3] = {8608, 22217, 1943};  /* U1.15 [0, 65535]     {0.2627, 0.6780, 0.0593}<<u16TmScaleLumaCal */
static const HI_U16 au16TmM3LumaCal_709[3]  = {6970, 23432, 2366};  /* U1.15 [0, 65535]      */
static const HI_U16 au16TmM3LumaCal_601[3]  = {9798, 19235, 3736};  // U1.15 [0, 65535]

static const HI_U16 u16ScaleCoefTM       = 8;                    /*  U4.0  [0,15] */
static const HI_U32 u32TmClipMin         = 0;                    /*  U20.0  [0,1048575] */
static const HI_U32 u32TmClipMax         = 1048575;              /*  U20.0  [0,1048575] */

/* ------------------GamutMapping---------------------------- */
/* GamutMapping Params: 20bit in, 20bit out  */
static const HI_U16 u16GMapScale   = 14;                        /*  U4.0  [0,15] */
static const HI_U32 u32GMapClipMin = 0;                         /*   U20.0 [0,1048575] */
static const HI_U32 u32GMapClipMax = 1048575;                   /*   U20.0 [0,1048575] */

static const HI_S16 as16M33GMap_2020to709[3][3] =               /*  S1.14 [-2^15, 2^15-1] = [-32768, 32767] */
{
    //BT2020 to BT709
    {19842 , -3458  ,  0     },
    { -2028 , 18412  ,  0     },
    { -300  , -1618  ,  18302 }
};

static const HI_S16 as16M33GMap_709to2020[3][3] =               /*   S1.14 [-2^15, 2^15-1] = [-32768, 32767]  */
{
    //BT709 to BT2020
    {10279 ,       5396  ,       710},
    {1134  ,     15064   ,      187 },
    {268   ,     1442    ,   14673  }
};

static const HI_S16 as16M33GMap_linear[3][3] =                  /*  S1.14 [-2^15, 2^15-1] = [-32768, 32767] */
{
    /* Linear */
    { 16384,       0  ,       0 },
    {     0,     16384,       0 },
    {     0,       0  ,   16384 }
};


static const HI_S16 as16M33GMAP_Pal_601_709[3][3] =
{
    //BT601 to BT709
    {17106  ,      -724      ,    -1 },
    { -2   ,    16386    ,       0 },
    { 1    ,    193     ,  16191  }
};

static const HI_S16 as16M33GMAP_Ntsc_601_709[3][3] =
{
    //BT601ntsc to BT709
    { 15394  ,       820     ,    167 },
    {  290   ,    15826    ,     269},
    {  -26   ,      -72   ,    16483  }
};

static const HI_S16 as16M33GMAP_Pal_601_2020[3][3] =
{
    //BT601 to BT2020
    { 10731 ,       4951   ,      701 },
    { 1182  ,     15018   ,      184 },
    {  280   ,     1603   ,   14500  }
};

static const HI_S16 as16M33GMAP_Ntsc_601_2020[3][3] =
{
    //BT601ntsc to BT2020
    {  9752    ,    5723   ,      908 },
    { 1331    ,   14606    ,     447 },
    {  254    ,    1342    ,   14788  }
};


static const HI_U32 au32TMapStep[PQ_TMAP_SEG_SIZE] =        /* U5.0  [0,20] */
{
    4,  6,  8,  9,  10, 12, 14, 16
};

static const HI_U32 au32TMapNum[PQ_TMAP_SEG_SIZE]  =        /* U6.0  [0,63] */
{
    4,  11, 13, 17, 22, 36, 52, 63
};

static const HI_U32 au32TMapPos[PQ_TMAP_SEG_SIZE]  =        /* U20.0 [0,1048575] */
{
    64, 512,    1024,   3072,   8192,   65536,  327680, 1048575
};

/* ToneMapping Lut: HDR10  to SDR */
static const HI_U16 u16ScaleCoefTM_HDR2SDR = 8;//7;         /* U4.0  [0,15] */
static const HI_U32 au32TMLut_HDR2SDR[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0,  5000,  7000,  9000, 10568, 10091,  9768,  9531,
    9348,  9200,  9078,  8974,  8675,  8478,  8220,  8045,
    7912,  7801,  7619,  7467,  7332,  7209,  7093,  6680,
    6317,  5988,  5686,  5407,  5149,  4909,  4685,  4477,
    4282,  4099,  3929,  3769,  3619,  3104,  2698,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
};

static const HI_U32 au32TMLut_HDR2SDR_1200[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0,      5000,   7000,   9000,   9481,   9018,   8705,   8475,
    8298,   8155,   8037,   7938,   7652,   7466,   7225,   7067,
    6947,   6850,   6694,   6566,   6455,   6353,   6259,   5927,
    5637,   5373,   5130,   4905,   4694,   4497,   4312,   4138,
    3975,   3821,   3676,   3539,   3410,   2961,   2598,   2303,
    2134,   2134,   2134,   2134,   2134,   2134,   2134,   2134,
    2134,   2134,   2134,   2134,   2134,   2134,   2134,   2134,
    2134,   2134,   2134,   2134,   2134,   2134,   2134,   2134,
};

/*************** ToneMapping Lut Params:  *******************************/

static HI_U32 au32TMLut_HDR2SDR_b100[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0, 5000, 7000, 9000, 10568, 10091, 9768, 9657, 9657, 9657, 9657, 9657, 9657, 9657, 9657, 9657,
    9657, 9657, 9657, 9657, 9657, 9657, 9657, 9357, 8943, 8226, 7590, 7024, 6519, 6067, 5662, 5298,
    4971, 4675, 4407, 4164, 3943, 3233, 2724, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560,
    2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560
};

static HI_U32 au32TMLut_HDR2SDR_b0[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0, 5000, 7000, 9000, 10568, 10091, 9768, 9531, 9517, 9002, 8580, 8225, 7229, 6604, 5846, 5391,
    5081, 4855, 4539, 4325, 4167, 4043, 3942, 3662, 3476, 3334, 3215, 3111, 3018, 2933, 2854, 2780,
    2710, 2643, 2580, 2519, 2461, 2251, 2070, 1910, 1770, 1645, 1534, 1434, 1345, 1280, 1280, 1280,
    1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280, 1280
};

static HI_U32 au32TMLut_HDR2SDR_d100[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    11000, 15000, 19516, 23217, 25185, 18878, 16199, 14444, 13223, 12243, 11450, 10884, 9903, 9370, 8568, 8065,
    7912, 7801, 7619, 7467, 7332, 7209, 7093, 6680, 6317, 5988, 5686, 5407, 5149, 4909, 4685, 4477 ,
    4282, 4099, 3929, 3769, 3619, 3104, 2698, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560 ,
    2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560
};

static HI_U32 au32TMLut_HDR2SDR_d0[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{

    0, 500, 877, 1350, 1839, 2607, 3220, 3740, 4142, 4422, 4638, 4828, 5662, 6292, 6641, 6803,
    6960, 7115, 7363, 7452, 7332, 7209, 7093, 6680, 6317, 5988, 5686, 5407, 5149, 4909, 4685, 4477,
    4282, 4099, 3929, 3769, 3619, 3104, 2698, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560,
    2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560, 2560
};

static HI_U32 au32TMLut_HDR2SDR_BP[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0,  4000,  6000,  8000,  9075,  8366,  7891,  7543,
    7276,  7062,  6886,  6738,  6321,  6057,  5732,  5532,
    5393,  5287,  5133,  5021,  4933,  4859,  4794,  4589,
    4426,  4285,  4156,  4036,  3924,  3817,  3716,  3619,
    3526,  3437,  3352,  3270,  3191,  2902,  2651,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
};

static HI_U32 au32TMLut_HDR2SDR_DP[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0, 15700, 30904, 34617, 33503, 30186, 27952, 26319,
    25058, 24048, 23215, 22513, 20516, 19236, 17622, 16596,
    15854, 15274, 14387, 13706, 13143, 12656, 12223, 10815,
    9715,  8804,  8028,  7360,  6778,  6267,  5816,  5417,
    5062,  4745,  4460,  4204,  3973,  3241,  2725,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
};

/* ToneMapping Lut: SDR to HDR10 */
static const HI_U16 u16ScaleCoefTM_SDR2HDR1000 = 15;         /* U4.0  [0,15] */
static const HI_U32 au32TMLut_SDR2HDR1000[PQ_TMAP_LUT_SIZE] =                   //U1.15 [0,65535]
{
    10820, 10820,  5410,  3743,  4522,  6551,  6799,  6947,
    6926,  6905,  6889,  6853,  6774,  6714,  6604,  6510,
    6474,  6434,  6354,  6285,  6236,  6201,  6175,  6092,
    6070,  6040,  6019,  6024,  6030,  6038,  6047,  6056,
    6064,  6093,  6105,  6131,  6159,  6248,  6370,  6475,
    6600,  6745,  6877,  7033,  7176,  7338,  7508,  7668,
    7855,  8037,  8212,  8418,  8610,  9475, 10474, 11620,
    12945, 14521, 16321, 18500, 21081, 24253, 28346, 32733,
};

/* ToneMapping Lut: BBC to HDR10 */
static const HI_U16 u16ScaleCoefTM_HLG2HDR = 15;           /* U4.0  [0,15] */
static const HI_U32 au32TMLut_HLG2HDR[PQ_TMAP_LUT_SIZE] =                /*U1.15 [0,65535] */
{
    /*PQ1250*/
    2853,  2853,  3277,  3554,  3764,  4324,  4689,  4967,
    5193,  5386,  5555,  5705,  6187,  6554,  7107,  7528,
    7872,  8164,  8648,  9042,  9378,  9672,  9933, 10773,
    11411, 11931, 12374, 12762, 13107, 13420, 13705, 13969,
    14214, 14444, 14659, 14863, 15056, 15743, 16328, 16839,
    17295, 17707, 18084, 18432, 18756, 19059, 19343, 19612,
    19867, 20109, 20340, 20562, 20774, 21545, 22220, 22821,
    23365, 23863, 24322, 24749, 25148, 25524, 25878, 26214,
};

// ToneMapping Lut:  SDR to HLG
static const HI_U16 u16ScaleCoefTM_SDR2HLG = 12 ;
static const HI_U32 au32TMLut_SDR2HLG[PQ_TMAP_LUT_SIZE] =                    //U9.7 [0,65535]
{
    10339 ,     10339 ,     10339 ,      5169 ,      3554 ,      4814 ,      4702 ,      4549 ,
    4354 ,      4208 ,      4105 ,      3991 ,      3685 ,      3488 ,      3207 ,      3021 ,
    2895 ,      2794 ,      2634 ,      2515 ,      2424 ,      2351 ,      2291 ,      2118 ,
    2012 ,      1931 ,      1867 ,      1821 ,      1783 ,      1750 ,      1721 ,      1696 ,
    1674 ,      1658 ,      1640 ,      1627 ,      1616 ,      1576 ,      1553 ,      1535 ,
    1525 ,      1523 ,      1521 ,      1525 ,      1529 ,      1537 ,      1547 ,      1556 ,
    1571 ,      1585 ,      1599 ,      1617 ,      1634 ,      1717 ,      1819 ,      1940 ,
    2081 ,      2250 ,      2441 ,      2671 ,      2939 ,      3262 ,      3672 ,      4096 ,
};

// ToneMapping Lut:  HDR10 to HLG
static const HI_U16 u16ScaleCoefTM_HDR2HLG = 8 ;
static const HI_U32 au32TMLut_HDR2HLG[PQ_TMAP_LUT_SIZE] =                  //U9.7 [0,65535]
{
    11074 ,     11074 ,      9866 ,      9221 ,      8790 ,      7831 ,      7319 ,      6976 ,
    6722 ,      6521 ,      6355 ,      6215 ,      5809 ,      5537 ,      5175 ,      4933 ,
    4753 ,      4611 ,      4395 ,      4234 ,      4108 ,      4004 ,      3915 ,      3660 ,
    3488 ,      3361 ,      3260 ,      3178 ,      3108 ,      3047 ,      2994 ,      2947 ,
    2905 ,      2866 ,      2831 ,      2799 ,      2769 ,      2668 ,      2588 ,      2341 ,
    2048 ,      1820 ,      1638 ,      1489 ,      1365 ,      1260 ,      1170 ,      1092 ,
    1024 ,       964 ,       910 ,       862 ,       819 ,       683 ,       585 ,       512 ,
    455 ,       410 ,       372 ,       341 ,       315 ,       293 ,       273 ,       256 ,
};


// ToneMapping Lut:  HLG2SDR
static const HI_U16 u16ScaleCoefTM_HLG2SDR = 12 ;
static const HI_U32 au32TMLut_HLG2SDR[PQ_TMAP_LUT_SIZE] =                    //U9.7 [0,65535]
{
    1982 ,      1982 ,      2276 ,      2467 ,      2613 ,      2995 ,      3242 ,      3427 ,
    3575 ,      3700 ,      3807 ,      3901 ,      4191 ,      4398 ,      4684 ,      4879 ,
    5023 ,      5135 ,      5304 ,      5429 ,      5528 ,      5611 ,      5683 ,      5907 ,
    6078 ,      6220 ,      6341 ,      6449 ,      6544 ,      6630 ,      6708 ,      6778 ,
    6843 ,      6902 ,      6956 ,      7006 ,      7052 ,      7202 ,      7310 ,      7385 ,
    7435 ,      7464 ,      7476 ,      7474 ,      7460 ,      7437 ,      7404 ,      7364 ,
    7318 ,      7266 ,      7210 ,      7150 ,      7086 ,      6807 ,      6505 ,      6195 ,
    5888 ,      5589 ,      5302 ,      5029 ,      4772 ,      4531 ,      4306 ,      4096 ,
};


/* ToneMapping Lut: AVS to HDR10 */
static const HI_U16 u16ScaleCoefTM_Linear = 8;             /* U4.0  [0,15] */
static const HI_U32 au32TMLut_Linear[PQ_TMAP_LUT_SIZE] =                 /* U8.8 [0,65535] */
{
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
    256,   256,   256,   256,   256,   256,   256,   256,
};

/******************* Gmm-8 Lut Params *************************/
static const HI_U32 au32GmmStep[PQ_GMM_SEG_SIZE] =        /* U5.0  [0,31] */
{
    4,  6,  8,  9,  10, 12, 14, 16
};

static const HI_U32 au32GmmPos[PQ_GMM_SEG_SIZE]  =        /* U20.0 [0,1048575] */
{
    64, 512,  1024, 3072,   8192,   65536,  327680, 1048575
};

static const HI_U32 au32GmmNum[PQ_GMM_SEG_SIZE]  =        /* U6.0  [0,63] */
{
    4,  11, 13, 17, 22, 36, 52, 63
};

// PQ Curve
static const HI_U32 au32GmmLut_PQ10000[64] =              //U12.0 [0,4095]
{
    0 ,          304 ,       400 ,       466 ,       517 ,       657 ,       749 ,       820 ,       878 ,       927 ,       970 ,      1008 ,      1129 ,      1220 ,      1354 ,      1454 ,
    1533 ,      1600 ,      1708 ,      1794 ,      1865 ,      1926 ,      1980 ,      2146 ,      2267 ,      2361 ,      2440 ,      2506 ,      2564 ,      2616 ,      2662 ,      2704 ,
    2742 ,      2777 ,      2810 ,      2841 ,      2869 ,      2969 ,      3050 ,      3119 ,      3178 ,      3231 ,      3278 ,      3321 ,      3360 ,      3395 ,      3428 ,      3459 ,
    3488 ,      3515 ,      3540 ,      3564 ,      3587 ,      3668 ,      3736 ,      3794 ,      3846 ,      3892 ,      3933 ,      3971 ,      4006 ,      4038 ,      4067 ,      4095 ,
} ;

static const HI_U32 au32GmmLut_PQ4000[64] =              //U12.0 [0,4095]
{
    0 ,         206 ,       278 ,       327 ,       367 ,       477 ,       551 ,       609 ,       657 ,       697 ,       733 ,       765 ,       867 ,       945 ,      1061 ,      1149 ,
    1220 ,      1279 ,      1376 ,      1454 ,      1519 ,      1575 ,      1624 ,      1778 ,      1891 ,      1980 ,      2054 ,      2118 ,      2173 ,      2222 ,      2267 ,      2307 ,
    2344 ,      2378 ,      2410 ,      2440 ,      2467 ,      2564 ,      2644 ,      2712 ,      2771 ,      2823 ,      2869 ,      2912 ,      2950 ,      2986 ,      3019 ,      3050 ,
    3079 ,      3106 ,      3131 ,      3155 ,      3178 ,      3260 ,      3329 ,      3388 ,      3441 ,      3488 ,      3530 ,      3569 ,      3604 ,      3637 ,      3668 ,      3696 ,
} ;

static const HI_U32 au32GmmLut_PQ1600[64] =              //U12.0 [0,4095]
{
    0,       136,      187,     223,     253,     336,     394,     439,
    477,     509,      538,     564,     648,     712,     810,     884,
    945,     996,     1081,    1149,    1207,    1256,    1300,    1439,
    1542,    1624,    1692,    1751,    1803,    1849,    1891,    1929,
    1964,    1996,    2026,    2054,    2081,    2173,    2249,    2315,
    2372,    2422,    2467,    2509,    2547,    2581,    2614,    2644,
    2672,    2699,    2724,    2748,    2771,    2851,    2920,    2979,
    3032,    3079,    3121,    3160,    3196,    3229,    3260,    3289,
};

static const HI_U32 au32GmmLut_PQ2000[64] =              //U12.0 [0,4095]
{
    0 ,       151 ,       206 ,       246 ,       278 ,       367 ,       429 ,       477 ,       517 ,       551 ,       582 ,       609 ,       697 ,       765 ,       867 ,       945 ,
    1008 ,      1061 ,      1149 ,      1220 ,      1279 ,      1331 ,      1376 ,      1519 ,      1624 ,      1708 ,      1778 ,      1838 ,      1891 ,      1938 ,      1980 ,      2019 ,
    2054 ,      2087 ,      2118 ,      2146 ,      2173 ,      2267 ,      2344 ,      2410 ,      2467 ,      2518 ,      2564 ,      2606 ,      2644 ,      2679 ,      2712 ,      2742 ,
    2771 ,      2797 ,      2823 ,      2847 ,      2869 ,      2950 ,      3019 ,      3079 ,      3131 ,      3178 ,      3221 ,      3260 ,      3296 ,      3329 ,      3360 ,      3388 ,
} ;

static const HI_U32 au32GmmLut_PQ1250[64] =              //U12.0 [0,4095]
{
    0 ,       121 ,       167 ,       201 ,       227 ,       304 ,       358 ,       400 ,       435 ,       466 ,       493 ,       517 ,       596 ,       657 ,       749 ,       820 ,
    878 ,       927 ,      1008 ,      1074 ,      1129 ,      1177 ,      1220 ,      1354 ,      1454 ,      1533 ,      1600 ,      1657 ,      1708 ,      1753 ,      1794 ,      1831 ,
    1865 ,      1897 ,      1926 ,      1954 ,      1980 ,      2071 ,      2146 ,      2210 ,      2267 ,      2317 ,      2361 ,      2402 ,      2440 ,      2474 ,      2506 ,      2536 ,
    2564 ,      2591 ,      2616 ,      2639 ,      2662 ,      2742 ,      2810 ,      2869 ,      2922 ,      2969 ,      3011 ,      3050 ,      3086 ,      3119 ,      3150 ,      3178 ,
} ;

static const HI_U32 au32GmmLut_PQ1200[64] =              //U12.0 [0,4095]
{
    0 ,       118 ,       164 ,       197 ,       223 ,       299 ,       352 ,       394 ,       429 ,       459 ,       485 ,       509 ,       587 ,       648 ,       740 ,       810 ,
    867 ,       916 ,       996 ,      1061 ,      1116 ,      1164 ,      1207 ,      1340 ,      1439 ,      1519 ,      1585 ,      1642 ,      1692 ,      1737 ,      1778 ,      1815 ,
    1849 ,      1881 ,      1910 ,      1938 ,      1964 ,      2054 ,      2129 ,      2193 ,      2249 ,      2299 ,      2344 ,      2385 ,      2422 ,      2457 ,      2489 ,      2518 ,
    2547 ,      2573 ,      2598 ,      2622 ,      2644 ,      2724 ,      2792 ,      2851 ,      2904 ,      2950 ,      2993 ,      3032 ,      3067 ,      3101 ,      3131 ,      3160 ,
} ;

static const HI_U32 au32GmmLut_PQ1000[64] =              //U12.0 [0,4095]
{
    0 ,       108 ,       151 ,       181 ,       206 ,       278 ,       327 ,       367 ,       400 ,       429 ,       454 ,       477 ,       551 ,       609 ,       697 ,       765 ,
    820 ,       867 ,       945 ,      1008 ,      1061 ,      1108 ,      1149 ,      1279 ,      1376 ,      1454 ,      1519 ,      1575 ,      1624 ,      1668 ,      1708 ,      1744 ,
    1778 ,      1809 ,      1838 ,      1865 ,      1891 ,      1980 ,      2054 ,      2118 ,      2173 ,      2222 ,      2267 ,      2307 ,      2344 ,      2378 ,      2410 ,      2440 ,
    2467 ,      2494 ,      2518 ,      2542 ,      2564 ,      2644 ,      2712 ,      2771 ,      2823 ,      2869 ,      2912 ,      2950 ,      2986 ,      3019 ,      3050 ,      3079 ,
} ;

//HLG Curve
static const HI_U32 au32GmmLut_HLG[64] =              //U12.0 [0,4095]
{
    0 ,        28 ,        39 ,        48 ,        55 ,        78 ,        96 ,       111 ,       124 ,       136 ,       147 ,       157 ,       192 ,       222 ,       271 ,       313 ,
    350 ,       384 ,       443 ,       496 ,       543 ,       586 ,       627 ,       768 ,       887 ,       991 ,      1086 ,      1173 ,      1254 ,      1330 ,      1402 ,      1470 ,
    1536 ,      1598 ,      1659 ,      1717 ,      1773 ,      1982 ,      2165 ,      2313 ,      2436 ,      2541 ,      2633 ,      2714 ,      2788 ,      2854 ,      2916 ,      2972 ,
    3024 ,      3073 ,      3119 ,      3162 ,      3203 ,      3346 ,      3466 ,      3569 ,      3660 ,      3740 ,      3812 ,      3878 ,      3939 ,      3995 ,      4047 ,      4095
};

// Gamma Curve
static const HI_U32 au32GmmLut_22[64] =              //U12.0 [0,4095]
{
    0 ,        26 ,        36 ,        44 ,        50 ,        68 ,        82 ,        93 ,       103 ,       112 ,       120 ,       128 ,       154 ,       175 ,       211 ,       240 ,
    266 ,       289 ,       329 ,       364 ,       396 ,       425 ,       451 ,       543 ,       618 ,       684 ,       744 ,       798 ,       847 ,       894 ,       938 ,       979 ,
    1019 ,      1057 ,      1093 ,      1128 ,      1161 ,      1285 ,      1396 ,      1498 ,      1591 ,      1679 ,      1761 ,      1839 ,      1913 ,      1984 ,      2052 ,      2118 ,
    2181 ,      2242 ,      2301 ,      2358 ,      2413 ,      2622 ,      2812 ,      2988 ,      3153 ,      3307 ,      3454 ,      3593 ,      3726 ,      3854 ,      3977 ,      4095
};

static const HI_U32 au32GmmLut_24[64] =              //U12.0 [0,4095]
{
    0 ,        40 ,        54 ,        64 ,        72 ,        96 ,       114 ,       128 ,       140 ,       152 ,       162 ,       171 ,       202 ,       228 ,       270 ,       304 ,
    334 ,       360 ,       406 ,       446 ,       481 ,       513 ,       542 ,       642 ,       724 ,       794 ,       857 ,       914 ,       966 ,      1015 ,      1060 ,      1103 ,
    1144 ,      1183 ,      1220 ,      1256 ,      1290 ,      1416 ,      1527 ,      1629 ,      1722 ,      1808 ,      1889 ,      1966 ,      2039 ,      2108 ,      2174 ,      2237 ,
    2298 ,      2357 ,      2414 ,      2469 ,      2522 ,      2721 ,      2902 ,      3068 ,      3222 ,      3367 ,      3503 ,      3632 ,      3756 ,      3873 ,      3986 ,      4095 ,
};

static const HI_U32 au32GmmLut_bt709[64] =              //U12.0 [0,4095]
{
    0 ,         0 ,         1 ,         1 ,         1 ,         2 ,         3 ,         4 ,         6 ,         7 ,         8 ,         9 ,        13 ,        18 ,        27 ,        36 ,
    45 ,        54 ,        72 ,        90 ,       108 ,       126 ,       144 ,       216 ,       288 ,       360 ,       426 ,       486 ,       541 ,       592 ,       641 ,       686 ,
    730 ,       772 ,       812 ,       850 ,       887 ,      1024 ,      1146 ,      1257 ,      1360 ,      1456 ,      1547 ,      1632 ,      1713 ,      1791 ,      1866 ,      1937 ,
    2006 ,      2073 ,      2138 ,      2200 ,      2261 ,      2489 ,      2697 ,      2889 ,      3068 ,      3237 ,      3397 ,      3549 ,      3694 ,      3833 ,      3966 ,      4095 ,
};

/* RGB to YUV Params */
/* --------------R2Y:RGB2YUV-------------------------------- */

static const HI_U16 u16ScaleR2Y      = 14;                      /* U4.0  [0,15] */
static const HI_U16 u16ClipMinRF2YL    = 64;                      /* U10.0  [0,1023] */
static const HI_U16 u16ClipMaxRF2YL    = 1023;                     /* U10.0  [0,1023] */
static const HI_U16 u16ClipMinRF2YF    = 0;                      /* U10.0  [0,1023] */
static const HI_U16 u16ClipMaxRF2YF    = 1023;                     /* U10.0  [0,1023] */

static const HI_S16 as16DcInRF2YL[3] =                            /* S10.0  [-1024, 1023] */
{
    0,
    0,
    0
};

static const  HI_S16 as16DcInRF2YF[3] =      // S10.0  [-1024, 1023]
{
    0,
    0,
    0
};

static HI_S16 as16M33RF2YL_709[3][3] =      // S1.14 [-32768, 32767]
{
    //BT709
    {2984  ,     10034   ,     1013  },
    { -1643 ,      -5531  ,      7175 },
    {7175  ,     -6518   ,     -659  }
};

static const HI_S16 as16M33RF2YL_2020NCL[3][3] =      // S1.14 [-32768, 32767]
{
    //BT2020
    {3685  ,      9512  ,       832  },
    { -2004 ,      -5171 ,       7175 },
    {7175  ,     -6598  ,      -577  }
};

static const HI_S16 as16M33RF2YL_601[3][3] =      // S1.14 [-32768, 32767]
{
    //BT601
    {4195    ,    8235   ,     1599  },
    { -2421 ,      -4754  ,      7175 },
    {7175   ,    -6004    ,   -1167  }
};

static const HI_S16  as16M33RF2YF_709[3][3] =      // S1.14 [-32768, 32767]
{
    //BT709
    {3483    ,   11718     ,   1183  },
    { -1877  ,     -6315   ,     8192 },
    { 8192   ,    -7441    ,    -751  }
};

static const HI_S16  as16M33RF2YF_2020NCL[3][3] =      // S1.14 [-32768, 32767]
{
    //BT2020
    { 4304   ,    11108    ,     972  },
    { -2288   ,    -5904   ,     8192 },
    {8192     ,  -7533     ,   -659  }
};

static const HI_S16 as16M33RF2YF_601[3][3] =      // S1.14 [-32768, 32767]
{
    //BT601
    {4899    ,    9617     ,   1868 },
    { -2765   ,    -5427    ,    8192 },
    { 8192   ,    -6855    ,   -1332 }
};

static const HI_S16 as16DcOutRF2YL[3]  =       /* s10.0  [-1024,1023] */
{
    64,
    512,
    512
};

static const HI_S16 as16DcOutRF2YF[3] =
{
    0,
    512,
    512
};  // s10.0  [-1024,1023]

/* ------------------R2Y:RGB2RGB---------------------------- */
static const HI_U16  u16ScaleRF2RF   = 14;   // U4.0  [0,15]
static const HI_U16  u16ClipMinRF2RF = 0;    // U10.0  [0,1023]
static const HI_U16  u16ClipMaxRF2RF = 1023; // U10.0  [0,1023]

static const HI_S16   as16DcInRF2RF[3] =      // S10.0  [-1024, 1023]
{
    0,
    0,
    0
};

static const HI_S16   as16M33RF2RF[3][3] =      // S1.14 [-32768, 32767]
{
    {16384    ,   0     ,   0  },
    { 0  ,     16384   ,     0 },
    { 0   ,    0    ,    16384  }
};

static const HI_S16   as16DcOutRF2RF[3] =
{
    0,
    0,
    0
};  // s10.0  [-1024,1023]

static HI_PQ_ACC_HISTGRAM_S gs_stACCHistGram;
static HI_U32 g_au32ToolTmClutTmp[64] = {0};

static HI_PQ_HDR_TMAP_S g_stToolHdrTmap = {{0}};
static HI_PQ_HDR_SMAP_S g_stToolHdrSmap = {{0}};

static HI_U32 g_u32ACCOutWidth  = 3840;
static HI_U32 g_u32ACCOutHeight = 2160;
static HI_U32 g_u32HdrMode[HI_PQ_HDR_MODE_BUTT] =
{
    0,    0,    0,
    0,    0,    0,
    0,    0,    0,
    0,    0,    0
};
static HI_U32 g_u32ACCDarkStr[HI_PQ_HDR_MODE_BUTT] =
{
    0,    0,    0,
    0,    0,    0,
    0,    0,    0,
    0,    0,    0
};
static HI_U32 g_u32ACCBrightStr[HI_PQ_HDR_MODE_BUTT] =
{
    0,    0,    0,
    0,    0,    0,
    0,    0,    0,
    0,    0,    0
};
static HI_U32 g_u32DarkCvStr[HI_PQ_HDR_MODE_BUTT]    =
{
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
};
static HI_U32 g_u32BrightCvStr[HI_PQ_HDR_MODE_BUTT]  =
{
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
};

static HI_U32 g_u32Bright   = 128;
static HI_U32 g_u32Contrast = 128;
static HI_U32 g_u32Satu     = 128;
static HI_U32 g_u32Hue      = 128;

static HI_U32 g_u32Red      = 128;
static HI_U32 g_u32Green    = 128;
static HI_U32 g_u32Blue     = 128;

static HI_U32 g_u32HdrOffsetBright[HI_PQ_HDR_MODE_BUTT]   =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetContrast[HI_PQ_HDR_MODE_BUTT] =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetSatu[HI_PQ_HDR_MODE_BUTT]     =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetHue[HI_PQ_HDR_MODE_BUTT]      =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetRed[HI_PQ_HDR_MODE_BUTT]      =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetGreen[HI_PQ_HDR_MODE_BUTT]    =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetBlue[HI_PQ_HDR_MODE_BUTT]     =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};

#if defined(PQ_SIZE_UNUSED_CODE)
static HI_U32 au32TMLut_HDR2SDR_Vivid[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    0,  5000,  7000,  9000, 10568, 10091,  9768,  9531,
    9348,  9200,  9078,  8974,  8675,  8478,  8220,  8045,
    7912,  7801,  7619,  7467,  7332,  7209,  7093,  6680,
    6317,  5988,  5686,  5407,  5149,  4909,  4685,  4477,
    4282,  4099,  3929,  3769,  3619,  3104,  2698,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
    2560,  2560,  2560,  2560,  2560,  2560,  2560,  2560,
};

static const HI_U32 au32DeGmmLut_BT709[64] =                             //U20.0 [0,1048575]
{
    0 ,      1820 ,      3641 ,      5461 ,      7282 ,      9102 ,     10923 ,     12743 ,     14564 ,     16384 ,     18204 ,     19983 ,     21907 ,     23930 ,     26051 ,     28271 ,
    30591 ,     33013 ,     35537 ,     38163 ,     40892 ,     43726 ,     46664 ,     49707 ,     52857 ,     56114 ,     59478 ,     66530 ,     74019 ,     81950 ,     90327 ,     99155 ,
    108437 ,    118178 ,    128382 ,    139053 ,    150193 ,    161808 ,    173901 ,    186474 ,    199532 ,    213077 ,    227114 ,    241644 ,    256671 ,    272199 ,    288230 ,    304766 ,
    321811 ,    339368 ,    357439 ,    376027 ,    395135 ,    414764 ,    455600 ,    498555 ,    543647 ,    590895 ,    640318 ,    691933 ,    745756 ,    801805 ,    920645 ,   1048575
};
#endif

HI_S32 PQ_HAL_SetHDRTMCurve(HI_PQ_SETHDROFFSET_S *pstHdrOffsetPara)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrOffsetPara);

    g_u32HdrMode[pstHdrOffsetPara->enHdrProcessScene]        = pstHdrOffsetPara->u32HdrMode;
    g_u32ACCDarkStr[pstHdrOffsetPara->enHdrProcessScene]     = pstHdrOffsetPara->u32ACCdark;
    g_u32ACCBrightStr[pstHdrOffsetPara->enHdrProcessScene]   = pstHdrOffsetPara->u32ACCbrigt;
    g_u32DarkCvStr[pstHdrOffsetPara->enHdrProcessScene]      = pstHdrOffsetPara->u32darkCv;
    g_u32BrightCvStr[pstHdrOffsetPara->enHdrProcessScene]    = pstHdrOffsetPara->u32brightCv;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_SetHdrCscSetting(HI_PQ_PICTURE_SETTING_S *pstPicSetting)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstPicSetting);

    g_u32Bright   = (HI_U32)pstPicSetting->u16Brightness;
    g_u32Contrast = (HI_U32)pstPicSetting->u16Contrast;
    g_u32Satu     = (HI_U32)pstPicSetting->u16Hue;
    g_u32Hue      = (HI_U32)pstPicSetting->u16Saturation;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_SetHdrOffset(HI_PQ_SETHDROFFSET_S *pstHdrOffsetPara)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrOffsetPara);

    g_u32HdrOffsetBright[pstHdrOffsetPara->enHdrProcessScene]   = pstHdrOffsetPara->u32Bright;
    g_u32HdrOffsetContrast[pstHdrOffsetPara->enHdrProcessScene] = pstHdrOffsetPara->u32Contrast;
    g_u32HdrOffsetSatu[pstHdrOffsetPara->enHdrProcessScene]     = pstHdrOffsetPara->u32Satu;
    g_u32HdrOffsetHue[pstHdrOffsetPara->enHdrProcessScene]      = pstHdrOffsetPara->u32Hue;
    g_u32HdrOffsetRed[pstHdrOffsetPara->enHdrProcessScene]      = pstHdrOffsetPara->u32R;
    g_u32HdrOffsetGreen[pstHdrOffsetPara->enHdrProcessScene]    = pstHdrOffsetPara->u32G;
    g_u32HdrOffsetBlue[pstHdrOffsetPara->enHdrProcessScene]     = pstHdrOffsetPara->u32B;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_SetHDRACCHistGram(HI_U32 u32ACCOutWidth, HI_U32 u32ACCOutHeight, HI_PQ_ACC_HISTGRAM_S *pstACCHistGram)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstACCHistGram);

    g_u32ACCOutWidth  = u32ACCOutWidth;
    g_u32ACCOutHeight = u32ACCOutHeight;

    memcpy(&gs_stACCHistGram, pstACCHistGram, sizeof(gs_stACCHistGram));

    return HI_SUCCESS;
}

HI_S32 HiHDR_DynTM(HI_PQ_ACC_HISTGRAM_S *pstACCHistGram, HI_U32 *TMLut, HI_U32 u32ACCOutWidth, HI_U32 u32ACCOutHeight)
{
    int i;// j;
    HI_S64 Tmp;
    HI_S64 TMLutTmp;
    HI_U32 u32Width  = u32ACCOutWidth;
    HI_U32 u32Height = u32ACCOutHeight;
    HI_U32 SumPixel  = (HI_U32)(u32Width * u32Height);
    HI_U32 Hist[8]   =  {0};  //ACC 8段直方图CV=[127,255,383,511,639,767,895,1023]  Lum=[0.15,3,22,103,419,1608,6215,10000] nits
    HI_U32 HistD3[3] = {0}; //ACC 三段动态直方图 CV=[0~P1, P0~P3, P2~1023]
    HI_U32 HistD5[5] = {0}; // 5段计算直方图，用于亮场景判别，CV=[0~P0, P0~P1, P1~P2, P2~P3, P3~1023]
    HI_U16 NormRange = 1000;
    HI_U16 HistNorm[8]      = {0};
    HI_U16 HistD5Norm[5]    = {0};
    HI_S16 LightLvlCoef[8]  = { -4, -2, -1, 0, 1, 2, 5, 1};
    HI_S32 LightLvlEst = 0;
    HI_U16 AlphaDarkGain   = g_u32ACCDarkStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] * 1024 / 50;
    HI_U16 AlphaBrightGain = g_u32ACCBrightStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] * 1024 / 50;
    HI_U16 AlphaGainScale  = 10;
    HI_U16 AlphaScale  = 15;
    HI_S32 AlphaDark   = 0;
    HI_S32 AlphaBright = 0;

    memcpy(HistD3,  pstACCHistGram->u32HistGram0, sizeof(HistD3));
    memcpy(Hist,    pstACCHistGram->u32HistGram1, sizeof(Hist));

    HistD5[0] = Hist[0] + Hist[1] + Hist[2] + Hist[3] + Hist[4];    //CV = 0~P0;
    HistD5[1] = HistD3[0] - HistD5[0];                              //CV = P0~P1;
    HistD5[2] = SumPixel - HistD3[0] - HistD3[2];                   //CV = P1~P2;
    HistD5[3] = HistD3[1] - HistD5[1] - HistD5[2];                  //CV = P2~P3;
    HistD5[4] = HistD3[2] - HistD5[3];                              //CV = P3~1023;

    PQ_CHECK_ZERO_RE_FAIL(SumPixel);

    for (i = 0; i < 8; i++)
    {
        HistNorm[i] = (HI_U16)(div64_s64(((HI_U64)Hist[i] * NormRange), SumPixel));
    }

    for (i = 0; i < 5; i++)
    {
        HistD5Norm[i] = (HI_U16)(div64_s64(((HI_U64)HistD5[i] * NormRange), SumPixel));
    }

    LightLvlEst = 0;
    HistNorm[0] = HDR_MAX(HistNorm[0] - 256, 0); //预处理减黑边；

    for (i = 0; i < 8; i++)
    {
        LightLvlEst += LightLvlCoef[i] * HistNorm[i];
    }

    pqprint(PQ_PRN_HDR, "Hist:%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d\n",
            Hist[0], Hist[1], Hist[2], Hist[3], Hist[4], Hist[5], Hist[6], Hist[7], HistD3[0], HistD3[1], HistD3[2]);

    if (LightLvlEst <= -200)        //暗场景保护
    {
        pqprint(PQ_PRN_HDR, "LightLvlEstB:%d\n", LightLvlEst);

        if (LightLvlEst > -600)
        {
            AlphaDark = (HI_S32)(((abs(LightLvlEst) - 200) * 600 / (600 - 200) ) << AlphaScale) / 1500;
        }
        else
        {
            AlphaDark = (HI_S32)((abs(LightLvlEst)) << AlphaScale) / 1500;
        }

        pqprint(PQ_PRN_HDR, "AlphaD0:%d\n", AlphaDark);

        AlphaDark = HDR_CLIP3(0, (3 << AlphaScale) / 2, AlphaDark);

        pqprint(PQ_PRN_HDR, "AlphaD1:%d\n", AlphaDark);
        pqprint(PQ_PRN_HDR, "AlphaDarkGain:%d\n", AlphaDarkGain);

        AlphaDark = (HI_S32)(((HI_S64)AlphaDark * AlphaDarkGain) >> AlphaGainScale);
        Tmp = (1 << AlphaScale) - AlphaDark;

        pqprint(PQ_PRN_HDR, "Tmp,AlphaD:%d,%d\n", (HI_S32)Tmp, AlphaDark);

        for (i = 0; i < 64; i++)
        {
            TMLutTmp = ((HI_S64)Tmp * TMLut[i] + (HI_S64)AlphaDark * au32TMLut_HDR2SDR_DP[i]) >> AlphaScale;
            TMLut[i] = (HI_U32)HDR_CLIP3(0, 65535, TMLutTmp);
        }
    }
    else if (LightLvlEst >= 100)
    {
        pqprint(PQ_PRN_HDR, "LightLvlEstB:%d\n", LightLvlEst);

        if (LightLvlEst < 300)
        {
            AlphaBright = (HI_S32)(((abs(LightLvlEst) - 100) * 300 / (300 - 100) ) << AlphaScale) / 500;
        }
        else
        {
            AlphaBright = (HI_S32)((abs(LightLvlEst)) << AlphaScale) / 500;
        }

        pqprint(PQ_PRN_HDR, "AlphaB0:%d\n", AlphaBright);

        AlphaBright = HDR_CLIP3(0, (3 << AlphaScale) / 2, AlphaBright);

        pqprint(PQ_PRN_HDR, "AlphaB1:%d\n", AlphaBright);
        pqprint(PQ_PRN_HDR, "AlphaBrightGain:%d\n", AlphaBrightGain);

        AlphaBright = (HI_S32)(((HI_S64)AlphaBright * AlphaBrightGain) >> AlphaGainScale);
        Tmp = (1 << AlphaScale) - AlphaBright;

        pqprint(PQ_PRN_HDR, "Tmp,AlphaB:%d,%d\n", (HI_S32)Tmp, AlphaBright);

        for (i = 0; i < 64; i++)
        {
            TMLutTmp = ((HI_S64)Tmp * TMLut[i] + (HI_S64)AlphaBright * au32TMLut_HDR2SDR_BP[i]) >> AlphaScale;
            TMLut[i] = (HI_U32)HDR_CLIP3(0, 65535, TMLutTmp);
        }
    }
    else
    {
    }

    return HI_SUCCESS;
}

static HI_VOID PQ_hal_CalCSCCoefRGBtoYCbCr(HI_U32 Contrast, HI_U32 Saturation, HI_U32 Hue,
        HI_U32 Kr, HI_U32 Kg, HI_U32 Kb, HI_S16 pCSCTable[3][3], HI_S16 pDstCSCTable[3][3])
{
    HI_S32 ContrastAdjust;
    HI_S32 SaturationAdjust;
    HI_S32 rGain, gGain, bGain;

    ContrastAdjust   = Contrast   * 40 / 51;
    SaturationAdjust = Saturation * 40 / 51;
    Hue   = Hue * 60 / 255;
    rGain = Kr  * 40 / 51;
    gGain = Kg  * 40 / 51;
    bGain = Kb  * 40 / 51;

    g_aDstCSCTable[0][0] = (HI_S16)((HI_S32)pCSCTable[0][0] * ContrastAdjust * rGain  / 10000);
    g_aDstCSCTable[0][1] = (HI_S16)((HI_S32)pCSCTable[0][1] * ContrastAdjust * gGain  / 10000);
    g_aDstCSCTable[0][2] = (HI_S16)((HI_S32)pCSCTable[0][2] * ContrastAdjust * bGain  / 10000);
    g_aDstCSCTable[1][0]  = (HI_S16)(((HI_S32)(pCSCTable[1][0] * g_au32CosTable[Hue]) / 1000
                                      + (HI_S32)(pCSCTable[2][0] * g_au32SinTable[Hue]) / 1000)
                                     * SaturationAdjust * rGain / 10000);
    g_aDstCSCTable[1][1]  = (HI_S16)(((HI_S32)(pCSCTable[1][1] * g_au32CosTable[Hue]) / 1000
                                      + (HI_S32)(pCSCTable[2][1] * g_au32SinTable[Hue]) / 1000)
                                     * SaturationAdjust * gGain  / 10000);
    g_aDstCSCTable[1][2]  = (HI_S16)(((HI_S32)(pCSCTable[1][2] * g_au32CosTable[Hue]) / 1000
                                      + (HI_S32)(pCSCTable[2][2] * g_au32SinTable[Hue]) / 1000)
                                     * SaturationAdjust * bGain  / 10000);
    g_aDstCSCTable[2][0] = (HI_S16)(((HI_S32)(pCSCTable[2][0] * g_au32CosTable[Hue]) / 1000
                                     - (HI_S32)(pCSCTable[1][0] * g_au32SinTable[Hue]) / 1000)
                                    * SaturationAdjust * rGain  / 10000);
    g_aDstCSCTable[2][1] = (HI_S16)(((HI_S32)(pCSCTable[2][1] * g_au32CosTable[Hue]) / 1000
                                     - (HI_S32)(pCSCTable[1][1] * g_au32SinTable[Hue]) / 1000)
                                    * SaturationAdjust * gGain  / 10000);
    g_aDstCSCTable[2][2] = (HI_S16)(((HI_S32)(pCSCTable[2][2] * g_au32CosTable[Hue]) / 1000
                                     - (HI_S32)(pCSCTable[1][2] * g_au32SinTable[Hue]) / 1000)
                                    * SaturationAdjust * bGain  / 10000);
    return;
}

static HI_VOID PQ_hal_HdrOffsetCalCSCCoefRGBtoYCbCr(HI_PQ_HDR_MODE_E enHdrProcessScene, HI_U32 Contrast, HI_U32 Saturation,
        HI_U32 Hue, HI_U32 Kr, HI_U32 Kg, HI_U32 Kb, HI_S16 pCSCTable[3][3], HI_S16 pDstCSCTable[3][3])
{
    HI_S32 ContrastAdjust;
    HI_S32 SaturationAdjust;
    HI_S32 rGain, gGain, bGain;

    ContrastAdjust   = Contrast   * 40 / 51;
    SaturationAdjust = Saturation * 40 / 51;
    Hue   = Hue * 60 / 255;
    rGain = Kr  * 40 / 51;
    gGain = Kg  * 40 / 51;
    bGain = Kb  * 40 / 51;

    g_aDstHdrOffsetCSCTable[enHdrProcessScene][0][0] = (HI_S16)((HI_S32)pCSCTable[0][0] * ContrastAdjust * rGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][0][1] = (HI_S16)((HI_S32)pCSCTable[0][1] * ContrastAdjust * gGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][0][2] = (HI_S16)((HI_S32)pCSCTable[0][2] * ContrastAdjust * bGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][1][0]  = (HI_S16)(((HI_S32)(pCSCTable[1][0] * g_au32CosTable[Hue]) / 1000
            + (HI_S32)(pCSCTable[2][0] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * rGain / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][1][1]  = (HI_S16)(((HI_S32)(pCSCTable[1][1] * g_au32CosTable[Hue]) / 1000
            + (HI_S32)(pCSCTable[2][1] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * gGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][1][2]  = (HI_S16)(((HI_S32)(pCSCTable[1][2] * g_au32CosTable[Hue]) / 1000
            + (HI_S32)(pCSCTable[2][2] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * bGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][2][0] = (HI_S16)(((HI_S32)(pCSCTable[2][0] * g_au32CosTable[Hue]) / 1000
            - (HI_S32)(pCSCTable[1][0] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * rGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][2][1] = (HI_S16)(((HI_S32)(pCSCTable[2][1] * g_au32CosTable[Hue]) / 1000
            - (HI_S32)(pCSCTable[1][1] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * gGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][2][2] = (HI_S16)(((HI_S32)(pCSCTable[2][2] * g_au32CosTable[Hue]) / 1000
            - (HI_S32)(pCSCTable[1][2] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * bGain  / 10000);
    return;
}


HI_S32 PQ_HAL_CalcHdrTmapACCHistGram(HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstPqHdrCfg);

    HiHDR_DynTM(&gs_stACCHistGram, pstPqHdrCfg->stTMAP.pu32LUTTM, g_u32ACCOutWidth, g_u32ACCOutHeight);

    return HI_SUCCESS;
}

/* sdr2hdr soft alg*/
HI_U32 HiHDR_LutCal(HI_U32 *lut, HI_U32 u32Base, HI_U32 u32Step, HI_U32 u32IndexBase, HI_U32 u32InMax, HI_U32 u32InData)
{
    HI_U32 u32IndexOff, u32Index;
    HI_U32 u32y0, u32y1, u32y;

    u32IndexOff = abs(u32InData - u32Base) >> u32Step;
    u32Index = u32IndexOff + u32IndexBase;
    PQ_CHECK_OVER_RANGE_RE_FAIL(u32Index + 1, 256);

    u32y0 = lut[u32Index];
    u32y1 = lut[u32Index + 1];

    if (u32InData <= u32InMax)
    {
        u32y = (HI_U32)(((((HI_S64)u32y1 - (HI_S64)u32y0) * ((HI_S64)u32InData - (HI_S64)(u32IndexOff * (1 << u32Step) + u32Base))) >> u32Step) + u32y0);
    }
    else
    {
        u32y = u32y0;
    }

    return u32y;
}

HI_U32 HiHDR_TF_8(HI_U32 u32InData, PQ_HDR_TF_PARA *pGmmPara)
{
    HI_U32 u32Base, u32Step, u32IndexBase;
    if (u32InData <= pGmmPara->x_pos[0])
    {
        u32Base = 0;
        u32Step = pGmmPara->x_step[0];
        u32IndexBase = 0;
    }
    else if (u32InData <= pGmmPara->x_pos[1])
    {
        u32Base = pGmmPara->x_pos[0];
        u32Step = pGmmPara->x_step[1];
        u32IndexBase = pGmmPara->x_num[0];
    }
    else if (u32InData <= pGmmPara->x_pos[2])
    {
        u32Base = pGmmPara->x_pos[1];
        u32Step = pGmmPara->x_step[2];
        u32IndexBase = pGmmPara->x_num[1];
    }
    else if (u32InData <= pGmmPara->x_pos[3])
    {
        u32Base = pGmmPara->x_pos[2];
        u32Step = pGmmPara->x_step[3];
        u32IndexBase = pGmmPara->x_num[2];
    }
    else if (u32InData <= pGmmPara->x_pos[4])
    {
        u32Base = pGmmPara->x_pos[3];
        u32Step = pGmmPara->x_step[4];
        u32IndexBase = pGmmPara->x_num[3];
    }
    else if (u32InData <= pGmmPara->x_pos[5])
    {
        u32Base = pGmmPara->x_pos[4];
        u32Step = pGmmPara->x_step[5];
        u32IndexBase = pGmmPara->x_num[4];
    }
    else if (u32InData <= pGmmPara->x_pos[6])
    {
        u32Base = pGmmPara->x_pos[5];
        u32Step = pGmmPara->x_step[6];
        u32IndexBase = pGmmPara->x_num[5];
    }
    else
    {
        u32Base = pGmmPara->x_pos[6];
        u32Step = pGmmPara->x_step[7];
        u32IndexBase = pGmmPara->x_num[6];
    }

    return HiHDR_LutCal(pGmmPara->lut, u32Base, u32Step, u32IndexBase, pGmmPara->x_pos[7], u32InData);
}

HI_S32 pq_hal_AdjustBasicTMCore(PQ_HDR_TF_PARA *pstTMParaBasic, PQ_HDR_TF_PARA *pstTMPara,
                                HI_U16 u16ScaleCoefTM, HI_U32 u32Ratio, HI_U32 u32PeakLuminance, HI_U32 *pu32OutputLut)
{
    HI_U32 i = 0, k = 0;
    static HI_S32 as32OriginalLutPos[64] = { 0 };
    static HI_S32 as32NewLut[64] = { 0 };
    HI_U32 u32TmpNum = 0;
    HI_S32 s32TmpPos = 0;
    HI_U16 u16RatioScale = 9;
    HI_U16 u16BitDepthIn = 20;
    HI_S32 as32NewLutMax;
    HI_S32 s32Input;
    HI_S64 s64Tmp;
    HI_U32 u32ScaleTMFactor = (1 << u16ScaleCoefTM) - 1;
    HI_U32 u32halfScaleRatio = (1 << (u16RatioScale - 1));

    u32Ratio = 205 + 307 * u32Ratio / 100;
    u32Ratio = HDR_CLIP3(0, 512, u32Ratio);
    u32PeakLuminance = 900 + u32PeakLuminance * 7;
    u32PeakLuminance = HDR_CLIP3(500, PQ_MAX_LUMINANCE, u32PeakLuminance);
    as32OriginalLutPos[0] = 1;

    for (i = 1; i < 63; ++i)
    {
        u32TmpNum = i;
        if (u32TmpNum <= pstTMPara->x_num[0])
        {
            s32TmpPos = (1 << pstTMPara->x_step[0]) * u32TmpNum + 1;
        }
        else
        {
            for (k = 1; k < 8; ++k)
            {
                if (u32TmpNum <= pstTMPara->x_num[k])
                {
                    s32TmpPos = pstTMPara->x_pos[k - 1] + (1 << pstTMPara->x_step[k]) * (u32TmpNum - pstTMPara->x_num[k - 1]) + 1;
                    break;
                }
            }
        }
        as32OriginalLutPos[i] = s32TmpPos;
    }

    as32OriginalLutPos[63] = (1 << u16BitDepthIn) - 1;
    as32NewLutMax = HiHDR_TF_8((as32OriginalLutPos[63] * u32Ratio + u32halfScaleRatio) >> u16RatioScale, pstTMParaBasic);
    PQ_CHECK_ZERO_RE_FAIL(as32NewLutMax);

    for (i = 0; i < 64; ++i)
    {
        s32Input = ((as32OriginalLutPos[i] * u32Ratio + u32halfScaleRatio) >> u16RatioScale);
        s64Tmp = HiHDR_TF_8(s32Input, pstTMParaBasic);
        s64Tmp = (s64Tmp * as32OriginalLutPos[63] * u32Ratio + u32halfScaleRatio) >> u16RatioScale;
        if (s32Input <= 0)
        {
            s32Input = 1;
        }
        s64Tmp = div64_s64(div64_s64(s64Tmp, s32Input) * (HI_U64)u32ScaleTMFactor, as32NewLutMax) ;
        as32NewLut[i] = (HI_S32)div64_s64(s64Tmp * u32PeakLuminance , PQ_MAX_LUMINANCE);
    }

    as32NewLut[0] = as32NewLut[1];
    for (i = 0; i < 64; ++i)
    {
        as32NewLut[i] = HDR_CLIP3(0, u32ScaleTMFactor, as32NewLut[i]);
    }

    memcpy(pu32OutputLut, as32NewLut, 64 * sizeof(HI_U32));

    return HI_SUCCESS;
}

HI_S32 pq_hal_AdjustBasicTM(HI_U32 u32Ratio, HI_U32 u32PeakLuminance, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    PQ_HDR_TF_PARA gs_stTMParaBasic;
    PQ_HDR_TF_PARA gs_stTMPara;
    HI_U32 u32TMLutXStep[8] = {0};
    HI_U32 u32TMLutXNum[8] = {0};
    HI_U32 u32TMLutXPos[8] = {0};
    static HI_U32 g_u32TMLutBasicXStep[8] = {2, 4, 6, 7, 8, 10, 12, 14};
    static HI_U32 g_u32TMLutBasicXNum[8]  = {16, 44, 52, 68, 88, 144, 208, 252};
    static HI_U32 g_u32TMLutBasicXPos[8]  = {64, 512, 1024, 3072, 8192, 65536, 327680, 1048575};

    PQ_HDR_TF_PARA *pstTMParaBasic = &gs_stTMParaBasic;
    PQ_HDR_TF_PARA *pstTMPara = &gs_stTMPara;

    memcpy(u32TMLutXStep, pstPqHdrCfg->stTMAP.au32StepTM, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
    memcpy(u32TMLutXNum, pstPqHdrCfg->stTMAP.au32NumTM, sizeof(pstPqHdrCfg->stTMAP.au32NumTM));
    memcpy(u32TMLutXPos, pstPqHdrCfg->stTMAP.au32PosTM, sizeof(pstPqHdrCfg->stTMAP.au32PosTM));

    pstTMParaBasic->x_step = g_u32TMLutBasicXStep;
    pstTMParaBasic->x_pos  = g_u32TMLutBasicXPos;
    pstTMParaBasic->x_num  = g_u32TMLutBasicXNum;
    pstTMParaBasic->lut    = g_au32Sdr2HdrTMLutBasicLut;

    pstTMPara->x_step = u32TMLutXStep;
    pstTMPara->x_pos  = u32TMLutXPos;
    pstTMPara->x_num  = u32TMLutXNum;

    return pq_hal_AdjustBasicTMCore(pstTMParaBasic, pstTMPara, u16ScaleCoefTM_SDR2HDR1000, u32Ratio, u32PeakLuminance, pstPqHdrCfg->stTMAP.pu32LUTTM);
}

static HI_S32 pq_hal_SetY2RMatrix(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->stY2R.u16ScaleY2R = u16Y2RScale;

    switch (enInCS)
    {
        case HI_DRV_CS_BT2020_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_2020L,   sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT2020_YUV_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_2020F,   sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT709_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_709L,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT709_YUV_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_709F,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT601_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_601L,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT601_YUV_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_601F,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        default:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_2020L,   sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
    }

    memcpy(pstPqHdrCfg->stY2R.as16DcOutY2R, as16Y2RDcOut, sizeof(pstPqHdrCfg->stY2R.as16DcOutY2R));
    pstPqHdrCfg->stY2R.u16ClipMinY2R = u16Y2RClipMin;
    pstPqHdrCfg->stY2R.u16ClipMaxY2R = u16Y2RClipMax;

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetGamutMappingPara(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* GamutMapping */
    pstPqHdrCfg->stGMAP.u16ScaleGMAP = u16GMapScale;

    pstPqHdrCfg->stGMAP.u32ClipMinGMAP = u32GMapClipMin;
    pstPqHdrCfg->stGMAP.u32ClipMaxGMAP = u32GMapClipMax;

    if (((HI_DRV_CS_BT2020_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT2020_YUV_FULL == enInCS))
        && ((HI_DRV_CS_BT709_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT709_YUV_FULL == enOutCS)
            || (HI_DRV_CS_BT709_RGB_FULL == enOutCS) )) /* 2020->709 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_2020to709, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT2020_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT2020_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT2020_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT2020_YUV_FULL == enOutCS)))/* 2020->2020 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_linear, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT709_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT709_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT2020_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT2020_YUV_FULL == enOutCS)))/* 709->2020 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_709to2020, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT601_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT601_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT2020_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT2020_YUV_FULL == enOutCS)))/* 601->2020 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMAP_Pal_601_2020, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT601_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT601_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT709_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT709_YUV_FULL == enOutCS)))/* 601->709 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMAP_Pal_601_709, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_linear, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetHDRTMap(HI_DRV_COLOR_SPACE_E enInCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->stTMAP.u16ScaleLumaCal = u16TmScaleLumaCal;

    if ((HI_DRV_CS_BT709_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT709_YUV_FULL == enInCS))
    {
        memcpy(pstPqHdrCfg->stTMAP.au16M3LumaCal, au16TmM3LumaCal_709, sizeof(pstPqHdrCfg->stTMAP.au16M3LumaCal));
    }
    else if ((HI_DRV_CS_BT2020_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT2020_YUV_FULL == enInCS))
    {
        memcpy(pstPqHdrCfg->stTMAP.au16M3LumaCal, au16TmM3LumaCal_2020, sizeof(pstPqHdrCfg->stTMAP.au16M3LumaCal));
    }
    else
    {
        memcpy(pstPqHdrCfg->stTMAP.au16M3LumaCal, au16TmM3LumaCal_601, sizeof(pstPqHdrCfg->stTMAP.au16M3LumaCal));
    }

    pstPqHdrCfg->stTMAP.u32ClipMinTM = u32TmClipMin;
    pstPqHdrCfg->stTMAP.u32ClipMaxTM = u32TmClipMax;
    PQ_SAFE_MEMSET(pstPqHdrCfg->stTMAP.as32TMOff, 0, sizeof(pstPqHdrCfg->stTMAP.as32TMOff));
    pqprint(PQ_PRN_HDR, "HdrMode:%d\n", g_u32HdrMode);


    switch (sg_enHDRMode)
    {
        case HI_PQ_HDR_MODE_HDR10_TO_SDR:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2SDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HDR10_TO_HDR10:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_Linear;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_Linear, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HDR10_TO_HLG:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2HLG;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HDR2HLG, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HLG_TO_SDR:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HLG2SDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HLG2SDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HLG_TO_HDR10:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HLG2HDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HLG2HDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HLG_TO_HLG:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_Linear;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_Linear, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SLF_TO_SDR:
            HI_WARN_PQ("pq_hal_SetHDRTMap : Error __LINE__ == %d\n", __LINE__);
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2SDR;
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HDR2SDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SLF_TO_HDR10:
            HI_WARN_PQ("pq_hal_SetHDRTMap : Error __LINE__ == %d\n", __LINE__);
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2SDR;
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HDR2SDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HDR10:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_SDR2HDR1000;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HLG:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_SDR2HLG;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_SDR2HLG, sizeof(g_au32ToolTmClutTmp));
            break;
        default:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2SDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_Linear, sizeof(g_au32ToolTmClutTmp));
            break;
    }

    sg_au16ToolTmScale = pstPqHdrCfg->stTMAP.u16ScaleCoefTM;

    if (0 == sg_u32ToolHdrTmMode)
    {
        memcpy(pstPqHdrCfg->stTMAP.pu32LUTTM, g_au32ToolTmClutTmp, sizeof(pstPqHdrCfg->stTMAP.pu32LUTTM));

        memcpy(g_stToolHdrTmap.au32X_step,  pstPqHdrCfg->stTMAP.au32StepTM, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
        memcpy(g_stToolHdrTmap.au32X_num,   pstPqHdrCfg->stTMAP.au32NumTM,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
        memcpy(g_stToolHdrTmap.au32X_pos,   pstPqHdrCfg->stTMAP.au32PosTM,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
        memcpy(g_stToolHdrTmap.au32Y_LUT,   pstPqHdrCfg->stTMAP.pu32LUTTM,  sizeof(g_stToolHdrTmap.au32Y_LUT));
    }
    else if (1 == sg_u32ToolHdrTmMode)
    {
        memcpy(pstPqHdrCfg->stTMAP.au32StepTM,  g_stToolHdrTmap.au32X_step, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
        memcpy(pstPqHdrCfg->stTMAP.au32NumTM ,  g_stToolHdrTmap.au32X_num,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
        memcpy(pstPqHdrCfg->stTMAP.au32PosTM ,  g_stToolHdrTmap.au32X_pos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
        memcpy(pstPqHdrCfg->stTMAP.pu32LUTTM,   g_stToolHdrTmap.au32Y_LUT,  sizeof(pstPqHdrCfg->stTMAP.pu32LUTTM));
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetR2YMatrix(HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* RGB2YUV */
    pstPqHdrCfg->stR2Y.u16ScaleR2Y = u16ScaleR2Y;

    switch (enOutCS)
    {
        case HI_DRV_CS_BT2020_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_2020NCL,  sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YL;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YL;
            break;
        case HI_DRV_CS_BT2020_YUV_FULL:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YF_2020NCL,  sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YF,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YF,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YF;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YF;
            break;
        case HI_DRV_CS_BT709_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_709,      sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YL;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YL;
            break;
        case HI_DRV_CS_BT709_YUV_FULL:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YF_709,      sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YF,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YF,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YF;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YF;
            break;
        case HI_DRV_CS_BT601_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_601,      sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YL;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YL;
            break;
        case HI_DRV_CS_BT601_YUV_FULL:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YF_601,      sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YF,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YF,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YF;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YF;
            break;
        case HI_DRV_CS_BT2020_RGB_FULL: /*R2R */
        case HI_DRV_CS_BT709_RGB_FULL: /*R2R */
        case HI_DRV_CS_BT601_RGB_FULL: /*R2R */
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2RF,          sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2RF,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2RF,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2RF;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2RF;
            /* RGB out close R2Y, Sm */

            pstPqHdrCfg->bR2YEn         = HI_FALSE;
            pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
            break;
        default:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_709,      sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,         sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL,        sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y = u16ClipMinRF2YL;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y = u16ClipMaxRF2YL;
            break;
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_AdjustHDRTmCurve(HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_S8 i;
    pstPqHdrCfg->stTMAP.u16ScaleLumaCal = u16TmScaleLumaCal;
    if (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] < 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (50 - g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * au32TMLut_HDR2SDR_b0[i]) / 50;
        }
    }
    else if (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] > 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = ((100 - g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] - 50) * au32TMLut_HDR2SDR_b100[i]) / 50;
        }
    }

    if (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] < 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (50 - g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * au32TMLut_HDR2SDR_d0[i]) / 50;
        }
    }
    else if (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] > 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = ((100 - g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] - 50) * au32TMLut_HDR2SDR_d100[i]) / 50;
        }
    }
    pqprint(PQ_PRN_HDR, "Curve_para:M:%d,AccD:%d,AccB:%d,D:%d,B:%d\n", \
            g_u32HdrMode[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32ACCDarkStr[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32ACCBrightStr[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]);

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHDR2HDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* WCG */
    if (enInCS != enOutCS)
    {
        pstPqHdrCfg->bY2REn         = HI_TRUE;
        pstPqHdrCfg->bDegammaEn     = HI_TRUE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_TRUE;
        pstPqHdrCfg->bGammaEn       = HI_TRUE;
        pstPqHdrCfg->bDitherEn      = HI_TRUE;
        pstPqHdrCfg->bR2YEn         = HI_TRUE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /* no exist in 98mv200*/
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /* no exist in 98mv200*/

        pstPqHdrCfg->bGMapPosSel    = HI_TRUE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }
    else
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bDegammaEn     = HI_FALSE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_FALSE;
        pstPqHdrCfg->bGammaEn       = HI_FALSE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_FALSE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /* no exist in 98mv200*/
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /* no exist in 98mv200*/

        pstPqHdrCfg->bGMapPosSel    = HI_FALSE;  /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_PQ, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,        sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,         sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,         sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_PQ10000, sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHDR2SDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_TRUE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /* no exist in 98mv200*/
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /* no exist in 98mv200*/
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;   /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);
    //pstPqHdrCfg->stY2R.u16ClipMaxY2R = u16ClipMaxY2R_1000;

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_PQ, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    pq_hal_AdjustHDRTmCurve(pstPqHdrCfg);
    /* ToneMapping Tmap  adjust with acc histgram*/
    PQ_HAL_CalcHdrTmapACCHistGram(pstPqHdrCfg);
    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,    sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,     sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,     sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_22,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);

    /* Hdr Offset Adjust */
    PQ_hal_HdrOffsetCalCSCCoefRGBtoYCbCr(HI_PQ_HDR_MODE_HDR10_TO_SDR,
                                         g_u32HdrOffsetContrast[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetSatu[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetHue[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetRed[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetGreen[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetBlue[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         pstPqHdrCfg->stR2Y.as16M33R2Y,
                                         g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_HDR10_TO_SDR]);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_HDR10_TO_SDR], sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR], pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR]));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] +
            (g_u32HdrOffsetBright[HI_PQ_HDR_MODE_HDR10_TO_SDR] - 128) * 4;

    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] + (g_u32Bright - 128) * 4;

    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR], sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHDR2HLGCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE ;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_PQ, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));
    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,   sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,    sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,    sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_HLG, sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

HI_S32 pq_hal_GetHLG2SDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE ;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,   sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,    sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,    sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_HLG, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,    sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,     sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,     sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_22,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHLG2HDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE ;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,   sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,    sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,    sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_HLG, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,        sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,         sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,         sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_PQ1250,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHLG2HLGCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* WCG */
    if (enInCS != enOutCS)
    {
        pstPqHdrCfg->bY2REn         = HI_TRUE;
        pstPqHdrCfg->bDegammaEn     = HI_TRUE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_TRUE;
        pstPqHdrCfg->bGammaEn       = HI_TRUE;
        pstPqHdrCfg->bDitherEn      = HI_TRUE;
        pstPqHdrCfg->bR2YEn         = HI_TRUE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /* no exist in 98mv200*/
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /* no exist in 98mv200*/

        pstPqHdrCfg->bGMapPosSel    = HI_TRUE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_TRUE;
    }
    else
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bDegammaEn     = HI_FALSE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_FALSE;
        pstPqHdrCfg->bGammaEn       = HI_FALSE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_FALSE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /* no exist in 98mv200*/
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /* no exist in 98mv200*/

        pstPqHdrCfg->bGMapPosSel    = HI_FALSE;  /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,   sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,    sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,    sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_HLG, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,    sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,     sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,     sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_HLG, sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

/* SLF2SDR not the right cfg */
static HI_S32 pq_hal_GetSLF2SDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE ;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_22, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT )); /* need to be modified */

    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,    sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,     sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,     sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_22,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));/* need to be modified */

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);

    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}


/* SLF2HDR not the right cfg */
static HI_S32 pq_hal_GetSLF2HDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE ;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_22, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT )); /* need to be modified */

    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,        sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,         sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,         sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_PQ1250,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));/* need to be modified */

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSDR2HDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_U32 u32Ratio, u32PeakLuminance;
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_FALSE;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,   sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,    sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,    sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_24,  sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* SDR2HDR Soft Alg */
    u32Ratio         = g_u32BrightCvStr[HI_PQ_HDR_MODE_SDR_TO_HDR10];
    u32PeakLuminance = g_u32DarkCvStr[HI_PQ_HDR_MODE_SDR_TO_HDR10];
    pq_hal_AdjustBasicTM(u32Ratio, u32PeakLuminance, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,        sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,         sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,         sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_PQ1600,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);

    /* Hdr Offset Adjust */
    PQ_hal_HdrOffsetCalCSCCoefRGBtoYCbCr(HI_PQ_HDR_MODE_SDR_TO_HDR10,
                                         g_u32HdrOffsetContrast[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetSatu[HI_PQ_HDR_MODE_SDR_TO_HDR10] * 125 / 100,
                                         g_u32HdrOffsetHue[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetRed[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetGreen[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetBlue[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         pstPqHdrCfg->stR2Y.as16M33R2Y,
                                         g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_SDR_TO_HDR10]);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_SDR_TO_HDR10], sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10], pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10]));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] +
            (g_u32HdrOffsetBright[HI_PQ_HDR_MODE_SDR_TO_HDR10] - 128) * 4;

    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] + (g_u32Bright - 128) * 4;

    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10], sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSDR2SDRCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* WCG */
    if (enInCS != enOutCS)
    {
        pstPqHdrCfg->bY2REn         = HI_TRUE;
        pstPqHdrCfg->bDegammaEn     = HI_TRUE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_TRUE;
        pstPqHdrCfg->bGammaEn       = HI_TRUE;
        pstPqHdrCfg->bDitherEn      = HI_TRUE;
        pstPqHdrCfg->bR2YEn         = HI_TRUE;
        pstPqHdrCfg->bChromaAdjEn   = HI_TRUE;  /* no exist in 98mv200*/
        pstPqHdrCfg->bBT2020CL      = HI_FALSE; /* no exist in 98mv200*/

        pstPqHdrCfg->bGMapPosSel    = HI_TRUE;  /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_TRUE;
    }
    else
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bDegammaEn     = HI_FALSE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_FALSE;
        pstPqHdrCfg->bGammaEn       = HI_FALSE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_FALSE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /* no exist in 98mv200*/
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /* no exist in 98mv200*/

        pstPqHdrCfg->bGMapPosSel    = HI_FALSE;  /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_22, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep,     sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,     sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,     sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_22,  sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSDR2HLGCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE ;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE ;
    pstPqHdrCfg->bTMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGMapEn        = HI_TRUE ;
    pstPqHdrCfg->bGammaEn       = HI_TRUE ;
    pstPqHdrCfg->bDitherEn      = HI_TRUE ;
    pstPqHdrCfg->bR2YEn         = HI_TRUE ;
    pstPqHdrCfg->bGMapPosSel    = HI_FALSE;  /* true : gmapping after tmap; false : gmapping before tmap*/
    pstPqHdrCfg->bDitherMode    = HI_TRUE ;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step, sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,  sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,  sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_24,        sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));
    /* ToneMapping */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep,       sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,        sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,        sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_HLG,    sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSLF2HLGCfg(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_UNUSED(enInCS);
    HI_UNUSED(enOutCS);

    return HI_FAILURE;
}

PF_PQ_Hal_GetHdrPathCfg pfPqHalGetHdrPathCfg[HI_PQ_HDR_MODE_BUTT] =
{
    pq_hal_GetHDR2SDRCfg,
    pq_hal_GetHDR2HDRCfg,
    pq_hal_GetHDR2HLGCfg,

    pq_hal_GetHLG2SDRCfg,
    pq_hal_GetHLG2HDRCfg,
    pq_hal_GetHLG2HLGCfg,

    pq_hal_GetSLF2SDRCfg,
    pq_hal_GetSLF2HDRCfg,
    pq_hal_GetSLF2HLGCfg,

    pq_hal_GetSDR2SDRCfg,
    pq_hal_GetSDR2HDRCfg,
    pq_hal_GetSDR2HLGCfg,
};

HI_S32 PQ_HAL_GetHDRCfg(HI_PQ_XDR_FRAME_INFO *pstXdrFrameInfo, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_S32 s32Ret = HI_SUCCESS;

    PQ_CHECK_NULL_PTR_RE_FAIL(pstXdrFrameInfo);
    PQ_CHECK_NULL_PTR_RE_FAIL(pstPqHdrCfg);
    PQ_CHECK_OVER_RANGE_RE_FAIL(pstXdrFrameInfo->enSrcFrameType, HI_DRV_VIDEO_FRAME_TYPE_BUTT);
    PQ_CHECK_OVER_RANGE_RE_FAIL(pstXdrFrameInfo->enDispType, HI_PQ_DISP_TYPE_BUTT);

    pg_stPqHdrCfg = pstPqHdrCfg;

    stDminfo.u32SrcMaxPQ = pstXdrFrameInfo->unHDRInfo.stHDR10Info.stMasteringInfo.u32MaxDisplayMasteringLuminance;
    stDminfo.u32SrcMinPQ = pstXdrFrameInfo->unHDRInfo.stHDR10Info.stMasteringInfo.u32MinDisplayMasteringLuminance;

    sg_enHDRMode = aenPqHalHdrPathMode[pstXdrFrameInfo->enSrcFrameType][pstXdrFrameInfo->enDispType];

    PQ_CHECK_OVER_RANGE_RE_FAIL(sg_enHDRMode, HI_PQ_HDR_MODE_BUTT);

    s32Ret  = pfPqHalGetHdrPathCfg[sg_enHDRMode](pstXdrFrameInfo->enInCS, pstXdrFrameInfo->enOutCS, pstPqHdrCfg);

    return s32Ret;
}

HI_S32 PQ_HAL_InitHDR(PQ_PARAM_S *pstPqParam, HI_BOOL bParaUseTableDefault)
{
    HI_U32 u32StepBinSum0 = 0;
    HI_U32 u32StepBinSum1 = 0;
    HI_U32 u32NumBinSum0  = 0;
    HI_U32 u32NumBinSum1  = 0;
    HI_U32 u32PosBinSum0  = 0;
    HI_U32 u32PosBinSum1  = 0;
    HI_U32 u32TmapBinSum0 = 0;
    HI_U32 u32TmapBinSum1 = 0;
    HI_U32 i = 0;

    sg_pstHdrBinPara = pstPqParam;

    PQ_CHECK_NULL_PTR_RE_FAIL(sg_pstHdrBinPara);

    /* step 1 : check pq bin data : all zero means no effective para from bin */
    /* check pq bin data */
    for (i = 0; i < 8; i++)
    {
        u32StepBinSum0 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_HDR2SDR][i];
        u32StepBinSum1 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_SDR2HDR][i];
        u32NumBinSum0  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_HDR2SDR][i];
        u32NumBinSum1  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_SDR2HDR][i];
        u32PosBinSum0  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_HDR2SDR][i];
        u32PosBinSum1  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_SDR2HDR][i];
        u32TmapBinSum0 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_HDR2SDR][i];
        u32TmapBinSum1 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_SDR2HDR][i];
    }

    /* step 2 : para use from bin or code */
    /*
        1.use bin para : if bin para not all zero
        2.use code para : if bin para all zero or no bin exist
    */

    /* HDR2SDR : use bin para && bin step para not all 0 */
    /* step */
    if ((HI_TRUE != bParaUseTableDefault) && (u32StepBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], au32TMapStep, sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR]));
    }

    /* num */
    if ((HI_TRUE != bParaUseTableDefault) && (u32NumBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR], au32TMapNum, sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR]));
    }

    /* pos */
    if ((HI_TRUE != bParaUseTableDefault) && (u32PosBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR], au32TMapPos, sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR]));
    }

    /* tmap */
    if ((HI_TRUE != bParaUseTableDefault) && (u32TmapBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], au32TMLut_HDR2SDR_1200, sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR]));
    }

    /* SDR2HDR : use bin para && bin step para not all 0 */
    /* step */
    if ((HI_TRUE != bParaUseTableDefault) && (u32StepBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], au32TMapStep, sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR]));
    }

    /* num */
    if ((HI_TRUE != bParaUseTableDefault) && (u32NumBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR], au32TMapNum, sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR]));
    }

    /* pos */
    if ((HI_TRUE != bParaUseTableDefault) && (u32PosBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR], au32TMapPos, sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR]));
    }

    /* tmap */
    if ((HI_TRUE != bParaUseTableDefault) && (u32TmapBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], au32TMLut_SDR2HDR1000, sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR]));
    }

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHDRParaMode(HI_PQ_HDR_PARA_MODE_S *pstMode)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstMode);

    sg_u32ToolHdrTmMode = pstMode->u32HdrTmMode;
    sg_u32ToolHdrSmMode = pstMode->u32HdrSmMode;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHDRParaMode(HI_PQ_HDR_PARA_MODE_S *pstMode)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstMode);

    pstMode->u32HdrTmMode = sg_u32ToolHdrTmMode;
    pstMode->u32HdrSmMode = sg_u32ToolHdrSmMode;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHdrTMap(HI_PQ_HDR_TMAP_S *pstHdrTmap)
{
    HI_U32 i;

    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrTmap);

    memcpy(&g_stToolHdrTmap, pstHdrTmap, sizeof(g_stToolHdrTmap));

    /* Tool Send Clut * 2^16 */
    for (i = 0; i <  64; i++)
    {
        g_stToolHdrTmap.au32Y_LUT[i] = HDR_CLIP3(0, 65535, g_stToolHdrTmap.au32Y_LUT[i] >> (16 - sg_au16ToolTmScale));
    }

    switch (sg_enHDRMode)
    {
        case HI_PQ_HDR_MODE_HDR10_TO_SDR:
            /* Tmap Clut First Para = 0 */
            g_stToolHdrTmap.au32Y_LUT[0] = 0;

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_HDR2SDR], g_stToolHdrTmap.au32X_step, sizeof(g_stToolHdrTmap.au32X_step));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_HDR2SDR],  g_stToolHdrTmap.au32X_num,  sizeof(g_stToolHdrTmap.au32X_num));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_HDR2SDR],  g_stToolHdrTmap.au32X_pos,  sizeof(g_stToolHdrTmap.au32X_pos));

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_HDR2SDR], g_stToolHdrTmap.au32Y_LUT,  sizeof(g_stToolHdrTmap.au32Y_LUT));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HDR10:
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_SDR2HDR], g_stToolHdrTmap.au32X_step, sizeof(g_stToolHdrTmap.au32X_step));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_SDR2HDR],  g_stToolHdrTmap.au32X_num,  sizeof(g_stToolHdrTmap.au32X_num));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_SDR2HDR],  g_stToolHdrTmap.au32X_pos,  sizeof(g_stToolHdrTmap.au32X_pos));

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_SDR2HDR], g_stToolHdrTmap.au32Y_LUT, sizeof(g_stToolHdrTmap.au32Y_LUT));
            break;
        default:
            HI_ERR_PQ("PQ Tool Only Support Hdr2Sdr & Sdr2Hdr Now \n");
            break;
    }

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHdrTMap(HI_PQ_HDR_TMAP_S *pstHdrTmap)
{
    HI_U32 i;

    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrTmap);

    memcpy(pstHdrTmap, &g_stToolHdrTmap, sizeof(g_stToolHdrTmap));
    /* Tool Recieve Clut * 2^16 */
    for (i = 0; i <  64; i++)
    {
        pstHdrTmap->au32Y_LUT[i] = pstHdrTmap->au32Y_LUT[i] << (16 - sg_au16ToolTmScale);
    }

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHdrSMap(HI_PQ_HDR_SMAP_S *pstHdrSmap)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrSmap);

    memcpy(&g_stToolHdrSmap, pstHdrSmap, sizeof(g_stToolHdrSmap));

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHdrSMap(HI_PQ_HDR_SMAP_S *pstHdrSmap)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrSmap);

    memcpy(pstHdrSmap, &g_stToolHdrSmap, sizeof(g_stToolHdrSmap));

    return HI_SUCCESS;
}

