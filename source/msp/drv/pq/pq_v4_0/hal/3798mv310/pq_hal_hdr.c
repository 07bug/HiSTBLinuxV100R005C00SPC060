/******************************************************************************
*
* Copyright (C) 2016 Hisilicon Technologies Co., Ltd.  All rights reserved.
*
* This program is confidential and proprietary to Hisilicon  Technologies Co., Ltd. (Hisilicon),
*  and may not be copied, reproduced, modified, disclosed to others, published or used, in
* whole or in part, without the express prior written permission of Hisilicon.
*
*****************************************************************************

  File Name    : pq_hal_hdr.c
  Version       : Initial Draft
  Author        : sdk
                      sdk
  Created      : 2016/06/15
  Description  :

******************************************************************************/
#include <linux/string.h>

#include "hi_type.h"
#include "hi_math.h"

#include "pq_hal_comm.h"
#include "drv_pq_ext.h"
#include "pq_hal_hdr.h"

#define HDR_MIN(x, y) (((x) > (y)) ? (y) : (x))
#define HDR_MAX(x, y) (((x) > (y)) ? (x) : (y))
#define HDR_CLIP3(low,high,x)  (HDR_MAX(HDR_MIN((high),(x)),(low)))

#define HDR_LEVEL100_2_NUM2048(Level) (((Level) * 2047 + 50) / 100) // convert [0,100] to [0,2048];,

typedef HI_S32 (*PF_PQ_Hal_GetHdrPathCfg) (HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg);

static HI_PQ_HDR_MODE_E aenPqHalHdrPathMode[HI_DRV_VIDEO_FRAME_TYPE_BUTT][HI_PQ_DISP_TYPE_BUTT] =
{
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_HDR10,    HI_PQ_HDR_MODE_SDR_TO_HLG   },   /* sdr */
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* bl */  //offer sdr para
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* el */  //offer sdr para
    {HI_PQ_HDR_MODE_HDR10_TO_SDR,   HI_PQ_HDR_MODE_HDR10_TO_HDR10,  HI_PQ_HDR_MODE_HDR10_TO_HLG },   /* hdr10 */
    {HI_PQ_HDR_MODE_HLG_TO_SDR,     HI_PQ_HDR_MODE_HLG_TO_HDR10,    HI_PQ_HDR_MODE_HLG_TO_HLG   },   /* hlg */
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* slf */
    {HI_PQ_HDR_MODE_SDR_TO_SDR,     HI_PQ_HDR_MODE_SDR_TO_SDR,      HI_PQ_HDR_MODE_SDR_TO_SDR   },   /* tech */
};

static const HI_S32 g_au32SinTable[61] =
{
    -500, -485, -469, -454, -438, -422, -407, -391,
    -374, -358, -342, -325, -309, -292, -276, -259,
    -242, -225, -208, -191, -174, -156, -139, -122,
    -104,  -87,  -70,  -52,  -35,  -17,    0,   17,
    35,     52,   70,   87,  104,  122,  139,  156,
    174,   191,  208,  225,  242,  259,  276,  292,
    309,   325,  342,  358,  374,  391,  407,  422,
    438,   454,  469,  485,  500
};

static const HI_U32 g_au32CosTable[61] =
{
    866, 875, 883, 891, 899,  906,  914,  921,
    927, 934, 940, 946, 951,  956,  961,  966,
    970, 974, 978, 982, 985,  988,  990,  993,
    995, 996, 998, 999, 999, 1000, 1000, 1000,
    999, 999, 998, 996, 995,  993,  990,  988,
    985, 982, 978, 974, 970,  966,  961,  956,
    951, 946, 940, 934, 927,  921,  914,  906,
    899, 891, 883, 875, 866
};

static HI_PQ_HDR_CFG *pg_stPqHdrCfg     = HI_NULL;
static PQ_HDR_TM_COEF_S sg_stHdrTmClutBinOrCode;
static PQ_HDR_SM_COEF_S sg_stHdrSmClutBinOrCode;
static PQ_BIN_HDR_DYN_TUNING_S sg_stHdrDynBinOrCode;
static PQ_PARAM_S *sg_pstHdrBinPara  = HI_NULL;
static HI_PQ_HDR_MODE_E sg_enHDRMode    = HI_PQ_HDR_MODE_HDR10_TO_SDR;

static DM_INFO_S stDminfo = {0};

static HI_U32 sg_u32ToolHdrTmMode = 0;//选择HDR参数模式。0:固定参数，1:工具调试参数
static HI_U32 sg_u32ToolHdrSmMode = 0;//选择HDR参数模式。0:固定参数，1:.工具调试参数

static HI_U16 sg_au16ToolTmScale = 8;
static HI_U16 sg_au16ToolSmScale = 8;

HI_S16 g_aDstCSCTable[3][3];
HI_S16 g_as16DcOutR2Y[3] = { 64,  512,  512 };

static HI_U32 g_au32Sdr2HdrTMLutBasicLut[256] =      // U24.0
{
    85,      85,      85,      85,      85,      85,      85,      85,
    85,      85,      85,      85,      88,      95,     104,     119,
    141,     221,     287,     349,     410,     468,     527,     584,
    638,     697,     757,     815,     869,     920,     971,    1026,
    1083,    1136,    1186,    1239,    1296,    1353,    1407,    1458,
    1509,    1560,    1612,    1663,    1715,    1922,    2128,    2336,
    2543,    2751,    2959,    3169,    3361,    3768,    4164,    4572,
    4958,    5353,    5761,    6142,    6517,    6934,    7309,    7683,
    8101,    8482,    8853,    9253,    9662,   10410,   11161,   11907,
    12721,   13477,   14228,   14979,   15729,   16479,   17229,   17979,
    18729,   19478,   20228,   20977,   21727,   22476,   23226,   23975,
    24725,   27725,   30727,   33731,   36591,   39591,   42595,   45602,
    48613,   51462,   54441,   57453,   60469,   63488,   66528,   69298,
    72308,   75332,   78359,   81389,   84423,   87460,   90500,   93543,
    96589,   99638,  102691,  105746,  108804,  111865,  114929,  117996,
    121065,  124137,  127212,  130290,  133371,  136454,  139539,  142627,
    145687,  148940,  152394,  155502,  158601,  161712,  164826,  167911,
    171123,  174648,  177885,  180984,  184120,  187238,  190383,  193862,
    197309,  210163,  223199,  236648,  250175,  263813,  277903,  291445,
    306069,  319666,  334398,  348533,  362968,  377848,  392807,  407843,
    422873,  439248,  454631,  469943,  486154,  502314,  517800,  534934,
    550767,  568132,  584137,  601832,  619570,  637238,  653532,  671587,
    689681,  707875,  726167,  744421,  763975,  783788,  802343,  821146,
    841860,  861235,  881102,  901997,  921164,  942060,  963515,  984987,
    1006587, 1028314, 1050166, 1072143, 1094244, 1116467, 1138811, 1161277,
    1183826, 1206384, 1230502, 1255618, 1280914, 1305136, 1328256, 1353208,
    1379069, 1483144, 1589427, 1705480, 1821074, 1944581, 2072822, 2206172,
    2348807, 2494317, 2650839, 2809902, 2977802, 3157838, 3337980, 3532184,
    3732155, 3949307, 4172173, 4402177, 4651658, 4908006, 5171077, 5455412,
    5751030, 6070628, 6399038, 6744628, 7111678, 7499749, 7910258, 8332163,
    8778848, 9262486, 9771750, 10307621, 10877046, 11469037, 12113218, 12877825,
    13620506, 14388091, 15209051, 16139633, 16777216, 16777216, 16777216, 16777216,
};

HI_S16 g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_BUTT][3][3];
HI_S16 g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_BUTT][3] =
{
    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 },

    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 },

    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 },

    { 64,  512,  512 },
    { 64,  512,  512 },
    { 64,  512,  512 }
};

/* ------------------Y2R:YUV2RGB---------------------------- */

/* YUV to RGB params: 10bit in, 10bit out */
static const HI_U16 u16Y2RScale     = 12;
static const HI_U16 u16Y2RClipMin   = 0;
static const HI_U16 u16Y2RClipMax   = 1023; //770;

static const HI_S16 as16Y2RDcInLimit[3] =
{
    -64,
    -512,
    -512
};

static const HI_S16 as16Y2RDcInFull[3] =
{
    0,
    -512,
    -512
};

static const HI_S16 as16Y2RM33_601L[3][3] =
{
    {4784 ,         0  ,     6557 },
    {4784 ,     -1610  ,    -3340 },
    {4784 ,      8279  ,        0 }
};

static const HI_S16 as16Y2RM33_601F[3][3] =
{
    {4096,           0,        5743},
    {4096,       -1410,       -2925},
    {4096,        7251,           0}
};

static const HI_S16 as16Y2RM33_709L[3][3] =
{

    {4784,           0,        7365},
    {4784,        -876,       -2190},
    {4784,        8678,           0}
};

static const HI_S16 as16Y2RM33_709F[3][3] =
{
    {4096,           0,        6451},
    {4096,        -768,       -1918},
    {4096,        7601,           0},
};

static const HI_S16 as16Y2RM33_2020L[3][3] =
{
    {4784,           0,        6896},
    {4784,        -770,       -2672},
    {4784,        8799,           0}
};

static const HI_S16 as16Y2RM33_2020F[3][3] =
{
    {4096,           0,        6040},
    {4096,        -674,       -2341},
    {4096,        7706,           0}
};

static const HI_S16 as16Y2RDcOut[3] =      /*  S10.0 [-1024, 1023] */
{
    0,
    0,
    0
};

/* ---------------------------------------------- */

/************* DeGamma Params **************/
static const HI_U32 au32DeGmm_step[PQ_DEGMM_SEG_SIZE] =
{
    0,  1,  2,  3,  4,  5,  4,  0
};

static const HI_U32 au32DeGmm_pos[PQ_DEGMM_SEG_SIZE]  =
{
    0,  0,  16, 96, 640,    928,    1023,   1023
};

static const HI_U32 au32DeGmm_num[PQ_DEGMM_SEG_SIZE]  =
{
    0,  0,  4,  14, 48, 57, 63, 63
};

// DePQ curve: MPEG HDR
static const HI_U32 au32DeGmmLut_PQ[PQ_DEGMM_LUT_SIZE] =                           //U21.0 [0,2097151]
{
    0,      0,      0,      1,      1,      3,      5,      7,
    11,     15,     21,     28,     36,     46,     58,     87,
    125,    174,    238,    317,    416,    537,    686,    867,
    1085,   1346,   1659,   2031,   2472,   2993,   3607,   4328,
    5173,   6163,   7317,   8663,   10229,  12048,  14160,  16607,
    19440,  22718,  26507,  30884,  35936,  41765,  48488,  56239,
    65172,  87326,  116731, 155767, 207621, 276578, 368425, 491012,
    655041, 875176, 1012329, 1171636, 1356864, 1572464, 1823705, 2097151,
};

// DeHLG Curve: BBC HDR
static const HI_U32 au32DeGmmLut_HLG[PQ_DEGMM_LUT_SIZE] =                              //U21.0 [0,2097151]
{
    0,  11, 43, 96, 171,    385,    684,    1069,
    1539,   2095,   2736,   3463,   4275,   5173,   6156,   8379,
    10944,  13851,  17100,  20691,  24624,  28899,  33516,  38475,
    43776,  49419,  55404,  61731,  68400,  75411,  82764,  90459,
    98496,  106875, 115596, 124659, 134064, 143811, 153900, 164331,
    175105, 186562, 199066, 212713, 227607, 243862, 261603, 280966,
    302098, 350333, 407789, 476226, 557745, 654846, 770507, 908276,
    1072379,    1267850,    1379179,    1500683,    1633293,    1778022,    1935979,    2097151,
};

// DeGamma Curve: SDR
static const HI_U32 au32DeGmmLut_24[PQ_DEGMM_LUT_SIZE] =                            //U21.0 [0,2097151]
{
    0,  3,  18, 49, 97, 257,    513,    877,
    1358,   1966,   2709,   3594,   4627,   5817,   7168,   10377,
    14297,  18967,  24424,  30701,  37831,  45844,  54768,  64630,
    75458,  87276,  100108, 113979, 128910, 144925, 162043, 180286,
    199675, 220228, 241965, 264904, 289065, 314464, 341120, 369049,
    398269, 428795, 460644, 493832, 528375, 564287, 601585, 640282,
    680393, 764917, 855269, 951557, 1053890,    1162369,    1277098,    1398174,
    1525694,    1659752,    1729263,    1800442,    1873302,    1947853,    2024107,    2097151,
};

static const HI_U32 au32DeGmmLut_22[PQ_DEGMM_LUT_SIZE] =                            //U21.0 [0,2097151]
{
    0,  11, 49, 119,    223,    545,    1026,   1677,
    2504,   3515,   4715,   6110,   7704,   9501,   11505,  16150,
    21665,  28074,  35397,  43655,  52865,  63044,  74208,  86371,
    99548,  113751, 128993, 145286, 162642, 181071, 200584, 221192,
    242903, 265727, 289673, 314751, 340969, 368335, 396857, 426543,
    457401, 489438, 522662, 557079, 592697, 629522, 667561, 706821,
    747307, 831985, 921644, 1016329,    1116087,    1220960,    1330989,    1446217,
    1566682,    1692423,    1757283,    1823476,    1891006,    1959878,    2030096,    2097151,
};

/* ------------------ToneMapping---------------------------- */

/* ToneMapping Tmap Params: 20bit in, 20bit out */
static const HI_U16 u16TmScaleLumaCal    = 12;
static const HI_U16 u32TmScaleMixAlpha   = 8;
static const HI_U16 u32TmMixAlphaHdr2Sdr = 64;

static const HI_U16 au16TmM3LumaCal_2020[3] = {1076,  2777,   243};
static const HI_U16 au16TmM3LumaCal_709[3]  = {871 , 2929,  296};   /* U0.12 [0, 4095]      */
static const HI_U16 au16TmM3LumaCal_601[3]  = {1225, 2404,  467};   // U0.12 [0, 4095]
static const HI_S32 as32TMOff_HLG2SDR[3] = {514, 514, 514};      // S13.0  [-4096,4095] BBC: 514

static const HI_U32 u32TmClipMin         = 0;                    /*  U21.0  [0,2097152] */
static const HI_U32 u32TmClipMax         = 2097151;              /*  U21.0  [0,2097152] */

/* ToneMapping Smap Params: 20bit in, 20bit out */
static const HI_U16 u16SmapScaleCoef     = 8;                    /*  U4.0  [0,15] */

/* GamutMapping Params: 20bit in, 20bit out  */
static const HI_U32 u32GMapClipMin  = 0;            /*   U20.0 [0,1048575] */
static const HI_U32 u32GMapClipMax  = 2097151;      //U21.0 [0,2097151]
static const HI_U16 u16GMapScale    = 14;           /*  U4.0  [0,15] */
static const HI_S16 as16M33GMap_2020to709[3][3] =   /*  S1.14 [-2^15, 2^15-1] = [-32768, 32767] */
{
    //BT2020 to BT709
    {19842 , -3458  ,  0     },
    { -2028 , 18412  ,  0     },
    { -300  , -1618  ,  18302 }
};

static const HI_S16 as16M33GMap_709to2020[3][3] =               /*   S1.14 [-2^15, 2^15-1] = [-32768, 32767]  */
{
    /* 709 to 2020  */
    {10279 ,       5396  ,       710},
    {1134  ,     15064   ,      187 },
    {268   ,     1442    ,   14673  }
};

static const HI_S16 as16M33GMap_linear[3][3] =                  /*  S1.14 [-2^15, 2^15-1] = [-32768, 32767] */
{
    /* Linear */
    { 16384,       0  ,       0 },
    {     0,     16384,       0 },
    {     0,       0  ,   16384 }
};

static const HI_S16 as16M33GMAP_Pal_601_709[3][3] =
{
    //BT601 to BT709
    {17106  ,      -724      ,    -1 },
    { -2   ,    16386    ,       0 },
    { 1    ,    193     ,  16191  }
};

static const HI_S16 as16M33GMAP_Ntsc_601_709[3][3] =
{
    //BT601ntsc to BT709
    { 15394  ,       820     ,    167 },
    {  290   ,    15826    ,     269},
    {  -26   ,      -72   ,    16483  }
};

static const HI_S16 as16M33GMAP_Pal_601_2020[3][3] =
{
    //BT601 to BT2020
    { 10731 ,       4951   ,      701 },
    { 1182  ,     15018   ,      184 },
    {  280   ,     1603   ,   14500  }
};

static const HI_S16 as16M33GMAP_Ntsc_601_2020[3][3] =
{
    //BT601ntsc to BT2020
    {  9752    ,    5723   ,      908 },
    { 1331    ,   14606    ,     447 },
    {  254    ,    1342    ,   14788  }
};


static const HI_U32 au32TMapStep[PQ_TMAP_SEG_SIZE] =        /* U5.0  [0,21] */
{
    5, 7, 9, 10, 11, 13, 15, 17
};

static const HI_U32 au32TMapPos[PQ_TMAP_SEG_SIZE]  =        /* U20.0 [0,1048575] */
{
    128, 1024, 2048, 6144, 16384, 131072, 655360, 2097151
};

static const HI_U32 au32TMapNum[PQ_TMAP_SEG_SIZE]  =        /* U6.0  [0,63] */
{
    4, 11, 13, 17, 22, 36, 52, 63
};

/* ToneMapping Lut: HDR10  to SDR */
static const HI_U16 u16ScaleCoefTM_HDR2SDR   = 8;         /* U4.0  [0,15] */

/*************** ToneMapping Lut Params:  *******************************/
static const HI_U32 au32TMLut_HDR2SDR_1200[PQ_TMAP_LUT_SIZE] =             /* U9.7 [0,65535] */
{
    //U8.8 [0,65535]
    0,      5000,   7000,   9000,   9481,   9017,   8705,   8475,
    8298,   8155,   8037,   7938,   7652,   7466,   7225,   7066,
    6947,   6850,   6694,   6566,   6454,   6353,   6259,   5927,
    5637,   5373,   5130,   4904,   4694,   4497,   4312,   4138,
    3975,   3821,   3676,   3539,   3410,   2961,   2598,   2303,
    2048,   1820,   1638,   1489,   1365,   1260,   1170,   1092,
    1024,   964,    910,    862,    819,    683,    585,    512,
    455,    410,    372,    341,    315,    293,    273,    256,
};

/*************** ToneMapping Lut Params:  *******************************/
//(2000, 2000, 0.975)
static const HI_U32 au32TMLut_HDR2SDR_b0[PQ_TMAP_LUT_SIZE] =                     //U8.8 [0,65535]
{
    0,  5000,   7000,   9000,   8547,   7477,   6759,   6235,
    5833,   5512,   5248,   5028,   4407,   4018,   3548,   3267,
    3078,   2940,   2751,   2624,   2533,   2463,   2407,   2261,
    2172,   2109,   2059,   2018,   1983,   1951,   1922,   1896,
    1871,   1847,   1825,   1803,   1782,   1706,   1638,   1575,
    1516,   1461,   1410,   1361,   1315,   1260,   1170,   1092,
    1024,   964,    910,    862,    819,    683,    585,    512,
    455,    410,    372,    341,    315,    293,    273,    256,
};

//(1200, 230, 1.0) with shadow preserving
static const HI_U32 au32TMLut_HDR2SDR_b100[PQ_TMAP_LUT_SIZE] =                   //U8.8 [0,65535]
{
    0,    5000,   7000,   9000,   9481,   9018,   8705,   8475,
    9481,   9481,   9481,   9481,   9481,   9481,   9481,   9481,
    9481,   9481,   9481,   9481,   9481,   9481,   9481,   8768,
    8122,   7541,   7018,   6546,   6120,   5734,   5384,   5065,
    4776,   4511,   4270,   4049,   3846,   3184,   2699,   2333,
    2048,   1820,   1638,   1489,   1365,   1260,   1170,   1092,
    1024,   964,    910,    862,    819,    683,    585,    512,
    455,    410,    372,    341,    315,    293,    273,    256,
};

static const HI_U32 au32TMLut_HDR2SDR_d0[PQ_TMAP_LUT_SIZE] =                     //U8.8 [0,65535]
{
    0,  500,    877,    1350,   1650,   2330,   2870,   3326,
    3677,   3920,   4106,   4271,   4994,   5541,   5838,   5976,
    6111,   6248,   6469,   6553,   6455,   6353,   6259,   5927,
    5637,   5373,   5130,   4904,   4694,   4497,   4312,   4138,
    3975,   3821,   3676,   3539,   3410,   2961,   2598,   2303,
    2048,   1820,   1638,   1489,   1365,   1260,   1170,   1092,
    1024,   964,    910,    862,    819,    683,    585,    512,
    455,    410,    372,    341,    315,    293,    273,    256,
};

static const HI_U32 au32TMLut_HDR2SDR_d100[PQ_TMAP_LUT_SIZE] =                   //U8.8 [0,65535]
{
    8000,  15000,  19516,  23217,  22594,  16871,  14436,  12844,
    11738,  10853,  10137,  9628,   8735,   8252,   7531,   7084,
    6947,  6850,   6694,   6566,   6455,   6353,   6259,   5927,
    5637,   5373,   5130,   4904,   4694,   4497,   4312,   4138,
    3975,   3821,   3676,   3539,   3410,   2961,   2598,   2303,
    2048,   1820,   1638,   1489,   1365,   1260,   1170,   1092,
    1024,   964,    910,    862,    819,    683,    585,    512,
    455,    410,    372,    341,    315,    293,    273,    256,
};


/* ToneMapping Lut: SDR to HDR10 */
static const HI_U16 u16ScaleCoefTM_SDR2HDR1000 = 15;         /* U4.0  [0,15] */
static const HI_U32 au32TMLut_SDR2HDR1000[PQ_TMAP_LUT_SIZE] =                   //U1.15 [0,65535]
{
    10820, 10820,  5410,  3743,  4522,  6551,  6799,  6947,
    6926,  6905,  6889,  6853,  6774,  6714,  6604,  6510,
    6474,  6434,  6354,  6285,  6236,  6201,  6175,  6092,
    6070,  6040,  6019,  6024,  6030,  6038,  6047,  6056,
    6064,  6093,  6105,  6131,  6159,  6248,  6370,  6475,
    6600,  6745,  6877,  7033,  7176,  7338,  7508,  7668,
    7855,  8037,  8212,  8418,  8610,  9475, 10474, 11620,
    12945, 14521, 16321, 18500, 21081, 24253, 28346, 32733,
};

/* ToneMapping Lut: BBC to HDR10 */
static const HI_U16 u16ScaleCoefTM_HLG2HDR = 15;           /* U4.0  [0,15] */
static const HI_U32 au32TMLut_HLG2HDR[PQ_TMAP_LUT_SIZE] =                /*U1.15 [0,65535] */
{
    /*PQ1250*/
    2853,  2853,  3277,  3554,  3764,  4324,  4689,  4967,
    5193,  5386,  5555,  5705,  6187,  6554,  7107,  7528,
    7872,  8164,  8648,  9042,  9378,  9672,  9933, 10773,
    11411, 11931, 12374, 12762, 13107, 13420, 13705, 13969,
    14214, 14444, 14659, 14863, 15056, 15743, 16328, 16839,
    17295, 17707, 18084, 18432, 18756, 19059, 19343, 19612,
    19867, 20109, 20340, 20562, 20774, 21545, 22220, 22821,
    23365, 23863, 24322, 24749, 25148, 25524, 25878, 26214,
};

// ToneMapping Lut:  SDR to HLG
static const HI_U16 u16ScaleCoefTM_SDR2HLG = 12 ;
static const HI_U32 au32TMLut_SDR2HLG[PQ_TMAP_LUT_SIZE] =                    //U9.7 [0,65535]
{
    10339 ,     10339 ,     10339 ,      5169 ,      3554 ,      4814 ,      4702 ,      4549 ,
    4354 ,      4208 ,      4105 ,      3991 ,      3685 ,      3488 ,      3207 ,      3021 ,
    2895 ,      2794 ,      2634 ,      2515 ,      2424 ,      2351 ,      2291 ,      2118 ,
    2012 ,      1931 ,      1867 ,      1821 ,      1783 ,      1750 ,      1721 ,      1696 ,
    1674 ,      1658 ,      1640 ,      1627 ,      1616 ,      1576 ,      1553 ,      1535 ,
    1525 ,      1523 ,      1521 ,      1525 ,      1529 ,      1537 ,      1547 ,      1556 ,
    1571 ,      1585 ,      1599 ,      1617 ,      1634 ,      1717 ,      1819 ,      1940 ,
    2081 ,      2250 ,      2441 ,      2671 ,      2939 ,      3262 ,      3672 ,      4096 ,
};

// ToneMapping Lut:  HDR10 to HLG
static const HI_U16 u16ScaleCoefTM_HDR2HLG = 8 ;
static const HI_U32 au32TMLut_HDR2HLG[PQ_TMAP_LUT_SIZE] =                  //U9.7 [0,65535]
{
    11074 ,     11074 ,      9866 ,      9221 ,      8790 ,      7831 ,      7319 ,      6976 ,
    6722 ,      6521 ,      6355 ,      6215 ,      5809 ,      5537 ,      5175 ,      4933 ,
    4753 ,      4611 ,      4395 ,      4234 ,      4108 ,      4004 ,      3915 ,      3660 ,
    3488 ,      3361 ,      3260 ,      3178 ,      3108 ,      3047 ,      2994 ,      2947 ,
    2905 ,      2866 ,      2831 ,      2799 ,      2769 ,      2668 ,      2588 ,      2341 ,
    2048 ,      1820 ,      1638 ,      1489 ,      1365 ,      1260 ,      1170 ,      1092 ,
    1024 ,       964 ,       910 ,       862 ,       819 ,       683 ,       585 ,       512 ,
    455 ,       410 ,       372 ,       341 ,       315 ,       293 ,       273 ,       256 ,
};


// ToneMapping Lut:  HLG2SDR
static const HI_U16 u16ScaleCoefTM_HLG2SDR = 12 ;
static const HI_U32 au32TMLut_HLG2SDR[PQ_TMAP_LUT_SIZE] =                    //U9.7 [0,65535]
{
    1982 ,      1982 ,      2276 ,      2467 ,      2613 ,      2995 ,      3242 ,      3427 ,
    3575 ,      3700 ,      3807 ,      3901 ,      4191 ,      4398 ,      4684 ,      4879 ,
    5023 ,      5135 ,      5304 ,      5429 ,      5528 ,      5611 ,      5683 ,      5907 ,
    6078 ,      6220 ,      6341 ,      6449 ,      6544 ,      6630 ,      6708 ,      6778 ,
    6843 ,      6902 ,      6956 ,      7006 ,      7052 ,      7202 ,      7310 ,      7385 ,
    7435 ,      7464 ,      7476 ,      7474 ,      7460 ,      7437 ,      7404 ,      7364 ,
    7318 ,      7266 ,      7210 ,      7150 ,      7086 ,      6807 ,      6505 ,      6195 ,
    5888 ,      5589 ,      5302 ,      5029 ,      4772 ,      4531 ,      4306 ,      4096 ,
};


/* ToneMapping Lut: AVS to HDR10 */
static const HI_U16 u16ScaleCoefTM_Linear = 8;             /* U4.0  [0,15] */
static const HI_U32 au32TMLut_Linear[PQ_TMAP_LUT_SIZE] =                 /* U8.8 [0,65535] */
{
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
};


/*************** ToneMapping Smap Lut Params:  *******************************/
static const HI_U16 u16ScaleCoefSM = 8;         /* U4.0  [0,15] */

static const HI_U32 au32SMapStep[PQ_SMAP_SEG_SIZE] =        /* U5.0  [0,21] */
{
    1,  3,  5,  6,  7,  9,  11, 13
};

static const HI_U32 au32SMapPos[PQ_SMAP_SEG_SIZE]  =        /* U21.0 [0,1048575] */
{
    4,  28, 92, 220,    476,    4060,   18396,  65535
};

static const HI_U32 au32SMapNum[PQ_SMAP_SEG_SIZE]  =        /* U6.0  [0,63] */
{
    2,  5,  7,  9,  11, 18, 25, 31
};

/* ToneMapping Smap Lut: SLF  to HDR10 */
static const HI_U32 au32SMLutLinear[PQ_SMAP_LUT_SIZE] =                  //U2.8 [0,1023]
{
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
};

/* ToneMapping Smap Lut: SDR  to HDR */
static const HI_U32 au32SMLut_SDR2HDR[PQ_SMAP_LUT_SIZE] =
{
    //U2.8 [0,1023]
    77,     128,    144,    169,    188,    205,    242,    246,
    251,    254,    256,    256,    256,    256,    256,    256,
    256,    255,    251,    183,    179,    179,    179,    179,
    179,    179,    179,    179,    179,    179,    179,    179,
};

/* ToneMapping Smap Lut: HDR10  to SDR */
static const HI_U32 au32SMLut_HDR2SDR[PQ_SMAP_LUT_SIZE] =            //U2.8 [0,1023]
{
    77,     128,    144,    169,    188,    205,    242,    246,
    251,    254,    256,    256,    256,    256,    256,    256,
    243,    218,    205,    166,    161,    161,    161,    161,
    161,    161,    161,    161,    161,    161,    161,    161,
    /*77,     128,    144,    169,    188,    205,    242,    246,
    251,    254,    256,    256,    256,    256,    256,    256,
    256,    255,    251,    183,    179,    179,    179,    179,
    179,    179,    179,    179,    179,    179,    179,    179,*/
};

/* ToneMapping Smap Lut: HLG to SDR */
static const HI_U16 u16ScaleCoefSM_HLG2SDR = 8;//12;          /* U4.0  [0,15] */
static const HI_U32 au32SMLut_HLG2SDR[PQ_SMAP_LUT_SIZE] =
{
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
    256, 256, 256, 256, 256, 256, 256, 256,
};

/* ---------------------------------------------- */

/******************* Gmm-8 Lut Params *************************/
static const HI_U32 au32GmmStep[PQ_GMM_SEG_SIZE] =        //U5.0  [0,21]
{
    5,  7,  9,  10, 11, 13, 15, 17
};

static const HI_U32 au32GmmPos[PQ_GMM_SEG_SIZE]  =        //U21.0 [0,2097151]
{
    128,    1024,   2048,   6144,   16384,  131072, 655360, 2097151
};

static const HI_U32 au32GmmNum[PQ_GMM_SEG_SIZE]  =        //U6.0  [0,63]
{
    4,  11, 13, 17, 22, 36, 52, 63
};

// PQ Curve
static const HI_U32 au32GmmLut_PQ10000[64] =              //U12.0 [0,4095]
{
    0 ,          304 ,       400 ,       466 ,       517 ,       657 ,       749 ,       820 ,       878 ,       927 ,       970 ,      1008 ,      1129 ,      1220 ,      1354 ,      1454 ,
    1533 ,      1600 ,      1708 ,      1794 ,      1865 ,      1926 ,      1980 ,      2146 ,      2267 ,      2361 ,      2440 ,      2506 ,      2564 ,      2616 ,      2662 ,      2704 ,
    2742 ,      2777 ,      2810 ,      2841 ,      2869 ,      2969 ,      3050 ,      3119 ,      3178 ,      3231 ,      3278 ,      3321 ,      3360 ,      3395 ,      3428 ,      3459 ,
    3488 ,      3515 ,      3540 ,      3564 ,      3587 ,      3668 ,      3736 ,      3794 ,      3846 ,      3892 ,      3933 ,      3971 ,      4006 ,      4038 ,      4067 ,      4095 ,
} ;

static const HI_U32 au32GmmLut_PQ4000[64] =              //U12.0 [0,4095]
{
    0 ,         206 ,       278 ,       327 ,       367 ,       477 ,       551 ,       609 ,       657 ,       697 ,       733 ,       765 ,       867 ,       945 ,      1061 ,      1149 ,
    1220 ,      1279 ,      1376 ,      1454 ,      1519 ,      1575 ,      1624 ,      1778 ,      1891 ,      1980 ,      2054 ,      2118 ,      2173 ,      2222 ,      2267 ,      2307 ,
    2344 ,      2378 ,      2410 ,      2440 ,      2467 ,      2564 ,      2644 ,      2712 ,      2771 ,      2823 ,      2869 ,      2912 ,      2950 ,      2986 ,      3019 ,      3050 ,
    3079 ,      3106 ,      3131 ,      3155 ,      3178 ,      3260 ,      3329 ,      3388 ,      3441 ,      3488 ,      3530 ,      3569 ,      3604 ,      3637 ,      3668 ,      3696 ,
} ;

static const HI_U32 au32GmmLut_PQ1600[64] =              //U12.0 [0,4095]
{
    0,       136,      187,     223,     253,     336,     394,     439,
    477,     509,      538,     564,     648,     712,     810,     884,
    945,     996,     1081,    1149,    1207,    1256,    1300,    1439,
    1542,    1624,    1692,    1751,    1803,    1849,    1891,    1929,
    1964,    1996,    2026,    2054,    2081,    2173,    2249,    2315,
    2372,    2422,    2467,    2509,    2547,    2581,    2614,    2644,
    2672,    2699,    2724,    2748,    2771,    2851,    2920,    2979,
    3032,    3079,    3121,    3160,    3196,    3229,    3260,    3289,
};

static const HI_U32 au32GmmLut_PQ2000[64] =              //U12.0 [0,4095]
{
    0 ,       151 ,       206 ,       246 ,       278 ,       367 ,       429 ,       477 ,       517 ,       551 ,       582 ,       609 ,       697 ,       765 ,       867 ,       945 ,
    1008 ,      1061 ,      1149 ,      1220 ,      1279 ,      1331 ,      1376 ,      1519 ,      1624 ,      1708 ,      1778 ,      1838 ,      1891 ,      1938 ,      1980 ,      2019 ,
    2054 ,      2087 ,      2118 ,      2146 ,      2173 ,      2267 ,      2344 ,      2410 ,      2467 ,      2518 ,      2564 ,      2606 ,      2644 ,      2679 ,      2712 ,      2742 ,
    2771 ,      2797 ,      2823 ,      2847 ,      2869 ,      2950 ,      3019 ,      3079 ,      3131 ,      3178 ,      3221 ,      3260 ,      3296 ,      3329 ,      3360 ,      3388 ,
} ;

static const HI_U32 au32GmmLut_PQ1250[64] =              //U12.0 [0,4095]
{
    0 ,       121 ,       167 ,       201 ,       227 ,       304 ,       358 ,       400 ,       435 ,       466 ,       493 ,       517 ,       596 ,       657 ,       749 ,       820 ,
    878 ,       927 ,      1008 ,      1074 ,      1129 ,      1177 ,      1220 ,      1354 ,      1454 ,      1533 ,      1600 ,      1657 ,      1708 ,      1753 ,      1794 ,      1831 ,
    1865 ,      1897 ,      1926 ,      1954 ,      1980 ,      2071 ,      2146 ,      2210 ,      2267 ,      2317 ,      2361 ,      2402 ,      2440 ,      2474 ,      2506 ,      2536 ,
    2564 ,      2591 ,      2616 ,      2639 ,      2662 ,      2742 ,      2810 ,      2869 ,      2922 ,      2969 ,      3011 ,      3050 ,      3086 ,      3119 ,      3150 ,      3178 ,
} ;

static const HI_U32 au32GmmLut_PQ1200[64] =              //U12.0 [0,4095]
{
    0 ,       118 ,       164 ,       197 ,       223 ,       299 ,       352 ,       394 ,       429 ,       459 ,       485 ,       509 ,       587 ,       648 ,       740 ,       810 ,
    867 ,       916 ,       996 ,      1061 ,      1116 ,      1164 ,      1207 ,      1340 ,      1439 ,      1519 ,      1585 ,      1642 ,      1692 ,      1737 ,      1778 ,      1815 ,
    1849 ,      1881 ,      1910 ,      1938 ,      1964 ,      2054 ,      2129 ,      2193 ,      2249 ,      2299 ,      2344 ,      2385 ,      2422 ,      2457 ,      2489 ,      2518 ,
    2547 ,      2573 ,      2598 ,      2622 ,      2644 ,      2724 ,      2792 ,      2851 ,      2904 ,      2950 ,      2993 ,      3032 ,      3067 ,      3101 ,      3131 ,      3160 ,
} ;

static const HI_U32 au32GmmLut_PQ1000[64] =              //U12.0 [0,4095]
{
    0 ,       108 ,       151 ,       181 ,       206 ,       278 ,       327 ,       367 ,       400 ,       429 ,       454 ,       477 ,       551 ,       609 ,       697 ,       765 ,
    820 ,       867 ,       945 ,      1008 ,      1061 ,      1108 ,      1149 ,      1279 ,      1376 ,      1454 ,      1519 ,      1575 ,      1624 ,      1668 ,      1708 ,      1744 ,
    1778 ,      1809 ,      1838 ,      1865 ,      1891 ,      1980 ,      2054 ,      2118 ,      2173 ,      2222 ,      2267 ,      2307 ,      2344 ,      2378 ,      2410 ,      2440 ,
    2467 ,      2494 ,      2518 ,      2542 ,      2564 ,      2644 ,      2712 ,      2771 ,      2823 ,      2869 ,      2912 ,      2950 ,      2986 ,      3019 ,      3050 ,      3079 ,
} ;

//HLG Curve
static const HI_U32 au32GmmLut_HLG[64] =              //U12.0 [0,4095]
{
    0 ,        28 ,        39 ,        48 ,        55 ,        78 ,        96 ,       111 ,       124 ,       136 ,       147 ,       157 ,       192 ,       222 ,       271 ,       313 ,
    350 ,       384 ,       443 ,       496 ,       543 ,       586 ,       627 ,       768 ,       887 ,       991 ,      1086 ,      1173 ,      1254 ,      1330 ,      1402 ,      1470 ,
    1536 ,      1598 ,      1659 ,      1717 ,      1773 ,      1982 ,      2165 ,      2313 ,      2436 ,      2541 ,      2633 ,      2714 ,      2788 ,      2854 ,      2916 ,      2972 ,
    3024 ,      3073 ,      3119 ,      3162 ,      3203 ,      3346 ,      3466 ,      3569 ,      3660 ,      3740 ,      3812 ,      3878 ,      3939 ,      3995 ,      4047 ,      4095
};

// Gamma Curve
static const HI_U32 au32GmmLut_22[64] =              //U12.0 [0,4095]
{
    0 ,        26 ,        36 ,        44 ,        50 ,        68 ,        82 ,        93 ,       103 ,       112 ,       120 ,       128 ,       154 ,       175 ,       211 ,       240 ,
    266 ,       289 ,       329 ,       364 ,       396 ,       425 ,       451 ,       543 ,       618 ,       684 ,       744 ,       798 ,       847 ,       894 ,       938 ,       979 ,
    1019 ,      1057 ,      1093 ,      1128 ,      1161 ,      1285 ,      1396 ,      1498 ,      1591 ,      1679 ,      1761 ,      1839 ,      1913 ,      1984 ,      2052 ,      2118 ,
    2181 ,      2242 ,      2301 ,      2358 ,      2413 ,      2622 ,      2812 ,      2988 ,      3153 ,      3307 ,      3454 ,      3593 ,      3726 ,      3854 ,      3977 ,      4095
};

static const HI_U32 au32GmmLut_24[64] =              //U12.0 [0,4095]
{
    0 ,        40 ,        54 ,        64 ,        72 ,        96 ,       114 ,       128 ,       140 ,       152 ,       162 ,       171 ,       202 ,       228 ,       270 ,       304 ,
    334 ,       360 ,       406 ,       446 ,       481 ,       513 ,       542 ,       642 ,       724 ,       794 ,       857 ,       914 ,       966 ,      1015 ,      1060 ,      1103 ,
    1144 ,      1183 ,      1220 ,      1256 ,      1290 ,      1416 ,      1527 ,      1629 ,      1722 ,      1808 ,      1889 ,      1966 ,      2039 ,      2108 ,      2174 ,      2237 ,
    2298 ,      2357 ,      2414 ,      2469 ,      2522 ,      2721 ,      2902 ,      3068 ,      3222 ,      3367 ,      3503 ,      3632 ,      3756 ,      3873 ,      3986 ,      4095 ,
};

static const HI_U32 au32GmmLut_bt709[64] =              //U12.0 [0,4095]
{
    0 ,         0 ,         1 ,         1 ,         1 ,         2 ,         3 ,         4 ,         6 ,         7 ,         8 ,         9 ,        13 ,        18 ,        27 ,        36 ,
    45 ,        54 ,        72 ,        90 ,       108 ,       126 ,       144 ,       216 ,       288 ,       360 ,       426 ,       486 ,       541 ,       592 ,       641 ,       686 ,
    730 ,       772 ,       812 ,       850 ,       887 ,      1024 ,      1146 ,      1257 ,      1360 ,      1456 ,      1547 ,      1632 ,      1713 ,      1791 ,      1866 ,      1937 ,
    2006 ,      2073 ,      2138 ,      2200 ,      2261 ,      2489 ,      2697 ,      2889 ,      3068 ,      3237 ,      3397 ,      3549 ,      3694 ,      3833 ,      3966 ,      4095 ,
};

/* RGB to YUV Params */
/* --------------R2Y:RGB2YUV-------------------------------- */

static const HI_U16 u16ScaleR2Y         = 14;   /* U4.0  [0,15] */
static const HI_U16 u16ClipMinRF2YL_Y   = 64;   /* U10.0  [0,1023] */
static const HI_U16 u16ClipMaxRF2YL_Y   = 940;  /* U10.0  [0,1023] */
static const HI_U16 u16ClipMinRF2YL_UV  = 64;   /* U10.0  [0,1023] */
static const HI_U16 u16ClipMaxRF2YL_UV  = 960;  /* U10.0  [0,1023] */

static const HI_U16 u16ClipMinRF2YF_Y   = 0;    // U10.0  [0,1023]
static const HI_U16 u16ClipMaxRF2YF_Y   = 1023; // U10.0  [0,1023]
static const HI_U16 u16ClipMinRF2YF_UV  = 0;    // U10.0  [0,1023]
static const HI_U16 u16ClipMaxRF2YF_UV  = 1023; // U10.0  [0,1023]

static const HI_S16 as16DcInRF2YL[3] =                            /* S10.0  [-1024, 1023] */
{
    0,
    0,
    0
};

static const  HI_S16 as16DcInRF2YF[3] =      // S10.0  [-1024, 1023]
{
    0,
    0,
    0
};

static const HI_S16 as16M33RF2YL_709[3][3] =      // S1.14 [-32768, 32767]
{
    //BT709
    {2984  ,     10034   ,     1013  },
    { -1643 ,      -5531  ,      7175 },
    {7175  ,     -6518   ,     -659  }
};

static const HI_S16 as16M33RF2YL_2020NCL[3][3] =      // S1.14 [-32768, 32767]
{
    //BT2020
    {3685  ,      9512  ,       832  },
    { -2004 ,      -5171 ,       7175 },
    {7175  ,     -6598  ,      -577  }
};

static const HI_S16 as16M33RF2YL_601[3][3] =      // S1.14 [-32768, 32767]
{
    //BT601
    {4195    ,    8235   ,     1599  },
    { -2421 ,      -4754  ,      7175 },
    {7175   ,    -6004    ,   -1167  }
};

static const HI_S16  as16M33RF2YF_709[3][3] =      // S1.14 [-32768, 32767]
{
    //BT709
    {3483    ,   11718     ,   1183  },
    { -1877  ,     -6315   ,     8192 },
    { 8192   ,    -7441    ,    -751  }
};

static const HI_S16  as16M33RF2YF_2020NCL[3][3] =      // S1.14 [-32768, 32767]
{
    //BT2020
    { 4304   ,    11108    ,     972  },
    { -2288   ,    -5904   ,     8192 },
    {8192     ,  -7533     ,   -659  }
};

static const HI_S16 as16M33RF2YF_601[3][3] =      // S1.14 [-32768, 32767]
{
    //BT601
    {4899    ,    9617     ,   1868 },
    { -2765   ,    -5427    ,    8192 },
    { 8192   ,    -6855    ,   -1332 }
};

static const HI_S16 as16DcOutRF2YL[3]  =       /* s10.0  [-1024,1023] */
{
    64,
    512,
    512
};

static const HI_S16 as16DcOutRF2YF[3] =
{
    0,
    512,
    512
};  // s10.0  [-1024,1023]

/* ------------------R2Y:RGB2RGB---------------------------- */
static const HI_U16  u16ScaleRF2RF      = 13;   // U4.0  [0,15]
static const HI_U16  u16ClipMinRF2RF_Y  = 0;    // U10.0  [0,1023]
static const HI_U16  u16ClipMaxRF2RF_Y  = 1023; // U10.0  [0,1023]
static const HI_U16  u16ClipMinRF2RF_UV = 0;    // U10.0  [0,1023]
static const HI_U16  u16ClipMaxRF2RF_UV = 1023; // U10.0  [0,1023]

static const HI_S16  as16DcInRF2RF[3] =      // S10.0  [-1024, 1023]
{
    0,
    0,
    0
};

static const HI_S16   as16M33RF2RF[3][3] =      // S1.14 [-32768, 32767]
{
    {8192    ,   0     ,   0  },
    { 0  ,     8192   ,     0 },
    { 0   ,    0    ,    8192  }
};

static const HI_S16   as16DcOutRF2RF[3] =
{
    0,
    0,
    0
};  // s10.0  [-1024,1023]

static HI_PQ_ACC_HISTGRAM_S gs_stACCHistGram;

static HI_U32 g_au32ToolTmClutTmp[64] = {0};
static HI_U32 g_au32ToolSmClutTmp[32] = {0};
static HI_PQ_HDR_TMAP_S g_stToolHdrTmap = {{0}};
static HI_PQ_HDR_SMAP_S g_stToolHdrSmap = {{0}};

static HI_U32 g_u32ACCOutWidth  = 3840;
static HI_U32 g_u32ACCOutHeight = 2160;
static HI_U32 g_u32HdrMode[HI_PQ_HDR_MODE_BUTT] =
{
    0,    0,    0,
    0,    0,    0,
    0,    0,    0,
    0,    0,    0
};
static HI_U32 g_u32ACCDarkStr[HI_PQ_HDR_MODE_BUTT] =
{
    HDR_LEVEL100_2_NUM2048(UI_u32DarkDetailPro),
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0
};

static HI_U32 g_u32ACCBrightStr[HI_PQ_HDR_MODE_BUTT] =
{
    HDR_LEVEL100_2_NUM2048(UI_u32BrightDetailPro),
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0
};
static HI_U32 g_u32DarkCvStr[HI_PQ_HDR_MODE_BUTT]    =
{
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
};
static HI_U32 g_u32BrightCvStr[HI_PQ_HDR_MODE_BUTT]  =
{
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
    50,    50,    50,
};

static HI_U32 g_u32Bright   = 128;
static HI_U32 g_u32Contrast = 128;
static HI_U32 g_u32Satu     = 128;
static HI_U32 g_u32Hue      = 128;

static HI_U32 g_u32Red      = 128;
static HI_U32 g_u32Green    = 128;
static HI_U32 g_u32Blue     = 128;

static HI_U32 g_u32HdrOffsetBright[HI_PQ_HDR_MODE_BUTT]   =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetContrast[HI_PQ_HDR_MODE_BUTT] =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetSatu[HI_PQ_HDR_MODE_BUTT]     =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetHue[HI_PQ_HDR_MODE_BUTT]      =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetRed[HI_PQ_HDR_MODE_BUTT]      =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetGreen[HI_PQ_HDR_MODE_BUTT]    =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};
static HI_U32 g_u32HdrOffsetBlue[HI_PQ_HDR_MODE_BUTT]     =
{
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
    128,    128,    128,
};

/* DynTmSW Alg : HDR2SDR */
static HI_PQ_HDR_DYN_TM_TUNING_S sg_stHdrDynTmTuningInit =
{
    UI_u32MaxLumiDisplay,
    UI_u32DarkDetailGain,
    UI_u32DarkDetailGmm,
    UI_u32BrightDetailGain,
    UI_u32BrightDetailGmm,
    UI_u32DynTmGain,
    UI_u32DynTmGmm,
    UI_u32DarkSceneDynTM,
    UI_u32DarkLimit,
    UI_u32BleachingLevel,
    UI_u32TemporalSmooth,
};

// Convert 10bit_limited PQ Code Value to Luminance
static const HI_U32 u32PrLimiterScale = 10;
static const HI_U32 au32PrLimiter[11] =
{
    1024, 243, 137, 95, 73, 59, 49, 42, 37, 33, 33
};  // 2^10

static const HI_U32 au32PQtoL[1024] =       // Norm Range : 2^24-1;
{
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      0,      0,      0,      0,      0,
    0,      0,      0,      1,      1,      1,      2,      3,
    3,      4,      5,      6,      7,      8,      9,      11,
    12,     14,     15,     17,     19,     21,     23,     25,
    27,     30,     32,     35,     38,     41,     44,     47,
    50,     54,     57,     61,     65,     69,     73,     78,
    82,     87,     92,     97,     102,    107,    113,    118,
    124,    130,    136,    143,    150,    156,    163,    171,
    178,    186,    194,    202,    210,    219,    227,    236,
    246,    255,    265,    275,    285,    296,    307,    318,
    329,    341,    353,    365,    377,    390,    403,    416,
    430,    444,    458,    473,    488,    503,    519,    535,
    551,    568,    585,    602,    620,    638,    657,    675,
    695,    714,    735,    755,    776,    797,    819,    841,
    864,    887,    910,    934,    959,    984,    1009,   1035,
    1061,   1088,   1116,   1143,   1172,   1201,   1230,   1260,
    1291,   1322,   1353,   1386,   1418,   1452,   1486,   1520,
    1555,   1591,   1627,   1665,   1702,   1740,   1779,   1819,
    1859,   1900,   1942,   1984,   2028,   2071,   2116,   2161,
    2207,   2254,   2301,   2350,   2399,   2449,   2500,   2551,
    2603,   2657,   2711,   2765,   2821,   2878,   2935,   2994,
    3053,   3113,   3175,   3237,   3300,   3364,   3429,   3495,
    3562,   3630,   3699,   3769,   3841,   3913,   3986,   4061,
    4136,   4213,   4291,   4370,   4450,   4531,   4614,   4697,
    4782,   4868,   4956,   5044,   5134,   5226,   5318,   5412,
    5507,   5604,   5702,   5801,   5902,   6004,   6108,   6213,
    6319,   6427,   6537,   6648,   6760,   6875,   6990,   7108,
    7227,   7347,   7469,   7593,   7719,   7846,   7975,   8106,
    8239,   8373,   8509,   8647,   8787,   8929,   9072,   9218,
    9366,   9515,   9666,   9820,   9975,   10133,  10292,  10454,
    10618,  10784,  10952,  11122,  11295,  11470,  11647,  11826,
    12008,  12192,  12378,  12567,  12758,  12952,  13148,  13347,
    13548,  13752,  13958,  14167,  14379,  14593,  14810,  15030,
    15252,  15478,  15706,  15937,  16171,  16408,  16647,  16890,
    17136,  17385,  17637,  17892,  18150,  18412,  18676,  18944,
    19215,  19490,  19768,  20049,  20334,  20622,  20914,  21209,
    21508,  21811,  22117,  22427,  22741,  23058,  23380,  23705,
    24034,  24367,  24704,  25046,  25391,  25740,  26094,  26452,
    26814,  27180,  27551,  27926,  28306,  28690,  29078,  29472,
    29870,  30272,  30680,  31092,  31509,  31931,  32358,  32790,
    33227,  33669,  34116,  34568,  35026,  35489,  35958,  36432,
    36911,  37396,  37887,  38383,  38885,  39393,  39906,  40426,
    40952,  41483,  42021,  42565,  43116,  43672,  44235,  44804,
    45380,  45963,  46552,  47148,  47750,  48360,  48976,  49600,
    50230,  50868,  51513,  52165,  52825,  53492,  54167,  54849,
    55539,  56236,  56942,  57656,  58377,  59107,  59845,  60591,
    61345,  62108,  62880,  63660,  64449,  65246,  66053,  66868,
    67693,  68527,  69370,  70222,  71084,  71956,  72837,  73728,
    74628,  75539,  76460,  77391,  78332,  79284,  80246,  81219,
    82203,  83197,  84202,  85219,  86246,  87285,  88335,  89397,
    90470,  91555,  92652,  93761,  94882,  96016,  97161,  98320,
    99491,  100674, 101871, 103080, 104303, 105539, 106789, 108052,
    109328, 110619, 111924, 113242, 114575, 115923, 117285, 118662,
    120053, 121460, 122882, 124319, 125772, 127240, 128725, 130225,
    131741, 133274, 134823, 136389, 137972, 139571, 141188, 142822,
    144474, 146143, 147831, 149536, 151260, 153002, 154763, 156542,
    158341, 160159, 161996, 163853, 165729, 167626, 169543, 171480,
    173438, 175417, 177417, 179438, 181480, 183545, 185631, 187739,
    189870, 192024, 194200, 196399, 198622, 200868, 203138, 205433,
    207751, 210094, 212462, 214854, 217273, 219716, 222186, 224681,
    227203, 229752, 232327, 234930, 237560, 240218, 242904, 245618,
    248361, 251132, 253933, 256763, 259624, 262514, 265434, 268386,
    271368, 274382, 277427, 280504, 283614, 286756, 289931, 293140,
    296382, 299659, 302969, 306314, 309695, 313111, 316562, 320050,
    323574, 327136, 330734, 334370, 338044, 341757, 345508, 349299,
    353129, 357000, 360910, 364862, 368855, 372890, 376966, 381086,
    385248, 389454, 393703, 397997, 402336, 406720, 411150, 415626,
    420149, 424719, 429336, 434002, 438716, 443479, 448292, 453155,
    458069, 463034, 468051, 473120, 478241, 483416, 488645, 493928,
    499266, 504660, 510110, 515617, 521180, 526802, 532482, 538222,
    544020, 549880, 555800, 561782, 567825, 573932, 580102, 586337,
    592636, 599000, 605431, 611928, 618494, 625127, 631829, 638601,
    645443, 652356, 659341, 666399, 673530, 680735, 688014, 695370,
    702802, 710311, 717898, 725563, 733309, 741135, 749042, 757031,
    765103, 773259, 781500, 789826, 798239, 806739, 815328, 824005,
    832773, 841632, 850583, 859627, 868764, 877997, 887326, 896751,
    906275, 915897, 925620, 935443, 945368, 955397, 965530, 975768,
    986112, 996564, 1007125,    1017796,    1028577,    1039470,    1050477,    1061598,
    1072835,    1084189,    1095661,    1107252,    1118963,    1130797,    1142753,    1154834,
    1167041,    1179375,    1191837,    1204429,    1217152,    1230007,    1242996,    1256121,
    1269382,    1282781,    1296320,    1310000,    1323823,    1337789,    1351901,    1366160,
    1380568,    1395126,    1409836,    1424699,    1439718,    1454893,    1470226,    1485719,
    1501374,    1517193,    1533176,    1549327,    1565646,    1582135,    1598797,    1615633,
    1632645,    1649834,    1667203,    1684754,    1702489,    1720409,    1738516,    1756813,
    1775301,    1793983,    1812860,    1831935,    1851210,    1870687,    1890367,    1910254,
    1930350,    1950656,    1971175,    1991909,    2012860,    2034032,    2055425,    2077043,
    2098889,    2120963,    2143269,    2165810,    2188588,    2211604,    2234863,    2258367,
    2282117,    2306118,    2330371,    2354879,    2379646,    2404673,    2429964,    2455521,
    2481347,    2507446,    2533820,    2560472,    2587405,    2614623,    2642127,    2669922,
    2698011,    2726396,    2755081,    2784070,    2813364,    2842969,    2872887,    2903121,
    2933675,    2964553,    2995758,    3027293,    3059162,    3091370,    3123918,    3156812,
    3190055,    3223651,    3257603,    3291916,    3326593,    3361638,    3397056,    3432851,
    3469026,    3505587,    3542536,    3579878,    3617619,    3655761,    3694310,    3733269,
    3772644,    3812439,    3852659,    3893308,    3934391,    3975912,    4017878,    4060292,
    4103159,    4146485,    4190274,    4234533,    4279265,    4324476,    4370172,    4416357,
    4463038,    4510220,    4557907,    4606107,    4654824,    4704065,    4753835,    4804140,
    4854986,    4906379,    4958325,    5010831,    5063902,    5117546,    5171767,    5226573,
    5281971,    5337966,    5394566,    5451778,    5509607,    5568062,    5627149,    5686876,
    5747249,    5808275,    5869963,    5932320,    5995352,    6059068,    6123476,    6188583,
    6254397,    6320926,    6388178,    6456162,    6524886,    6594357,    6664585,    6735578,
    6807345,    6879895,    6953235,    7027377,    7102328,    7178097,    7254695,    7332131,
    7410413,    7489552,    7569558,    7650440,    7732208,    7814874,    7898446,    7982935,
    8068352,    8154707,    8242012,    8330276,    8419512,    8509730,    8600941,    8693158,
    8786391,    8880652,    8975953,    9072307,    9169725,    9268219,    9367803,    9468488,
    9570287,    9673214,    9777281,    9882502,    9988890,    10096458,   10205221,   10315192,
    10426385,   10538815,   10652495,   10767441,   10883667,   11001189,   11120021,   11240178,
    11361677,   11484533,   11608761,   11734379,   11861401,   11989846,   12119729,   12251067,
    12383878,   12518178,   12653986,   12791319,   12930196,   13070634,   13212651,   13356268,
    13501501,   13648372,   13796898,   13947101,   14098998,   14252612,   14407962,   14565068,
    14723953,   14884636,   15047140,   15211485,   15377695,   15545791,   15715796,   15887733,
    16061625,   16237495,   16415368,   16595266,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
    16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,   16777215,
};

HI_U32 g_u32PosTMLut[HDR_TM_LUT_SIZE]     = {0};         //256段TMLut位置
HI_U32 g_u32CumHistTMLut[HDR_TM_LUT_SIZE] = {0};         //PosTMLut对应的累积直方图，插值得到
HI_U32 g_u32HistTMLut[HDR_TM_LUT_SIZE]    = {0};         //PosTMLut对应的分段直方图
HI_U32 g_u32LenSeg[HDR_TM_LUT_SIZE]       = {0};         //每段段长
HI_U64 g_u64Pr[HDR_TM_LUT_SIZE]           = {0};         //每段中单位长度概率
HI_U32 g_au32PrNew[HDR_TM_LUT_SIZE]       = {0};
HI_U64 g_au64CumPrNew[HDR_TM_LUT_SIZE]    = {0};
HI_U32 g_u32PrevTMLut[HDR_TM_LUT_SIZE]    = {0};         //前一帧TMLut， 初值赋值静态Tmlut参数,

HiPP_HDR_TM_PARA sg_stDynTmParaTmp = {{0}};

HI_S32 PQ_HAL_SetHDRTMCurve(HI_PQ_SETHDROFFSET_S *pstHdrOffsetPara)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrOffsetPara);

    g_u32HdrMode[pstHdrOffsetPara->enHdrProcessScene]        = pstHdrOffsetPara->u32HdrMode;
    g_u32ACCDarkStr[pstHdrOffsetPara->enHdrProcessScene]     = HDR_LEVEL100_2_NUM2048(pstHdrOffsetPara->u32ACCdark);
    g_u32ACCBrightStr[pstHdrOffsetPara->enHdrProcessScene]   = HDR_LEVEL100_2_NUM2048(pstHdrOffsetPara->u32ACCbrigt);
    g_u32DarkCvStr[pstHdrOffsetPara->enHdrProcessScene]      = pstHdrOffsetPara->u32darkCv;
    g_u32BrightCvStr[pstHdrOffsetPara->enHdrProcessScene]    = pstHdrOffsetPara->u32brightCv;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_SetHdrCscSetting(HI_PQ_PICTURE_SETTING_S *pstPicSetting)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstPicSetting);

    g_u32Bright   = (HI_U32)pstPicSetting->u16Brightness;
    g_u32Contrast = (HI_U32)pstPicSetting->u16Contrast;
    g_u32Satu     = (HI_U32)pstPicSetting->u16Hue;
    g_u32Hue      = (HI_U32)pstPicSetting->u16Saturation;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_SetHdrOffset(HI_PQ_SETHDROFFSET_S *pstHdrOffsetPara)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrOffsetPara);

    g_u32HdrOffsetBright[pstHdrOffsetPara->enHdrProcessScene]   = pstHdrOffsetPara->u32Bright;
    g_u32HdrOffsetContrast[pstHdrOffsetPara->enHdrProcessScene] = pstHdrOffsetPara->u32Contrast;
    g_u32HdrOffsetSatu[pstHdrOffsetPara->enHdrProcessScene]     = pstHdrOffsetPara->u32Satu;
    g_u32HdrOffsetHue[pstHdrOffsetPara->enHdrProcessScene]      = pstHdrOffsetPara->u32Hue;
    g_u32HdrOffsetRed[pstHdrOffsetPara->enHdrProcessScene]      = pstHdrOffsetPara->u32R;
    g_u32HdrOffsetGreen[pstHdrOffsetPara->enHdrProcessScene]    = pstHdrOffsetPara->u32G;
    g_u32HdrOffsetBlue[pstHdrOffsetPara->enHdrProcessScene]     = pstHdrOffsetPara->u32B;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_SetHDRACCHistGram(HI_U32 u32ACCOutWidth, HI_U32 u32ACCOutHeight, HI_PQ_ACC_HISTGRAM_S *pstACCHistGram)
{
    HI_U32 i = 0;
    PQ_CHECK_NULL_PTR_RE_FAIL(pstACCHistGram);

    g_u32ACCOutWidth  = u32ACCOutWidth;
    g_u32ACCOutHeight = u32ACCOutHeight;

    memcpy(&gs_stACCHistGram, pstACCHistGram, sizeof(gs_stACCHistGram));

    // 棋盘格采样导致像素点个数减半
    for (i = 0; i < 64; i++)
    {
        gs_stACCHistGram.u32HistGram1[i] = 2 * gs_stACCHistGram.u32HistGram1[i];
    }

    return HI_SUCCESS;
}

static HI_VOID PQ_hal_CalCSCCoefRGBtoYCbCr(HI_U32 Contrast, HI_U32 Saturation, HI_U32 Hue,
        HI_U32 Kr, HI_U32 Kg, HI_U32 Kb, HI_S16 pCSCTable[3][3], HI_S16 pDstCSCTable[3][3])
{
    HI_S32 ContrastAdjust;
    HI_S32 SaturationAdjust;
    HI_S32 rGain, gGain, bGain;

    ContrastAdjust   = Contrast   * 40 / 51;
    SaturationAdjust = Saturation * 40 / 51;
    Hue   = Hue * 60 / 255;
    rGain = Kr  * 40 / 51;
    gGain = Kg  * 40 / 51;
    bGain = Kb  * 40 / 51;

    g_aDstCSCTable[0][0] = (HI_S16)((HI_S32)pCSCTable[0][0] * ContrastAdjust * rGain  / 10000);
    g_aDstCSCTable[0][1] = (HI_S16)((HI_S32)pCSCTable[0][1] * ContrastAdjust * gGain  / 10000);
    g_aDstCSCTable[0][2] = (HI_S16)((HI_S32)pCSCTable[0][2] * ContrastAdjust * bGain  / 10000);
    g_aDstCSCTable[1][0]  = (HI_S16)(((HI_S32)(pCSCTable[1][0] * g_au32CosTable[Hue]) / 1000
                                      + (HI_S32)(pCSCTable[2][0] * g_au32SinTable[Hue]) / 1000)
                                     * SaturationAdjust * rGain / 10000);
    g_aDstCSCTable[1][1]  = (HI_S16)(((HI_S32)(pCSCTable[1][1] * g_au32CosTable[Hue]) / 1000
                                      + (HI_S32)(pCSCTable[2][1] * g_au32SinTable[Hue]) / 1000)
                                     * SaturationAdjust * gGain  / 10000);
    g_aDstCSCTable[1][2]  = (HI_S16)(((HI_S32)(pCSCTable[1][2] * g_au32CosTable[Hue]) / 1000
                                      + (HI_S32)(pCSCTable[2][2] * g_au32SinTable[Hue]) / 1000)
                                     * SaturationAdjust * bGain  / 10000);
    g_aDstCSCTable[2][0] = (HI_S16)(((HI_S32)(pCSCTable[2][0] * g_au32CosTable[Hue]) / 1000
                                     - (HI_S32)(pCSCTable[1][0] * g_au32SinTable[Hue]) / 1000)
                                    * SaturationAdjust * rGain  / 10000);
    g_aDstCSCTable[2][1] = (HI_S16)(((HI_S32)(pCSCTable[2][1] * g_au32CosTable[Hue]) / 1000
                                     - (HI_S32)(pCSCTable[1][1] * g_au32SinTable[Hue]) / 1000)
                                    * SaturationAdjust * gGain  / 10000);
    g_aDstCSCTable[2][2] = (HI_S16)(((HI_S32)(pCSCTable[2][2] * g_au32CosTable[Hue]) / 1000
                                     - (HI_S32)(pCSCTable[1][2] * g_au32SinTable[Hue]) / 1000)
                                    * SaturationAdjust * bGain  / 10000);
    return;
}

static HI_VOID PQ_hal_HdrOffsetCalCSCCoefRGBtoYCbCr(HI_PQ_HDR_MODE_E enHdrProcessScene, HI_U32 Contrast, HI_U32 Saturation,
        HI_U32 Hue, HI_U32 Kr, HI_U32 Kg, HI_U32 Kb, HI_S16 pCSCTable[3][3], HI_S16 pDstCSCTable[3][3])
{
    HI_S32 ContrastAdjust;
    HI_S32 SaturationAdjust;
    HI_S32 rGain, gGain, bGain;

    ContrastAdjust   = Contrast   * 40 / 51;
    SaturationAdjust = Saturation * 40 / 51;
    Hue   = Hue * 60 / 255;
    rGain = Kr  * 40 / 51;
    gGain = Kg  * 40 / 51;
    bGain = Kb  * 40 / 51;

    g_aDstHdrOffsetCSCTable[enHdrProcessScene][0][0] = (HI_S16)((HI_S32)pCSCTable[0][0] * ContrastAdjust * rGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][0][1] = (HI_S16)((HI_S32)pCSCTable[0][1] * ContrastAdjust * gGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][0][2] = (HI_S16)((HI_S32)pCSCTable[0][2] * ContrastAdjust * bGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][1][0]  = (HI_S16)(((HI_S32)(pCSCTable[1][0] * g_au32CosTable[Hue]) / 1000
            + (HI_S32)(pCSCTable[2][0] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * rGain / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][1][1]  = (HI_S16)(((HI_S32)(pCSCTable[1][1] * g_au32CosTable[Hue]) / 1000
            + (HI_S32)(pCSCTable[2][1] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * gGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][1][2]  = (HI_S16)(((HI_S32)(pCSCTable[1][2] * g_au32CosTable[Hue]) / 1000
            + (HI_S32)(pCSCTable[2][2] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * bGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][2][0] = (HI_S16)(((HI_S32)(pCSCTable[2][0] * g_au32CosTable[Hue]) / 1000
            - (HI_S32)(pCSCTable[1][0] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * rGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][2][1] = (HI_S16)(((HI_S32)(pCSCTable[2][1] * g_au32CosTable[Hue]) / 1000
            - (HI_S32)(pCSCTable[1][1] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * gGain  / 10000);
    g_aDstHdrOffsetCSCTable[enHdrProcessScene][2][2] = (HI_S16)(((HI_S32)(pCSCTable[2][2] * g_au32CosTable[Hue]) / 1000
            - (HI_S32)(pCSCTable[1][2] * g_au32SinTable[Hue]) / 1000)
            * SaturationAdjust * bGain  / 10000);
    return;
}


/* DynTmSW Alg : HDR2SDR */

//[-24 ,0]*2^(30) 返回值的范围
static HI_S64 Hipp_HDR_CalLog2x( HI_U64 u64DataIn , HI_U32  u32Qbit  )
{
    HI_U32  u32Integer = 0 ;
    HI_U8   u8BitSftInt = 0 ;
    HI_U8   u8BitSftDecial = 0 ;
    HI_S32  s32ErrorRange = 11  ;  //10^(-8)*2^30
    HI_U64  u64ResData = 1 ;
    HI_S32  s32ErrorRes ;
    HI_U32  u32Indx = 0 ;
    HI_U64  u64DataTemp  ;
    HI_U32  i  ;
    HI_S64  s64Val = 0 ;
    HI_U32  au32CoeffX[27] =
    {
        11 ,      21 ,       43 ,       86 ,      172,      344 ,       687 ,     1374 ,      2749 ,
        5498 ,   10995 ,    21990 ,    43980 ,    87961,   175922 ,    351844 ,   703687 ,   1407375 ,
        2814750 , 5629500 , 11258999 , 22517998 , 45035996, 90071993 , 180143985 , 360287970 , 720575940 ,
    } ;

    HI_U32  au32Coef2PowerX[27] =
    {
        1073741831  ,              1073741839    ,            1073741854    ,            1073741884  ,
        1073741943  ,              1073742062    ,            1073742300    ,            1073742777  ,
        1073743729  ,              1073745635    ,            1073749445    ,            1073757067  ,
        1073772309  ,              1073802796    ,            1073863771    ,            1073985731  ,
        1074229694  ,              1074717785    ,            1075694633    ,            1077650995  ,
        1081574397  ,              1089464106    ,            1105416603    ,            1138025769  ,
        1206158336  ,              1354904781    ,            1709691216    ,
    } ;

    u32Integer = (HI_U32)(u64DataIn >> u32Qbit) ; //[1,10] 4bit

    s64Val = 0 ;
    u8BitSftInt = 0 ;
    u8BitSftDecial = 0 ;
    if ( u32Integer >= 1)
    {
        while ( u32Integer != 1 )
        {
            u32Integer = u32Integer / 2 ;
            u8BitSftInt = u8BitSftInt + 1 ;
        }

        u64ResData = u64DataIn >> u8BitSftInt ;
        s32ErrorRes =  (HI_S32)(u64ResData - (((HI_U64)1) << u32Qbit)) ;
        s64Val =  u8BitSftInt * (((HI_U64)1) << u32Qbit) ;
    }
    else
    {
        u64DataTemp = u64DataIn ;
        while ( u32Integer == 0 )
        {
            u64DataTemp = u64DataTemp * 2 ;
            u32Integer =  (HI_U32)(u64DataTemp >> u32Qbit) ; //
            u8BitSftDecial = u8BitSftDecial + 1;
        }

        u64ResData = u64DataIn << u8BitSftDecial ;
        s32ErrorRes = (HI_S32)(u64ResData - (((HI_U64)1) << u32Qbit)) ;
        s64Val = ((HI_U64)u8BitSftDecial) << u32Qbit ;
        s64Val = -1 * s64Val ;
    }

    while (s32ErrorRes >= s32ErrorRange )
    {
        for ( i = 0 ; i < 27 ; i++)
        {
            if ( (HI_U64)au32Coef2PowerX[i] >= u64ResData )
            {
                u32Indx = i ;
                break;
            }
        }

        if ( i == 27 )
        {
            u32Indx = 27 ;
        }

        if ( u32Indx >= 1 )
        {
            u32Indx = u32Indx - 1 ;
            PQ_CHECK_ZERO_RE_FAIL(au32Coef2PowerX[u32Indx]);
            u64ResData = div64_u64((u64ResData << u32Qbit), au32Coef2PowerX[u32Indx]);
            s32ErrorRes =  (HI_S32)(u64ResData - (((HI_U64)1) << u32Qbit)) ;
            s64Val = s64Val +  au32CoeffX[u32Indx] ;
        }
        else
        {
            u32Indx = u32Indx ;
            PQ_CHECK_ZERO_RE_FAIL(au32Coef2PowerX[u32Indx]);
            u64ResData = div64_u64((u64ResData << u32Qbit), au32Coef2PowerX[u32Indx]);
            s32ErrorRes =  (HI_S32)(u64ResData - (((HI_U64)1) << u32Qbit)) ;
            s64Val = s64Val +  au32CoeffX[u32Indx] ;
        }
    }

    return s64Val  ;
}


static HI_U64 HiPP_HDR_Power2X( HI_U64 u64DataIn , HI_U32  u32QBbit )
{
    //2^x , x= x1+x2+......+xn
    // 2^x = 2^x1*2^x2*......*2^xn
    //x可以分解为整数和小数部分
    // 小数部分可以分解为2的幂次多项式
    //HI_U32  u32QBbit = 30 ;

    //HI_U32  u32QBbit = 30 ;

    HI_U32 au32CoefPower2Frac[30]  =
    {
        1518500250 , 1276901417  , 1170923762  , 1121280436 ,
        1097253709 , 1085434106  , 1079572136  , 1076653034 ,
        1075196444 , 1074468888  , 1074105295  , 1073923544 ,
        1073832681 , 1073787252  , 1073764538  , 1073753181 ,
        1073747503 , 1073744664  , 1073743244  , 1073742534 ,
        1073742179 , 1073742002  , 1073741913  , 1073741869 ,
        1073741847 , 1073741836  , 1073741830  , 1073741827 ,
        1073741826 , 1073741825  ,
    };

    HI_U64  u64DataTemp ;
    HI_U32  u32Coeaf2polyInteg ;
    HI_U32  u32FracPart ;
    HI_U32  u32TempData ;
    HI_U32  u32Coeaf2poly[30] = {0} ;
    HI_U64  u64Data ;
    HI_U64  u64DataOut ;
    HI_U32 icount = 0 ;
    HI_U32 i ;

    u64DataTemp  =  ( u64DataIn >> ( u32QBbit) ) ;
    u32Coeaf2polyInteg = u64DataTemp & 0xFFFFFFFF ;
    u32FracPart = (HI_U32)(u64DataIn & 0x3FFFFFFF) ; // 1 = 2^30

    for (i = 0; i < 30; i++)
    {
        u32TempData = u32FracPart & (1 << (29 - i)) ;
        u32Coeaf2poly[i] = u32TempData >> (29 - i) ;
    }

    u64Data = 1 ;
    icount = 0 ;
    for (i = 0; i < 30; i++)
    {
        if ( u32Coeaf2poly[i] == 1  )
        {
            if ( icount == 0 )
            {
                u64Data = u64Data * au32CoefPower2Frac[i] ;
            }
            else
            {
                u64Data = u64Data * au32CoefPower2Frac[i] ;
                u64Data = u64Data >> 30 ;
            }

            icount = icount + 1 ;
        }
    }

    if (icount == 0)
    {
        u64Data = ((HI_U64)1) << u32QBbit;
    }

    if ( u32Coeaf2polyInteg <= 32 )
    {
        u64DataOut =  u64Data * ( ((HI_U64)1) << u32Coeaf2polyInteg ) ;
    }
    else
    {
        u64DataOut =  0xFFFFFFFFFFFFFFFF ;
    }

    return u64DataOut ;
}

static HI_U64 Hipp_HDR_Pow( HI_U64 u64X, HI_U32 u32Xbit, HI_U64 u64Y, HI_U32 u32Ybit  )   // 计算X^Y;
{
    /*
        实现t = x^y;
        log2(t) = log2(x^y) = y*(log2(x)) = y*f = g;
        f = log2(x);
        g = f*y;
        t = pow2(g);

        case 1: f>=0;
        f = log2(x);    f>=0;
        g = f*y;        g>=0;
        h = pow2(g);    h>=0;
        t = 2^(g) = h;

        case 2: f<0;
        f = log2(x);    f<=0;
        g = -f*y;       g>=0;
        h = pow2(g);    h>=0;
        t = 2^(-g) = 1/(2^g) = 1/h;
    */
    HI_U32 i = 0;
    HI_S64 s64F = 0;
    HI_U64 u64G, u64H, u64T = 0;
    HI_U64 u64IntY, u64DecY = 0;
    HI_U64 u64IntResult = 0;
    HI_U64 u64DecResult = 0;

    if (u64X == 0)
    {
        return 0;
    }

    u64IntY = u64Y >> u32Ybit;
    u64DecY = u64Y - (HI_U64)(u64IntY << u32Ybit);

    u64IntResult = 1 << u32Xbit; //置1
    for (i = 0; i < u64IntY; i++)
    {
        u64IntResult = (HI_U64)((u64IntResult * u64X) >> u32Xbit);
    }

    if ( u64DecY == 0 )
    {
        u64DecResult = 1 << u32Xbit; //置1
    }
    else
    {
        s64F = Hipp_HDR_CalLog2x( u64X, u32Xbit );  // [-24 ,0]*2^(30) 返回值的范围
        if ( s64F >= 0 )
        {
            u64G = (HI_U64)((HI_U64)(s64F * u64DecY) >> u32Ybit);
            u64H = HiPP_HDR_Power2X( u64G, u32Xbit );
            u64DecResult = u64H;
        }
        else
        {
            u64G = (HI_U64)((HI_U64)(-s64F * u64DecY) >> u32Ybit);
            u64H = HiPP_HDR_Power2X( u64G, u32Xbit );

            PQ_CHECK_ZERO_RE_FAIL(u64H);
            u64DecResult = div64_u64(((HI_U64)1 << (u32Xbit + 30)), u64H);
        }
    }

    u64T = (HI_U64)((u64IntResult * u64DecResult) >> u32Xbit);

    return u64T;
}

static HI_U32 HippEstiMaxScl(HI_U32 *a32CumHistLuma, HI_U32 u32Width, HI_U32 u32Height)
{
    HI_U32 u32CvMaxScl = 0;
    HI_U32 i, j, jStart;
    HI_U32 idx = 0;
    HI_U32 u32PctLen = 10;
    // Percentage : [ 0.99 0.993 0.995 0.998 0.9985 0.999 0.9995 0.9998 0.9999 0.99999 ] * 3840 * 2160;
    HI_U32 a32PctMaxScl[10] = {8211456, 8236339, 8252928, 8277811, 8281958, 8286106, 8290253, 8292741, 8293571, 8294317};
    HI_U32 u32IdxEsti[10] = {0};
    HI_U32 u32CvEsti[10] = {0};
    HI_U32 u32IdxCP = 7;    //Index of Check Point, 0.9998

    // Estimate Percentiles
    jStart = HIST_BIN_NUM - 2;
    for ( i = 0; i < u32PctLen; i++ )
    {
        jStart = HIST_BIN_NUM - 2;
        for (idx = 0; idx < (jStart + 1); idx++)
        {
            j = jStart - idx;
            if (a32CumHistLuma[j] <= a32PctMaxScl[i])
            {
                if ((a32PctMaxScl[i] - a32CumHistLuma[j]) < (a32CumHistLuma[j + 1] - a32PctMaxScl[i]))
                {
                    u32IdxEsti[i] = j;
                }
                else
                {
                    u32IdxEsti[i] = j + 1;
                }
                jStart = u32IdxEsti[i];
                break;
            }
        }
    }

    for ( i = 0; i < u32PctLen; i++ )
    {
        u32CvEsti[i] = u32IdxEsti[i] * HIST_BIN_WIDTH + HIST_BIN_WIDTH - 1;
    }

    // CvMaxScl Search
    if (u32CvEsti[u32IdxCP] < 701)
    {
        for (i = u32IdxCP; i < u32PctLen; i++)
        {
            u32CvMaxScl = u32CvEsti[i];
            if (u32CvMaxScl >= 701)
            {
                break;
            }
        }
    }
    else if (u32CvEsti[u32IdxCP] >= 940)
    {
        for (i = 0; i < (u32IdxCP + 1); i++)
        {
            u32CvMaxScl = u32CvEsti[u32IdxCP - i];
            if (u32CvMaxScl <= 919)
            {
                break;
            }
        }
    }
    else if (u32CvEsti[u32IdxCP] >= 919)
    {
        for (i = 0; i < (u32IdxCP + 1); i++)
        {
            u32CvMaxScl = u32CvEsti[u32IdxCP - i];
            if (u32CvMaxScl <= 893)
            {
                break;
            }
        }
    }
    else if (u32CvEsti[u32IdxCP] >= 893)
    {
        for (i = 0; i < (u32IdxCP + 1); i++)
        {
            u32CvMaxScl = u32CvEsti[u32IdxCP - i];
            if (u32CvMaxScl <= 863)
            {
                break;
            }
        }
    }
    else if (u32CvEsti[u32IdxCP] >= 863)
    {
        for (i = 0; i < (u32IdxCP + 1); i++)
        {
            u32CvMaxScl = u32CvEsti[u32IdxCP - i];
            if (u32CvMaxScl <= 828)
            {
                break;
            }
        }
    }
    else if (u32CvEsti[u32IdxCP] >= 828)
    {
        for (i = 0; i < (u32IdxCP + 1); i++)
        {
            u32CvMaxScl = u32CvEsti[u32IdxCP - i];
            if (u32CvMaxScl <= 791)
            {
                break;
            }
        }
    }
    else if (u32CvEsti[u32IdxCP] >= 791)
    {
        for (i = 0; i < (u32IdxCP + 1); i++)
        {
            u32CvMaxScl = u32CvEsti[u32IdxCP - i];
            if (u32CvMaxScl <= 767)
            {
                break;
            }
        }
    }
    else
    {
        u32CvMaxScl = u32CvEsti[u32IdxCP];
    }

    u32CvMaxScl = HDR_CLIP3(510, 900, u32CvMaxScl);

    return u32CvMaxScl;
}

static HI_S32 HippCalDTMCurve(HI_U32 *a32CumHistLuma, HiPP_HDR_TM_PARA *stDynTmPara, HI_U32 u32CvMaxScl, HI_PQ_HDR_DYN_TM_TUNING_S *pstDynTmTuning, HI_U32 *u32PosTM)
{
    HI_U32 i, j, k;
    HI_U32 u32TmpStep;
    HI_U32 u32LumMaxScl = 0;
    HI_U32 u32NormPoint = 63;
    HI_U32 u32DarkLimit = 16384;

    //定点
    HI_U32 u32PrScale2P = 30;
    HI_U32 u32PrScale2PShift = 10;
    HI_U32 u32PrTh = 107374182;             //(0.1<<30);    // Range: [0,1];
    HI_U64 u64SumPrNew = 0;
    HI_S64 s64F = 0;
    HI_S64 s64G = 0;
    HI_U64 u64H = 0;
    HI_U32 u32TmIn  = 0;
    HI_U32 u32TmOut = 0;
    HI_U32 u32Mark0, u32Mark1;
    HI_U32 u32Alpha = 0;
    HI_U32 u32CumLumiHist[HIST_BIN_NUM_LTD] = {0};  // 可用的55段直方图
    HI_U32 u32CodeVal[HIST_BIN_NUM_LTD] = {0};      // 可用的55段直方图码字段中值
    HI_U32 u32Lumi[HIST_BIN_NUM_LTD] = {0};         // 55段直方图码字段中值对应的线性亮度，以2^21-1量化

    // Initial LumiHist
    for (i = 0; i < HIST_BIN_NUM_LTD; i++)
    {
        u32CodeVal[i] = i * HIST_BIN_WIDTH + 64 + (HIST_BIN_WIDTH >> 1);    //取直方图码字段中值
        u32Lumi[i] = au32PQtoL[u32CodeVal[i]] >> 3;                     // 24bit->21bit
        u32CumLumiHist[i] = a32CumHistLuma[i + HIST_BIN_LTD_IDX];
    }
    u32CumLumiHist[HIST_BIN_NUM_LTD - 1] = UHD_PIX_NUM;

    // Cal u32PosTMLut
    g_u32PosTMLut[0] = 1;
    k = 0;
    u32TmpStep = stDynTmPara->au32StepTM[k];
    for (i = 1; i < HDR_TM_LUT_SIZE; i++)
    {
        while ( i > stDynTmPara->au32NumTM[k] && k < 8)         // Find Current SEG
        {
            k = k + 1;
            if (k < 8)
            {
                u32TmpStep = stDynTmPara->au32StepTM[k];
            }
        }
        g_u32PosTMLut[i] = g_u32PosTMLut[i - 1] + (1 << u32TmpStep);
        g_u32PosTMLut[i] = HDR_MIN(g_u32PosTMLut[i], 2097151);  // 2^21-1
    }
    memcpy(u32PosTM, g_u32PosTMLut, sizeof(HI_U32)*HDR_TM_LUT_SIZE);

    // Cal u32CumHistTMLut 累积直方图
    u32Mark0 = 0;
    u32Mark1 = 1;
    k = 0;
    for (i = 0; i < HDR_TM_LUT_SIZE; i++)                   //线性插值得到u32PosTMLut[HDR_TM_LUT_SIZE]中对应的直方图
    {
        for (j = 0; j < HIST_BIN_NUM_LTD - 1; j++)          //查找u32PosTMLut所在段的前后插值点
        {
            if ( u32Lumi[j] <= g_u32PosTMLut[i] && g_u32PosTMLut[i] <= u32Lumi[j + 1] )
            {
                u32Mark0 = j;
                u32Mark1 = j + 1;
                break;
            }
        }

        //  线性插值
        PQ_CHECK_ZERO_RE_FAIL(u32Lumi[u32Mark1] - u32Lumi[u32Mark0]);
        u32Alpha = (HI_U32)(div64_s64(((HI_U64)(u32Lumi[u32Mark1] - g_u32PosTMLut[i]) << 20), (u32Lumi[u32Mark1] - u32Lumi[u32Mark0])));
        g_u32CumHistTMLut[i] = (HI_U32)(((HI_U64)u32CumLumiHist[u32Mark0] * u32Alpha + (HI_U64)u32CumLumiHist[u32Mark1] * ((1 << 20) - u32Alpha)) >> 20);
    }

    // Cal u32HistTMLut 分段直方图
    g_u32HistTMLut[0] = g_u32CumHistTMLut[0];   //U23
    g_u32LenSeg[0] = g_u32PosTMLut[0];          //U21

    //定点
    PQ_CHECK_ZERO_RE_FAIL(g_u32LenSeg[0]);
    g_u64Pr[0] = (HI_U64)(div64_u64(div64_u64(((HI_U64)g_u32HistTMLut[0] << u32PrScale2P), g_u32LenSeg[0]), UHD_PIX_NUM)); // U30
    /*
        实现y = x^(1/3)：   x=[0,1];
        log2(y) = log2(x^(1/3)) = 1/3*(log2(x)) = 1/3*f;

        f = log2(x);    f<=0;
        g = -f*(1/3);   g>=0;
        h = 2^g;        h>=0;
        y = 2^(-g) = 1/(2^g) = 1/h;
    */
    if (g_u64Pr[0] == 0)
    {
        g_au32PrNew[0] = g_u64Pr[0];
    }
    else
    {
        s64F = Hipp_HDR_CalLog2x( (HI_U64)g_u64Pr[0], u32PrScale2P );
        s64G = div64_s64(-s64F, 3);
        u64H = HiPP_HDR_Power2X( (HI_U64)s64G, u32PrScale2P );

        PQ_CHECK_ZERO_RE_FAIL(u64H);
        g_au32PrNew[0] = (HI_U32)(div64_u64(((HI_U64)1 << (u32PrScale2P * 2)), u64H));
    }

    g_au64CumPrNew[0] = (((HI_U64)g_au32PrNew[0] * g_u32LenSeg[0]) >> u32PrScale2PShift); // 20 bit;  30bit x 21bit / 10bit
    u64SumPrNew = u64SumPrNew + g_au32PrNew[0];

    PQ_CHECK_OVER_RANGE_RE_FAIL(u32CvMaxScl, 1024);

    u32LumMaxScl = au32PQtoL[u32CvMaxScl] >> 3;
    // 线性亮度上计算TM曲线
    for ( i = 1; i < HDR_TM_LUT_SIZE; i++ )
    {
        g_u32HistTMLut[i] = g_u32CumHistTMLut[i] - g_u32CumHistTMLut[i - 1];
        g_u32LenSeg[i] = g_u32PosTMLut[i] - g_u32PosTMLut[i - 1];

        PQ_CHECK_ZERO_RE_FAIL(u32PrTh);
        g_u64Pr[i] = (HI_U32)HDR_MIN(div64_u64(div64_u64(((HI_U64)g_u32HistTMLut[i] << u32PrScale2P), HDR_MAX(g_u32LenSeg[i], 1)), UHD_PIX_NUM), u32PrTh);

        if (g_u64Pr[i] == 0)
        {
            g_au32PrNew[i] = (HI_U32)g_u64Pr[i];
        }
        else
        {
            s64F = Hipp_HDR_CalLog2x( (HI_U64)g_u64Pr[i], u32PrScale2P );
            s64G = div64_s64(-s64F, 3);
            u64H = HiPP_HDR_Power2X( (HI_U64)s64G, u32PrScale2P );

            PQ_CHECK_ZERO_RE_FAIL(u64H);
            g_au32PrNew[i] = (HI_U32)(div64_u64(((HI_U64)1 << (u32PrScale2P * 2)), u64H));
        }

        g_au64CumPrNew[i] = g_au64CumPrNew[i - 1] + (((HI_U64)g_au32PrNew[i] * g_u32LenSeg[i]) >> u32PrScale2PShift); // 20 bit;  30bit x 21bit / 10bit

        //dSumPrNew = dSumPrNew + dPrNew[i];
        if ( g_u32PosTMLut[i - 1] <= u32LumMaxScl && u32LumMaxScl <= g_u32PosTMLut[i] )
        {
            u32NormPoint = i;
        }
    }

    u32DarkLimit = HDR_CLIP3(4096, 16384 << (DYN_TM_COEF_SCALE2P - 6), pstDynTmTuning->u32DarkLimit);

    for ( i = 0; i < HDR_TM_LUT_SIZE; i++ )
    {
        u32TmOut = (HI_U32)div64_u64(HDR_MIN(g_au64CumPrNew[i], g_au64CumPrNew[u32NormPoint]), HDR_MAX((g_au64CumPrNew[u32NormPoint] >> LUMI_BIT), 1)); //U21
        u32TmIn  = g_u32PosTMLut[i];                                                                                    //U21

        PQ_CHECK_ZERO_RE_FAIL(u32TmIn);
        stDynTmPara->pu32LUTTM[i] = (HI_U32)(div64_u64(((HI_U64)u32TmOut << DYN_TM_COEF_SCALE2P), (u32TmIn)));
        stDynTmPara->pu32LUTTM[i] = HDR_MIN( u32DarkLimit, stDynTmPara->pu32LUTTM[i]);
        if (i > u32NormPoint)
        {
            stDynTmPara->pu32LUTTM[i] = stDynTmPara->pu32LUTTM[u32NormPoint];
        }
    }

    stDynTmPara->pu32LUTTM[0] = stDynTmPara->pu32LUTTM[1];

    return HI_SUCCESS;
}

static HI_S32 HippEstiDTMAlpha(HI_U32 *a32CumHistLuma, HI_U32 *u32AlphaBright, HI_U32 *u32AlphaDark)
{
    HI_U32 i, j, jStart, idx;
    HI_S32 s32Tmp = 0;
    HI_U32 u32Tmp = 0;
    HI_U32 u32SumBriPerWt = 0;
    HI_U32 u32SumDarPerWt = 0;
    HI_U32 u32AlphaDarTmp = 0;
    HI_U32 u32AlphaBriTmp = 0;
    HI_U32 u32AlphaDarProt = 0;

    HI_U32 u32PctLen = 7;
    // Percentage : [ 0.01 0.25 0.5 0.75 0.90 0.95 0.9998] * 3840 * 2160;
    HI_U32 au32PctMaxScl[7] = {82944, 2073600, 4147200, 6220800, 7464960, 7879680, 8292741};
    HI_U32 au32IdxEsti[7]   = {0};
    HI_U32 au32CvEsti[7]    = {0};
    HI_S32 as32LumiEsti[7]  = {0};

    // Luminance [0,10000] nits Normalize to [0, 2^24-1];
    HI_S32 as32L1[7] =      { 1678, 13422,  83886,  251658, 503316, 838861, 1677722};
    HI_S32 as32L2[7] =      {13422, 83886,  251658, 503316, 838861, 1342177, 3355443};
    HI_U32 au32BriPerWt[7] = {    1,     1,    1  ,     1 ,    1 ,    1,        1  };
    HI_U32 u32BriWt = 0;

    HI_S32 as32L3[7] =      {   0,  1678,   5033,   16777,  33554,  83886,  167772};
    HI_S32 as32L4[7] =      {1678,  5033,   16777,  33554,  83886,  167772, 335544};
    HI_U32 au32DarPerWt[7] = {    1,    3,    2  ,      1 ,    1 ,    1,        1 };
    HI_U32 u32DarWt = 0;

    // Estimate Percentiles
    //jStart = HIST_BIN_NUM - 2;
    for ( i = 0; i < u32PctLen; i++ )
    {
        jStart = HIST_BIN_NUM - 2;
        for (idx = 0; idx < (jStart + 1); idx++)
        {
            j = jStart - idx;
            if (a32CumHistLuma[j] <= au32PctMaxScl[i])
            {
                if ((au32PctMaxScl[i] - a32CumHistLuma[j]) < (a32CumHistLuma[j + 1] - au32PctMaxScl[i]))
                {
                    au32IdxEsti[i] = j;
                }
                else
                {
                    au32IdxEsti[i] = j + 1;
                }
                jStart = au32IdxEsti[i];
                break;
            }
        }
    }

    for ( i = 0; i < u32PctLen; i++ )
    {
        au32CvEsti[i] = au32IdxEsti[i] * HIST_BIN_WIDTH + HIST_BIN_WIDTH - 1;
        as32LumiEsti[i] = (HI_S32)(au32PQtoL[au32CvEsti[i]]);               // 24bit, 不需要转换成21bit
    }

    // Esti BriWt
    for (i = 0; i < u32PctLen; i++)
    {
        PQ_CHECK_ZERO_RE_FAIL(as32L2[i] - as32L1[i]);
        s32Tmp = (HI_S32)(div64_s64(((HI_S64)(as32LumiEsti[i] - as32L1[i]) << ALPHA_SCALE2P), (as32L2[i] - as32L1[i])));
        u32Tmp = (HI_U32)HDR_CLIP3(0, 1 << ALPHA_SCALE2P, s32Tmp);
        u32BriWt = u32BriWt + u32Tmp * au32BriPerWt[i];
        u32SumBriPerWt = u32SumBriPerWt + au32BriPerWt[i];
    }

    PQ_CHECK_ZERO_RE_FAIL(u32SumBriPerWt);
    u32AlphaBriTmp = u32BriWt / u32SumBriPerWt;

    // Esti DraWt
    for (i = 0; i < u32PctLen; i++)
    {
        PQ_CHECK_ZERO_RE_FAIL(as32L4[i] - as32L3[i]);
        s32Tmp = (HI_S32)(div64_s64(((HI_S64)(as32L4[i] - as32LumiEsti[i]) << ALPHA_SCALE2P), (as32L4[i] - as32L3[i])));
        u32Tmp = (HI_U32)HDR_CLIP3(0, 1 << ALPHA_SCALE2P, s32Tmp);
        u32DarWt = u32DarWt + u32Tmp * au32DarPerWt[i];
        u32SumDarPerWt = u32SumDarPerWt + au32DarPerWt[i];
    }

    PQ_CHECK_ZERO_RE_FAIL(u32SumDarPerWt);
    u32AlphaDarTmp = u32DarWt / u32SumDarPerWt;

    // Frame-Average-Light-Level Protector
    if (as32LumiEsti[u32PctLen - 1] <= 503316)          // 300 nits
    {
        u32AlphaDarProt = (307 << ALPHA_SCALE2P) >> 10; //0.3
    }
    else if (as32LumiEsti[u32PctLen - 1] <= 1677721)    // 1000 nits
    {
        u32AlphaDarProt = ((as32LumiEsti[u32PctLen - 1] - 503316) << ALPHA_SCALE2P) / 251658 / 10 + ((307 << ALPHA_SCALE2P) >> 10);
    }
    else
    {
        u32AlphaDarProt = 1 << ALPHA_SCALE2P;       // 1
    }

    u32AlphaDarTmp = HDR_MIN(u32AlphaDarTmp, u32AlphaDarProt);

    *u32AlphaBright = u32AlphaBriTmp;
    *u32AlphaDark   = u32AlphaDarTmp;

    return HI_SUCCESS;
}

static HI_S32 HippHdrDynTM(HiPP_HDR_DYN_TM *pstStcTm, HI_PQ_HDR_DYN_TM_TUNING_S *pstDynTmTool, HiPP_HDR_DYN_ACC_DETAIL *pstDynAccDetail, HiPP_HDR_DYN_TM *pstDynTm)
{
    HI_U32 i;
    HI_U32 u32Tmp, u32BitShift, u32TempAlpha;
    HI_S32 s32Result = 0;
    HI_U32 a32CumHistLuma[HIST_BIN_NUM] = {0};  //Cumulative Histogram 64 bins
    HI_U32 u32AlphaBright = 0;
    HI_U32 u32AlphaDark = 0;
    HI_U32 u32AlphaBrightTuned = 0;
    HI_U32 u32AlphaDarkTuned = 0;
    HI_U32 u32AlphaDTMTuned = 0;
    HI_U32 u32AlphaDTM = 0;
    HI_U32 a32PosTMLut[HDR_TM_LUT_SIZE] = {0};

    HI_U32 u32CvMaxScl = 0;
    HI_U32 u32LumiMaxScl = 0;
    HI_U32 u32SrcPixNum = g_u32ACCOutWidth * g_u32ACCOutHeight;
    memcpy(&sg_stDynTmParaTmp, &(pstStcTm->stTM), sizeof(HiPP_HDR_TM_PARA));

    /************* 调用直方图获取函数替换 *******************/
    memcpy(a32CumHistLuma, gs_stACCHistGram.u32HistGram1, sizeof(gs_stACCHistGram.u32HistGram1));

    /*********************** end ****************************/
    /* copy step,num,pos */
    memcpy(pstDynTm, pstStcTm, sizeof(HiPP_HDR_DYN_TM));

    // Normalize histogram resolution to UHD
    PQ_CHECK_ZERO_RE_FAIL(u32SrcPixNum);
    for (i = 0; i < HIST_BIN_NUM; i++)
    {
        a32CumHistLuma[i] = (HI_U32)(div64_u64(((HI_U64)a32CumHistLuma[i] * UHD_PIX_NUM), u32SrcPixNum));
    }

    // 直方图容错 20180419
    if ( a32CumHistLuma[HIST_BIN_NUM - 1] > (UHD_PIX_NUM >> 1) )
    {
        // Cal Histogram, a32HistLuma

        // Estimate MaxScl
        u32CvMaxScl = HippEstiMaxScl(a32CumHistLuma, 3840, 2160);

        // DTM Curve
        s32Result = HippCalDTMCurve(a32CumHistLuma, &sg_stDynTmParaTmp, u32CvMaxScl, pstDynTmTool, a32PosTMLut);

        // Estimate Blending Alpha
        s32Result = HippEstiDTMAlpha(a32CumHistLuma, &u32AlphaBright, &u32AlphaDark);

        // PQ Tool Tuning
        u32BitShift = 30 - HDR_MIN(ALPHA_SCALE2P, 30);
        u32AlphaBrightTuned = (HI_U32)((Hipp_HDR_Pow((HI_U64)(u32AlphaBright << u32BitShift), 30, pstDynTmTool->u32BrightDetailGmm, 10) \
                                        *pstDynTmTool->u32BrightDetailGain) >> (u32BitShift + 10));
        u32AlphaDarkTuned = (HI_U32)((Hipp_HDR_Pow((HI_U64)(u32AlphaDark << u32BitShift), 30, pstDynTmTool->u32DarkDetailGmm, 10) \
                                      *pstDynTmTool->u32DarkDetailGain) >> (u32BitShift + 10));
        // UI Menu Tuning
        u32AlphaBrightTuned = (HI_U32)((HI_U64)u32AlphaBrightTuned * pstDynAccDetail->u32BrightDetailPro >> 10);
        u32AlphaDarkTuned = (HI_U32)((HI_U64)u32AlphaDarkTuned * pstDynAccDetail->u32DarkDetailPro >> 10);

        u32AlphaDTM = u32AlphaBrightTuned + u32AlphaDarkTuned;

        u32AlphaDTMTuned = (HI_U32)((Hipp_HDR_Pow((HI_U64)(u32AlphaDTM << u32BitShift), 30, pstDynTmTool->u32DynTmGmm, 10) \
                                     *pstDynTmTool->u32DynTmGain) >> (u32BitShift + 10));

        u32LumiMaxScl = (HI_U32)(((HI_U64)au32PQtoL[u32CvMaxScl] * 10000) >> 24); //nits
        // 场景最大亮度MaxScl小于等于屏的最大亮度MaxLumiDisplay

        u32AlphaDTMTuned = HDR_CLIP3(0, 1024, u32AlphaDTMTuned);

        // DTM LUT Blending
        u32Tmp = 1 << ALPHA_SCALE2P;
        u32TempAlpha = HDR_CLIP3(0, 1024, pstDynTmTool->u32TemporalSmooth);
        for ( i = 0; i < HIST_BIN_NUM; i++)
        {
            if ( pstStcTm->u16TmScaleCoef <= DYN_TM_COEF_SCALE2P )
            {
                pstDynTm->stTM.pu32LUTTM[i] = (HI_U32)(((HI_U64)pstStcTm->stTM.pu32LUTTM[i] * (u32Tmp - u32AlphaDTMTuned) << (DYN_TM_COEF_SCALE2P - pstStcTm->u16TmScaleCoef))
                                                       + (HI_U64)sg_stDynTmParaTmp.pu32LUTTM[i] * u32AlphaDTMTuned) \
                                              >> (ALPHA_SCALE2P + DYN_TM_COEF_SCALE2P - FNL_TM_COEF_SCALE2P);
            }
            else
            {
                pstDynTm->stTM.pu32LUTTM[i] = (HI_U32)((HI_U64)pstStcTm->stTM.pu32LUTTM[i] * (u32Tmp - u32AlphaDTMTuned)
                                                       + ((HI_U64)sg_stDynTmParaTmp.pu32LUTTM[i] * u32AlphaDTMTuned << (pstStcTm->u16TmScaleCoef - DYN_TM_COEF_SCALE2P))) \
                                              >> (ALPHA_SCALE2P + pstStcTm->u16TmScaleCoef - FNL_TM_COEF_SCALE2P);
            }
            pstDynTm->stTM.pu32LUTTM[i] = HDR_CLIP3(0, 65535, pstDynTm->stTM.pu32LUTTM[i]);
            // 时域平滑, 20180419
            pstDynTm->stTM.pu32LUTTM[i] = (HI_U32)(((1024 - u32TempAlpha) * pstDynTm->stTM.pu32LUTTM[i] + u32TempAlpha * g_u32PrevTMLut[i]) >> 10);
            g_u32PrevTMLut[i] = pstDynTm->stTM.pu32LUTTM[i];
        }

        pstDynTm->u16TmScaleCoef = FNL_TM_COEF_SCALE2P;

    }
    else //直方图出错, 采用STM, 20180419
    {
        memcpy(pstDynTm, pstStcTm, sizeof(HiPP_HDR_DYN_TM));
    }

    return HI_SUCCESS;
}

/* sdr2hdr soft alg*/
static HI_U32 HiHDR_LutCal(HI_U32 *lut, HI_U32 u32Base, HI_U32 u32Step, HI_U32 u32IndexBase, HI_U32 u32InMax, HI_U32 u32InData)
{
    HI_U32 u32IndexOff, u32Index;
    HI_U32 u32y0, u32y1, u32y;

    u32IndexOff = abs(u32InData - u32Base) >> u32Step;
    u32Index = u32IndexOff + u32IndexBase;
    PQ_CHECK_OVER_RANGE_RE_FAIL(u32Index + 1, 256);

    u32y0 = lut[u32Index];
    u32y1 = lut[u32Index + 1];

    if (u32InData <= u32InMax)
    {
        u32y = (HI_U32)(((((HI_S64)u32y1 - (HI_S64)u32y0) * ((HI_S64)u32InData - (HI_S64)(u32IndexOff * (1 << u32Step) + u32Base))) >> u32Step) + u32y0);
    }
    else
    {
        u32y = u32y0;
    }

    return u32y;
}

static HI_U32 HiHDR_TF_8(HI_U32 u32InData, PQ_HDR_TF_PARA *pGmmPara)
{
    HI_U32 u32Base, u32Step, u32IndexBase;
    if (u32InData <= pGmmPara->x_pos[0])
    {
        u32Base = 0;
        u32Step = pGmmPara->x_step[0];
        u32IndexBase = 0;
    }
    else if (u32InData <= pGmmPara->x_pos[1])
    {
        u32Base = pGmmPara->x_pos[0];
        u32Step = pGmmPara->x_step[1];
        u32IndexBase = pGmmPara->x_num[0];
    }
    else if (u32InData <= pGmmPara->x_pos[2])
    {
        u32Base = pGmmPara->x_pos[1];
        u32Step = pGmmPara->x_step[2];
        u32IndexBase = pGmmPara->x_num[1];
    }
    else if (u32InData <= pGmmPara->x_pos[3])
    {
        u32Base = pGmmPara->x_pos[2];
        u32Step = pGmmPara->x_step[3];
        u32IndexBase = pGmmPara->x_num[2];
    }
    else if (u32InData <= pGmmPara->x_pos[4])
    {
        u32Base = pGmmPara->x_pos[3];
        u32Step = pGmmPara->x_step[4];
        u32IndexBase = pGmmPara->x_num[3];
    }
    else if (u32InData <= pGmmPara->x_pos[5])
    {
        u32Base = pGmmPara->x_pos[4];
        u32Step = pGmmPara->x_step[5];
        u32IndexBase = pGmmPara->x_num[4];
    }
    else if (u32InData <= pGmmPara->x_pos[6])
    {
        u32Base = pGmmPara->x_pos[5];
        u32Step = pGmmPara->x_step[6];
        u32IndexBase = pGmmPara->x_num[5];
    }
    else
    {
        u32Base = pGmmPara->x_pos[6];
        u32Step = pGmmPara->x_step[7];
        u32IndexBase = pGmmPara->x_num[6];
    }

    return HiHDR_LutCal(pGmmPara->lut, u32Base, u32Step, u32IndexBase, pGmmPara->x_pos[7], u32InData);
}

static HI_S32 pq_hal_AdjustBasicTMCore(PQ_HDR_TF_PARA *pstTMParaBasic, PQ_HDR_TF_PARA *pstTMPara,
                                       HI_U16 u16ScaleCoefTM, HI_U32 u32Ratio, HI_U32 u32PeakLuminance, HI_U32 *pu32OutputLut)
{
    HI_U32 i = 0, k = 0;
    static HI_S32 as32OriginalLutPos[64] = { 0 };
    static HI_S32 as32NewLut[64] = { 0 };
    HI_U32 u32TmpNum = 0;
    HI_S32 s32TmpPos = 0;
    HI_U16 u16RatioScale = 9;
    HI_U16 u16BitDepthIn = 21;
    HI_S32 as32NewLutMax;
    HI_S32 s32Input;
    HI_S64 s64Tmp;
    HI_U32 u32ScaleTMFactor = (1 << u16ScaleCoefTM) - 1;
    HI_U32 u32halfScaleRatio = (1 << (u16RatioScale - 1));

    u32Ratio = 205 + 307 * u32Ratio / 100;
    u32Ratio = HDR_CLIP3(0, 512, u32Ratio);
    u32PeakLuminance = 900 + u32PeakLuminance * 7;
    u32PeakLuminance = HDR_CLIP3(500, PQ_MAX_LUMINANCE, u32PeakLuminance);
    as32OriginalLutPos[0] = 1;

    for (i = 1; i < 63; ++i)
    {
        u32TmpNum = i;
        if (u32TmpNum <= pstTMPara->x_num[0])
        {
            s32TmpPos = (1 << pstTMPara->x_step[0]) * u32TmpNum + 1;
        }
        else
        {
            for (k = 1; k < 8; ++k)
            {
                if (u32TmpNum <= pstTMPara->x_num[k])
                {
                    s32TmpPos = pstTMPara->x_pos[k - 1] + (1 << pstTMPara->x_step[k]) * (u32TmpNum - pstTMPara->x_num[k - 1]) + 1;
                    break;
                }
            }
        }
        as32OriginalLutPos[i] = s32TmpPos;
    }

    as32OriginalLutPos[63] = (1 << u16BitDepthIn) - 1;
    as32NewLutMax = HiHDR_TF_8((as32OriginalLutPos[63] * u32Ratio + u32halfScaleRatio) >> u16RatioScale, pstTMParaBasic);
    PQ_CHECK_ZERO_RE_FAIL(as32NewLutMax);

    for (i = 0; i < 64; ++i)
    {
        s32Input = ((as32OriginalLutPos[i] * u32Ratio + u32halfScaleRatio) >> u16RatioScale);
        s64Tmp = HiHDR_TF_8(s32Input, pstTMParaBasic);
        s64Tmp = (s64Tmp * as32OriginalLutPos[63] * u32Ratio + u32halfScaleRatio) >> u16RatioScale;
        if (s32Input <= 0)
        {
            s32Input = 1;
        }
        s64Tmp = div64_s64(div64_s64(s64Tmp, s32Input) * (HI_U64)u32ScaleTMFactor, as32NewLutMax) ;
        as32NewLut[i] = (HI_S32)div64_s64(s64Tmp * u32PeakLuminance , PQ_MAX_LUMINANCE);
    }

    as32NewLut[0] = as32NewLut[1];
    for (i = 0; i < 64; ++i)
    {
        as32NewLut[i] = HDR_CLIP3(0, u32ScaleTMFactor, as32NewLut[i]);
    }

    memcpy(pu32OutputLut, as32NewLut, 64 * sizeof(HI_U32));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_AdjustBasicTM(HI_U32 u32Ratio, HI_U32 u32PeakLuminance, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    PQ_HDR_TF_PARA gs_stTMParaBasic;
    PQ_HDR_TF_PARA gs_stTMPara;
    HI_U32 u32TMLutXStep[8] = {0};
    HI_U32 u32TMLutXNum[8] = {0};
    HI_U32 u32TMLutXPos[8] = {0};
    static HI_U32 g_u32TMLutBasicXStep[8] = {3, 5, 7, 8, 9, 11, 13, 15};
    static HI_U32 g_u32TMLutBasicXNum[8]  = {16, 44, 52, 68, 88, 144, 208, 252};
    static HI_U32 g_u32TMLutBasicXPos[8]  = {128, 1024, 2048, 6144, 16384, 131072, 655360, 2097151};

    PQ_HDR_TF_PARA *pstTMParaBasic = &gs_stTMParaBasic;
    PQ_HDR_TF_PARA *pstTMPara = &gs_stTMPara;

    memcpy(u32TMLutXStep, pstPqHdrCfg->stTMAP.au32StepTM, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
    memcpy(u32TMLutXNum, pstPqHdrCfg->stTMAP.au32NumTM, sizeof(pstPqHdrCfg->stTMAP.au32NumTM));
    memcpy(u32TMLutXPos, pstPqHdrCfg->stTMAP.au32PosTM, sizeof(pstPqHdrCfg->stTMAP.au32PosTM));

    pstTMParaBasic->x_step = g_u32TMLutBasicXStep;
    pstTMParaBasic->x_pos  = g_u32TMLutBasicXPos;
    pstTMParaBasic->x_num  = g_u32TMLutBasicXNum;
    pstTMParaBasic->lut    = g_au32Sdr2HdrTMLutBasicLut;

    pstTMPara->x_step = u32TMLutXStep;
    pstTMPara->x_pos  = u32TMLutXPos;
    pstTMPara->x_num  = u32TMLutXNum;

    return pq_hal_AdjustBasicTMCore(pstTMParaBasic, pstTMPara, u16ScaleCoefTM_SDR2HDR1000, u32Ratio, u32PeakLuminance, pstPqHdrCfg->stTMAP.pu32LUTTM);
}

static HI_S32 pq_hal_SetY2RMatrix(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->stY2R.u16ScaleY2R = u16Y2RScale;

    switch (enInCS)
    {
        case HI_DRV_CS_BT2020_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_2020L,   sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT2020_YUV_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_2020F,   sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT709_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_709L,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT709_YUV_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_709F,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT601_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_601L,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT601_YUV_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_601F,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        case HI_DRV_CS_BT709_RGB_FULL:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_709F,    sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInFull,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
        default:
            memcpy(pstPqHdrCfg->stY2R.as16M33Y2R,   as16Y2RM33_2020L,   sizeof(pstPqHdrCfg->stY2R.as16M33Y2R));
            memcpy(pstPqHdrCfg->stY2R.as16DcInY2R,  as16Y2RDcInLimit,      sizeof(pstPqHdrCfg->stY2R.as16DcInY2R));
            break;
    }

    memcpy(pstPqHdrCfg->stY2R.as16DcOutY2R, as16Y2RDcOut, sizeof(pstPqHdrCfg->stY2R.as16DcOutY2R));
    pstPqHdrCfg->stY2R.u16ClipMinY2R = u16Y2RClipMin;
    pstPqHdrCfg->stY2R.u16ClipMaxY2R = u16Y2RClipMax;

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetGamutMappingPara(HI_DRV_COLOR_SPACE_E enInCS, HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* GamutMapping */
    pstPqHdrCfg->stGMAP.u16ScaleGMAP = u16GMapScale;

    pstPqHdrCfg->stGMAP.u32ClipMinGMAP = u32GMapClipMin;
    pstPqHdrCfg->stGMAP.u32ClipMaxGMAP = u32GMapClipMax;

    if (((HI_DRV_CS_BT2020_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT2020_YUV_FULL == enInCS))
        && ((HI_DRV_CS_BT709_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT709_YUV_FULL == enOutCS)
            || (HI_DRV_CS_BT709_RGB_FULL == enOutCS) )) /* 2020->709 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_2020to709, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT2020_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT2020_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT2020_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT2020_YUV_FULL == enOutCS)))/* 2020->2020 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_linear, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT709_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT709_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT2020_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT2020_YUV_FULL == enOutCS)))/* 709->2020 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_709to2020, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT601_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT601_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT2020_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT2020_YUV_FULL == enOutCS)))/* 601->2020 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMAP_Pal_601_2020, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else if (((HI_DRV_CS_BT601_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT601_YUV_FULL == enInCS))
             && ((HI_DRV_CS_BT709_YUV_LIMITED == enOutCS) || (HI_DRV_CS_BT709_YUV_FULL == enOutCS)))/* 601->709 */
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMAP_Pal_601_709, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }
    else
    {
        memcpy(pstPqHdrCfg->stGMAP.as16M33GMAP, as16M33GMap_linear, sizeof(pstPqHdrCfg->stGMAP.as16M33GMAP));
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetHDRTMap(HI_DRV_COLOR_SPACE_E enInCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->stTMAP.u16ScaleLumaCal  = u16TmScaleLumaCal;
    pstPqHdrCfg->stTMAP.u32MixAlpha      = 0;
    pstPqHdrCfg->stTMAP.u32ScaleMixAlpha = u32TmScaleMixAlpha;

    if ((HI_DRV_CS_BT709_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT709_YUV_FULL == enInCS))
    {
        memcpy(pstPqHdrCfg->stTMAP.au16M3LumaCal, au16TmM3LumaCal_709, sizeof(pstPqHdrCfg->stTMAP.au16M3LumaCal));
    }
    else if ((HI_DRV_CS_BT2020_YUV_LIMITED == enInCS) || (HI_DRV_CS_BT2020_YUV_FULL == enInCS))
    {
        memcpy(pstPqHdrCfg->stTMAP.au16M3LumaCal, au16TmM3LumaCal_2020, sizeof(pstPqHdrCfg->stTMAP.au16M3LumaCal));
    }
    else
    {
        memcpy(pstPqHdrCfg->stTMAP.au16M3LumaCal, au16TmM3LumaCal_601, sizeof(pstPqHdrCfg->stTMAP.au16M3LumaCal));
    }

    pstPqHdrCfg->stTMAP.u32ClipMinTM = u32TmClipMin;
    pstPqHdrCfg->stTMAP.u32ClipMaxTM = u32TmClipMax;
    PQ_SAFE_MEMSET(pstPqHdrCfg->stTMAP.as32TMOff, 0, sizeof(pstPqHdrCfg->stTMAP.as32TMOff));
    pqprint(PQ_PRN_HDR, "HdrMode:%d\n", g_u32HdrMode);

    switch (sg_enHDRMode)
    {
        case HI_PQ_HDR_MODE_HDR10_TO_SDR:
            pstPqHdrCfg->stTMAP.u32MixAlpha      = u32TmMixAlphaHdr2Sdr;
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2SDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HDR10_TO_HDR10:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_Linear;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_Linear, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HDR10_TO_HLG:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HDR2HLG;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HDR2HLG, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HLG_TO_SDR:
            memcpy(pstPqHdrCfg->stTMAP.as32TMOff, as32TMOff_HLG2SDR, sizeof(pstPqHdrCfg->stTMAP.as32TMOff));
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HLG2SDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HLG2SDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HLG_TO_HDR10:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HLG2HDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HLG2HDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HLG_TO_HLG:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_Linear;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_Linear, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SLF_TO_SDR:
        case HI_PQ_HDR_MODE_SLF_TO_HDR10:
        case HI_PQ_HDR_MODE_SLF_TO_HLG:
            HI_ERR_PQ("Wrong Para \n");
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_HLG2HDR;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_HLG2HDR, sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HDR10:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_SDR2HDR1000;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], sizeof(g_au32ToolTmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HLG:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_SDR2HLG;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_SDR2HLG, sizeof(g_au32ToolTmClutTmp));
            break;
        default:
            pstPqHdrCfg->stTMAP.u16ScaleCoefTM = u16ScaleCoefTM_Linear;
            memcpy(pstPqHdrCfg->stTMAP.au32StepTM, au32TMapStep, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
            memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  au32TMapNum,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
            memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  au32TMapPos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
            memcpy(g_au32ToolTmClutTmp, au32TMLut_Linear, sizeof(g_au32ToolTmClutTmp));
            break;
    }

    sg_au16ToolTmScale = pstPqHdrCfg->stTMAP.u16ScaleCoefTM;

    if (0 == sg_u32ToolHdrTmMode)
    {
        memcpy(pstPqHdrCfg->stTMAP.pu32LUTTM, g_au32ToolTmClutTmp, sizeof(pstPqHdrCfg->stTMAP.pu32LUTTM));

        memcpy(g_stToolHdrTmap.au32X_step,  pstPqHdrCfg->stTMAP.au32StepTM, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
        memcpy(g_stToolHdrTmap.au32X_num,   pstPqHdrCfg->stTMAP.au32NumTM,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
        memcpy(g_stToolHdrTmap.au32X_pos,   pstPqHdrCfg->stTMAP.au32PosTM,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
        memcpy(g_stToolHdrTmap.au32Y_LUT,   pstPqHdrCfg->stTMAP.pu32LUTTM,  sizeof(g_stToolHdrTmap.au32Y_LUT));

    }
    else if (1 == sg_u32ToolHdrTmMode)
    {
        memcpy(pstPqHdrCfg->stTMAP.au32StepTM,  g_stToolHdrTmap.au32X_step, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
        memcpy(pstPqHdrCfg->stTMAP.au32NumTM ,  g_stToolHdrTmap.au32X_num,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM ));
        memcpy(pstPqHdrCfg->stTMAP.au32PosTM ,  g_stToolHdrTmap.au32X_pos,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM ));
        memcpy(pstPqHdrCfg->stTMAP.pu32LUTTM,   g_stToolHdrTmap.au32Y_LUT,  sizeof(pstPqHdrCfg->stTMAP.pu32LUTTM));
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetHDRSMap(HI_DRV_COLOR_SPACE_E enInCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* ToneMapping Smap */
    pstPqHdrCfg->stCadj.u16Scale2P = u16SmapScaleCoef;

    switch (sg_enHDRMode)
    {
        case HI_PQ_HDR_MODE_HDR10_TO_SDR:
            memcpy(pstPqHdrCfg->stSMAP.au32StepSM, sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
            memcpy(pstPqHdrCfg->stSMAP.au32NumSM , sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
            memcpy(pstPqHdrCfg->stSMAP.au32PosSM , sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR],  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
            memcpy(g_au32ToolSmClutTmp, sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], sizeof(g_au32ToolSmClutTmp));
            break;
        case HI_PQ_HDR_MODE_HDR10_TO_HDR10:
        case HI_PQ_HDR_MODE_HDR10_TO_HLG:
        case HI_PQ_HDR_MODE_HLG_TO_SDR:
        case HI_PQ_HDR_MODE_HLG_TO_HDR10:
        case HI_PQ_HDR_MODE_HLG_TO_HLG:
            memcpy(pstPqHdrCfg->stSMAP.au32StepSM, au32SMapStep, sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
            memcpy(pstPqHdrCfg->stSMAP.au32NumSM , au32SMapNum,  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
            memcpy(pstPqHdrCfg->stSMAP.au32PosSM , au32SMapPos,  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
            memcpy(g_au32ToolSmClutTmp, au32SMLutLinear, sizeof(pstPqHdrCfg->stSMAP.pu32LUTSM));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HDR10:
            memcpy(pstPqHdrCfg->stSMAP.au32StepSM, sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
            memcpy(pstPqHdrCfg->stSMAP.au32NumSM , sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR],  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
            memcpy(pstPqHdrCfg->stSMAP.au32PosSM , sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR],  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
            memcpy(g_au32ToolSmClutTmp, sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], sizeof(g_au32ToolSmClutTmp));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HLG:
            memcpy(pstPqHdrCfg->stSMAP.au32StepSM, au32SMapStep, sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
            memcpy(pstPqHdrCfg->stSMAP.au32NumSM , au32SMapNum,  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
            memcpy(pstPqHdrCfg->stSMAP.au32PosSM , au32SMapPos,  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
            memcpy(g_au32ToolSmClutTmp, au32SMLutLinear, sizeof(pstPqHdrCfg->stSMAP.pu32LUTSM));
            break;
        default:
            memcpy(pstPqHdrCfg->stSMAP.au32StepSM, au32SMapStep, sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
            memcpy(pstPqHdrCfg->stSMAP.au32NumSM , au32SMapNum,  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
            memcpy(pstPqHdrCfg->stSMAP.au32PosSM , au32SMapPos,  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
            memcpy(g_au32ToolSmClutTmp, au32SMLutLinear, sizeof(pstPqHdrCfg->stSMAP.pu32LUTSM));
            break;
    }

    sg_au16ToolSmScale = pstPqHdrCfg->stCadj.u16Scale2P;

    if (0 == sg_u32ToolHdrSmMode)
    {
        memcpy(pstPqHdrCfg->stSMAP.pu32LUTSM, g_au32ToolSmClutTmp, sizeof(pstPqHdrCfg->stSMAP.pu32LUTSM));

        memcpy(g_stToolHdrSmap.au32X_step,  pstPqHdrCfg->stSMAP.au32StepSM, sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
        memcpy(g_stToolHdrSmap.au32X_num,   pstPqHdrCfg->stSMAP.au32NumSM,  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
        memcpy(g_stToolHdrSmap.au32X_pos,   pstPqHdrCfg->stSMAP.au32PosSM,  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
        /* only copy 32 u32 */
        memcpy(g_stToolHdrSmap.au32Y_LUT,   pstPqHdrCfg->stSMAP.pu32LUTSM,  sizeof(pstPqHdrCfg->stSMAP.pu32LUTSM));
    }
    else if (1 == sg_u32ToolHdrSmMode)
    {
        memcpy(pstPqHdrCfg->stSMAP.au32StepSM,  g_stToolHdrSmap.au32X_step, sizeof(pstPqHdrCfg->stSMAP.au32StepSM));
        memcpy(pstPqHdrCfg->stSMAP.au32NumSM ,  g_stToolHdrSmap.au32X_num,  sizeof(pstPqHdrCfg->stSMAP.au32NumSM ));
        memcpy(pstPqHdrCfg->stSMAP.au32PosSM ,  g_stToolHdrSmap.au32X_pos,  sizeof(pstPqHdrCfg->stSMAP.au32PosSM ));
        /* only copy 32 u32 */
        memcpy(pstPqHdrCfg->stSMAP.pu32LUTSM,   g_stToolHdrSmap.au32Y_LUT,  sizeof(pstPqHdrCfg->stSMAP.pu32LUTSM));
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_SetR2YMatrix(HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* RGB2YUV */
    pstPqHdrCfg->stR2Y.u16ScaleR2Y = u16ScaleR2Y;

    switch (enOutCS)
    {
        case HI_DRV_CS_BT2020_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_2020NCL, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YL_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YL_UV;
            break;
        case HI_DRV_CS_BT2020_YUV_FULL:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YF_2020NCL, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YF,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YF, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YF_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YF_UV;
            break;
        case HI_DRV_CS_BT709_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_709, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YL_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YL_UV;
            break;
        case HI_DRV_CS_BT709_YUV_FULL:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YF_709, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YF,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YF, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YF_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YF_UV;
            break;
        case HI_DRV_CS_BT601_YUV_LIMITED:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_601, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YL_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YL_UV;
            break;
        case HI_DRV_CS_BT601_YUV_FULL:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YF_601, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YF,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YF, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YF_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YF_UV;
            break;
        case HI_DRV_CS_BT2020_RGB_FULL: /*R2R */
        case HI_DRV_CS_BT709_RGB_FULL: /*R2R */
        case HI_DRV_CS_BT601_RGB_FULL: /*R2R */
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2RF,   sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2RF,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2RF, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2RF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2RF_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2RF_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2RF_UV;
            /* RGB out close R2Y, Sm */
            pstPqHdrCfg->stR2Y.u16ScaleR2Y = u16ScaleRF2RF;
            pstPqHdrCfg->bR2YEn         = HI_FALSE;
            pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
            break;
        default:
            memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   as16M33RF2YL_709, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcInR2Y,  as16DcInRF2YL,  sizeof(pstPqHdrCfg->stR2Y.as16DcInR2Y));
            memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, as16DcOutRF2YL, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_Y  = u16ClipMinRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_Y  = u16ClipMaxRF2YL_Y;
            pstPqHdrCfg->stR2Y.u16ClipMinR2Y_UV = u16ClipMinRF2YL_UV;
            pstPqHdrCfg->stR2Y.u16ClipMaxR2Y_UV = u16ClipMaxRF2YL_UV;
            break;
    }

    return HI_SUCCESS;
}

static HI_S32 pq_hal_AdjustHDRTmCurve(HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_S8 i;
    pstPqHdrCfg->stTMAP.u16ScaleLumaCal = u16TmScaleLumaCal;
    if (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] < 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (50 - g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * au32TMLut_HDR2SDR_b0[i]) / 50;
        }
    }
    else if (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] > 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = ((100 - g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] - 50) * au32TMLut_HDR2SDR_b100[i]) / 50;
        }
    }

    if (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] < 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (50 - g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * au32TMLut_HDR2SDR_d0[i]) / 50;
        }
    }
    else if (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] > 50)
    {
        for (i = 0; i < 64; i++)
        {
            pstPqHdrCfg->stTMAP.pu32LUTTM[i] = ((100 - g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]) * pstPqHdrCfg->stTMAP.pu32LUTTM[i]
                                                + (g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR] - 50) * au32TMLut_HDR2SDR_d100[i]) / 50;
        }
    }
    pqprint(PQ_PRN_HDR, "Curve_para:M:%d,AccD:%d,AccB:%d,D:%d,B:%d\n", \
            g_u32HdrMode[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32ACCDarkStr[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32ACCBrightStr[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32DarkCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR],
            g_u32BrightCvStr[HI_PQ_HDR_MODE_HDR10_TO_SDR]);

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHDR2HDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* WCG */
    if (enInCS != enOutCS)
    {
        pstPqHdrCfg->bY2REn         = HI_TRUE;
        pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
        pstPqHdrCfg->bV1Y2REn       = HI_TRUE;
        pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
        pstPqHdrCfg->bDegammaEn     = HI_TRUE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_TRUE;
        pstPqHdrCfg->bGammaEn       = HI_TRUE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_TRUE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;
        pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
        pstPqHdrCfg->bV0CLEn        = HI_FALSE;
        pstPqHdrCfg->bV1CLEn        = HI_FALSE;

        pstPqHdrCfg->bGMapPosSel    = HI_TRUE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }
    else
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bV0Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV0HdrEn       = HI_FALSE;
        pstPqHdrCfg->bDegammaEn     = HI_FALSE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_FALSE;
        pstPqHdrCfg->bGammaEn       = HI_FALSE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_FALSE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;
        pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
        pstPqHdrCfg->bV0CLEn        = HI_FALSE;
        pstPqHdrCfg->bV1CLEn        = HI_FALSE;

        pstPqHdrCfg->bGMapPosSel    = HI_FALSE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step, au32DeGmm_step, sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos,  au32DeGmm_pos,  sizeof(pstPqHdrCfg->stDeGmm.au32Pos));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num,  au32DeGmm_num,  sizeof(pstPqHdrCfg->stDeGmm.au32Num));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT,  au32DeGmmLut_PQ, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos));
    memcpy(pstPqHdrCfg->stGmm.au32Num,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT,  au32GmmLut_PQ10000, sizeof(pstPqHdrCfg->stGmm.pu32LUT));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHDR2SDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HiPP_HDR_DYN_TM stStcTm = {0};
    HiPP_HDR_DYN_TM stDynTm = {0};
    HI_PQ_HDR_DYN_TM_TUNING_S stDynTmTool = {0};
    HiPP_HDR_DYN_ACC_DETAIL stDynAccDetail = {0};

    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
    pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_FALSE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_TRUE;
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;
    pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
    pstPqHdrCfg->bV0CLEn        = HI_FALSE;
    pstPqHdrCfg->bV1CLEn        = HI_FALSE;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step, au32DeGmm_step, sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos,  au32DeGmm_pos,  sizeof(pstPqHdrCfg->stDeGmm.au32Pos));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num,  au32DeGmm_num,  sizeof(pstPqHdrCfg->stDeGmm.au32Num));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT,  au32DeGmmLut_PQ, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Tmap  adjust with Dark & Bright */
    pq_hal_AdjustHDRTmCurve(pstPqHdrCfg);

    /* ToneMapping Tmap  adjust with acc histgram*/
    if ((1 == pstLayerRegionInfo->u32WindowNum) && (HI_PQ_XDR_LAYER_ID_0 == pstLayerRegionInfo->enPqXdrLayerId))
    {
        /*---------------------------------------------------------------------*/
        /* ToneMapping Tmap  adjust with acc histgram*/
        /* ACC Alg in */
        stStcTm.u16TmScaleCoef = pstPqHdrCfg->stTMAP.u16ScaleCoefTM;
        memcpy(stStcTm.stTM.au32StepTM, pstPqHdrCfg->stTMAP.au32StepTM, sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
        memcpy(stStcTm.stTM.au32PosTM,  pstPqHdrCfg->stTMAP.au32PosTM,  sizeof(pstPqHdrCfg->stTMAP.au32PosTM));
        memcpy(stStcTm.stTM.au32NumTM,  pstPqHdrCfg->stTMAP.au32NumTM,  sizeof(pstPqHdrCfg->stTMAP.au32NumTM));
        memcpy(stStcTm.stTM.pu32LUTTM,  pstPqHdrCfg->stTMAP.pu32LUTTM,  sizeof(pstPqHdrCfg->stTMAP.pu32LUTTM));

        /* ACC tool in */
        memcpy(&stDynTmTool, &(sg_stHdrDynBinOrCode.astHdrDynTuning), sizeof(stDynTmTool));

        /* ACC ui ctrl in */
        stDynAccDetail.u32BrightDetailPro = g_u32ACCBrightStr[HI_PQ_HDR_MODE_HDR10_TO_SDR];
        stDynAccDetail.u32DarkDetailPro   = g_u32ACCDarkStr[HI_PQ_HDR_MODE_HDR10_TO_SDR];

        HippHdrDynTM(&stStcTm, &stDynTmTool, &stDynAccDetail, &stDynTm);

        memcpy(pstPqHdrCfg->stTMAP.au32StepTM, stDynTm.stTM.au32StepTM,  sizeof(pstPqHdrCfg->stTMAP.au32StepTM));
        memcpy(pstPqHdrCfg->stTMAP.au32PosTM,  stDynTm.stTM.au32PosTM,   sizeof(pstPqHdrCfg->stTMAP.au32PosTM));
        memcpy(pstPqHdrCfg->stTMAP.au32NumTM,  stDynTm.stTM.au32NumTM,   sizeof(pstPqHdrCfg->stTMAP.au32NumTM));
        memcpy(pstPqHdrCfg->stTMAP.pu32LUTTM,  stDynTm.stTM.pu32LUTTM,   sizeof(pstPqHdrCfg->stTMAP.pu32LUTTM));
    }
    /*---------------------------------------------------------------------*/

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos));
    memcpy(pstPqHdrCfg->stGmm.au32Num,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT,  au32GmmLut_22,  sizeof(pstPqHdrCfg->stGmm.pu32LUT));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);

    /* Hdr Offset Adjust */
    PQ_hal_HdrOffsetCalCSCCoefRGBtoYCbCr(HI_PQ_HDR_MODE_HDR10_TO_SDR,
                                         g_u32HdrOffsetContrast[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetSatu[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetHue[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetRed[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetGreen[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         g_u32HdrOffsetBlue[HI_PQ_HDR_MODE_HDR10_TO_SDR],
                                         pstPqHdrCfg->stR2Y.as16M33R2Y,
                                         g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_HDR10_TO_SDR]);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_HDR10_TO_SDR], sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR], pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] +
            (g_u32HdrOffsetBright[HI_PQ_HDR_MODE_HDR10_TO_SDR] - 128) * 4;

    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR][0] + (g_u32Bright - 128) * 4;

    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_HDR10_TO_SDR], sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHDR2HLGCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
    pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_TRUE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_TRUE;
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;
    pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
    pstPqHdrCfg->bV0CLEn        = HI_FALSE;
    pstPqHdrCfg->bV1CLEn        = HI_FALSE;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step, au32DeGmm_step, sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos,  au32DeGmm_pos,  sizeof(pstPqHdrCfg->stDeGmm.au32Pos));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num,  au32DeGmm_num,  sizeof(pstPqHdrCfg->stDeGmm.au32Num));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT,  au32DeGmmLut_PQ, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos));
    memcpy(pstPqHdrCfg->stGmm.au32Num,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT,  au32GmmLut_HLG,  sizeof(pstPqHdrCfg->stGmm.pu32LUT));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

HI_S32 pq_hal_GetHLG2SDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                            HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bV0Y2REn       = HI_TRUE;

    pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_TRUE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;
    pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
    pstPqHdrCfg->bV0CLEn        = HI_FALSE;
    pstPqHdrCfg->bV1CLEn        = HI_FALSE;
    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step, au32DeGmm_step,   sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos , au32DeGmm_pos,    sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num , au32DeGmm_num,    sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT , au32DeGmmLut_HLG, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep,  sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_22,     sizeof(pstPqHdrCfg->stGmm.pu32LUT ));
    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHLG2HDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
    pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_TRUE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;
    pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
    pstPqHdrCfg->bV0CLEn        = HI_FALSE;
    pstPqHdrCfg->bV1CLEn        = HI_FALSE;

    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step, au32DeGmm_step,   sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_HLG, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos, sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum, sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_PQ1250, sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetHLG2HLGCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* WCG */
    if (enInCS != enOutCS)
    {
        pstPqHdrCfg->bY2REn         = HI_TRUE;
        pstPqHdrCfg->bV0Y2REn       = HI_TRUE;  /*96add */
        pstPqHdrCfg->bV1Y2REn       = HI_TRUE; /*96add */
        pstPqHdrCfg->bV0HdrEn       = HI_TRUE; /*96add */
        pstPqHdrCfg->bDegammaEn     = HI_TRUE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_TRUE;
        pstPqHdrCfg->bGammaEn       = HI_TRUE;
        pstPqHdrCfg->bDitherEn      = HI_TRUE;
        pstPqHdrCfg->bR2YEn         = HI_TRUE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /*96add */
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /*96add */
        pstPqHdrCfg->bR2YPipEn      = HI_FALSE;  /*96add */
        pstPqHdrCfg->bV0CLEn        = HI_FALSE;  /*96add */
        pstPqHdrCfg->bV1CLEn        = HI_FALSE;  /*96add */

        pstPqHdrCfg->bGMapPosSel    = HI_TRUE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }
    else
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bV0Y2REn       = HI_FALSE;  /*96add */
        pstPqHdrCfg->bV1Y2REn       = HI_FALSE; /*96add */
        pstPqHdrCfg->bV0HdrEn       = HI_FALSE; /*96add */
        pstPqHdrCfg->bDegammaEn     = HI_FALSE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_FALSE;
        pstPqHdrCfg->bGammaEn       = HI_FALSE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_FALSE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;  /*96add */
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;  /*96add */
        pstPqHdrCfg->bR2YPipEn      = HI_FALSE;  /*96add */
        pstPqHdrCfg->bV0CLEn        = HI_FALSE;  /*96add */
        pstPqHdrCfg->bV1CLEn        = HI_FALSE;  /*96add */

        pstPqHdrCfg->bGMapPosSel    = HI_FALSE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_HLG, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step, au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos , au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num , au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT , au32GmmLut_HLG,    sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSDR2HDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_U32 u32Ratio, u32PeakLuminance;
    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
    pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_TRUE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_TRUE;
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;
    pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
    pstPqHdrCfg->bV0CLEn        = HI_FALSE;
    pstPqHdrCfg->bV1CLEn        = HI_FALSE;

    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* rgb in close y2r  */
    if (HI_DRV_CS_BT709_RGB_FULL == enInCS)
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bV0Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_24, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* SDR2HDR Soft Alg */
    u32Ratio         = g_u32BrightCvStr[HI_PQ_HDR_MODE_SDR_TO_HDR10];
    u32PeakLuminance = g_u32DarkCvStr[HI_PQ_HDR_MODE_SDR_TO_HDR10];
    pq_hal_AdjustBasicTM(u32Ratio, u32PeakLuminance, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_PQ1600, sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);

    /* Hdr Offset Adjust */
    PQ_hal_HdrOffsetCalCSCCoefRGBtoYCbCr(HI_PQ_HDR_MODE_SDR_TO_HDR10,
                                         g_u32HdrOffsetContrast[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetSatu[HI_PQ_HDR_MODE_SDR_TO_HDR10] * 125 / 100,
                                         g_u32HdrOffsetHue[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetRed[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetGreen[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         g_u32HdrOffsetBlue[HI_PQ_HDR_MODE_SDR_TO_HDR10],
                                         pstPqHdrCfg->stR2Y.as16M33R2Y,
                                         g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_SDR_TO_HDR10]);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstHdrOffsetCSCTable[HI_PQ_HDR_MODE_SDR_TO_HDR10], sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10], pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10]));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] +
            (g_u32HdrOffsetBright[HI_PQ_HDR_MODE_SDR_TO_HDR10] - 128) * 4;

    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);

    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] = g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10][0] + (g_u32Bright - 128) * 4;

    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16HdrOffsetDcOutR2Y[HI_PQ_HDR_MODE_SDR_TO_HDR10], sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSDR2HLGCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    pstPqHdrCfg->bY2REn         = HI_TRUE;
    pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
    pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
    pstPqHdrCfg->bDegammaEn     = HI_TRUE;
    pstPqHdrCfg->bTMapEn        = HI_TRUE;
    pstPqHdrCfg->bGMapEn        = HI_TRUE;
    pstPqHdrCfg->bGammaEn       = HI_TRUE;
    pstPqHdrCfg->bDitherEn      = HI_TRUE;
    pstPqHdrCfg->bR2YEn         = HI_TRUE;
    pstPqHdrCfg->bChromaAdjEn   = HI_TRUE;
    pstPqHdrCfg->bBT2020CL      = HI_FALSE;
    pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
    pstPqHdrCfg->bV0CLEn        = HI_FALSE;
    pstPqHdrCfg->bV1CLEn        = HI_FALSE;

    pstPqHdrCfg->bGMapPosSel    = HI_TRUE;
    pstPqHdrCfg->bDitherMode    = HI_TRUE;

    /* rgb in close y2r  */
    if (HI_DRV_CS_BT709_RGB_FULL == enInCS)
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bV0Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    }

    /* YUV2RGB */
    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_24, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_HLG, sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSDR2SDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    /* WCG */
    if (enInCS != enOutCS)
    {
        pstPqHdrCfg->bY2REn         = HI_TRUE;
        pstPqHdrCfg->bV0Y2REn       = HI_TRUE;
        pstPqHdrCfg->bV1Y2REn       = HI_TRUE;
        pstPqHdrCfg->bV0HdrEn       = HI_TRUE;
        pstPqHdrCfg->bDegammaEn     = HI_TRUE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_TRUE;
        pstPqHdrCfg->bGammaEn       = HI_TRUE;
        pstPqHdrCfg->bDitherEn      = HI_TRUE;
        pstPqHdrCfg->bR2YEn         = HI_TRUE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;
        pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
        pstPqHdrCfg->bV0CLEn        = HI_FALSE;
        pstPqHdrCfg->bV1CLEn        = HI_FALSE;

        pstPqHdrCfg->bGMapPosSel    = HI_TRUE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_TRUE;
    }
    else
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bV0Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV0HdrEn       = HI_FALSE;
        pstPqHdrCfg->bDegammaEn     = HI_FALSE;
        pstPqHdrCfg->bTMapEn        = HI_FALSE;
        pstPqHdrCfg->bGMapEn        = HI_FALSE;
        pstPqHdrCfg->bGammaEn       = HI_FALSE;
        pstPqHdrCfg->bDitherEn      = HI_FALSE;
        pstPqHdrCfg->bR2YEn         = HI_FALSE;
        pstPqHdrCfg->bChromaAdjEn   = HI_FALSE;
        pstPqHdrCfg->bBT2020CL      = HI_FALSE;
        pstPqHdrCfg->bR2YPipEn      = HI_FALSE;
        pstPqHdrCfg->bV0CLEn        = HI_FALSE;
        pstPqHdrCfg->bV1CLEn        = HI_FALSE;

        pstPqHdrCfg->bGMapPosSel    = HI_FALSE;   /* true : gmapping after tmap; false : gmapping before tmap*/
        pstPqHdrCfg->bDitherMode    = HI_FALSE;
    }

    /* rgb in close y2r  */
    if (HI_DRV_CS_BT709_RGB_FULL == enInCS)
    {
        pstPqHdrCfg->bY2REn         = HI_FALSE;
        pstPqHdrCfg->bV0Y2REn       = HI_FALSE;
        pstPqHdrCfg->bV1Y2REn       = HI_FALSE;
    }

    pq_hal_SetY2RMatrix(enInCS, enOutCS, pstPqHdrCfg);

    /* DeGamma */
    memcpy(pstPqHdrCfg->stDeGmm.au32Step,  au32DeGmm_step,  sizeof(pstPqHdrCfg->stDeGmm.au32Step));
    memcpy(pstPqHdrCfg->stDeGmm.au32Pos ,  au32DeGmm_pos,   sizeof(pstPqHdrCfg->stDeGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stDeGmm.au32Num ,  au32DeGmm_num,   sizeof(pstPqHdrCfg->stDeGmm.au32Num ));
    memcpy(pstPqHdrCfg->stDeGmm.pu32LUT ,  au32DeGmmLut_22, sizeof(pstPqHdrCfg->stDeGmm.pu32LUT ));

    /* ToneMapping Tmap */
    pq_hal_SetHDRTMap(enInCS, pstPqHdrCfg);

    /* ToneMapping Smap */
    pq_hal_SetHDRSMap(enInCS, pstPqHdrCfg);

    /* GamutMapping */
    pq_hal_SetGamutMappingPara(enInCS, enOutCS, pstPqHdrCfg);

    /*  Gamma */
    memcpy(pstPqHdrCfg->stGmm.au32Step,  au32GmmStep, sizeof(pstPqHdrCfg->stGmm.au32Step));
    memcpy(pstPqHdrCfg->stGmm.au32Pos ,  au32GmmPos,  sizeof(pstPqHdrCfg->stGmm.au32Pos ));
    memcpy(pstPqHdrCfg->stGmm.au32Num ,  au32GmmNum,  sizeof(pstPqHdrCfg->stGmm.au32Num ));
    memcpy(pstPqHdrCfg->stGmm.pu32LUT ,  au32GmmLut_22,     sizeof(pstPqHdrCfg->stGmm.pu32LUT ));

    /* RGB2YUV */
    pq_hal_SetR2YMatrix(enOutCS, pstPqHdrCfg);
    /* Hdr Normal Adjust */
    PQ_hal_CalCSCCoefRGBtoYCbCr(g_u32Contrast, g_u32Satu, g_u32Hue,
                                g_u32Red, g_u32Green, g_u32Blue, pstPqHdrCfg->stR2Y.as16M33R2Y, g_aDstCSCTable);
    memcpy(pstPqHdrCfg->stR2Y.as16M33R2Y,   g_aDstCSCTable, sizeof(pstPqHdrCfg->stR2Y.as16M33R2Y));

    memcpy(g_as16DcOutR2Y, pstPqHdrCfg->stR2Y.as16DcOutR2Y, sizeof(g_as16DcOutR2Y));
    g_as16DcOutR2Y[0] = g_as16DcOutR2Y[0] + (g_u32Bright - 128) * 4;
    memcpy(pstPqHdrCfg->stR2Y.as16DcOutR2Y, g_as16DcOutR2Y, sizeof(pstPqHdrCfg->stR2Y.as16DcOutR2Y));

    return HI_SUCCESS;
}

static HI_S32 pq_hal_GetSLF2SDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_UNUSED(enInCS);
    HI_UNUSED(enOutCS);

    return HI_FAILURE;
}

static HI_S32 pq_hal_GetSLF2HDRCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_UNUSED(enInCS);
    HI_UNUSED(enOutCS);

    return HI_FAILURE;
}

static HI_S32 pq_hal_GetSLF2HLGCfg(HI_PQ_XDR_LAYER_REGION_S *pstLayerRegionInfo, HI_DRV_COLOR_SPACE_E enInCS,
                                   HI_DRV_COLOR_SPACE_E enOutCS, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_UNUSED(enInCS);
    HI_UNUSED(enOutCS);

    return HI_FAILURE;
}

PF_PQ_Hal_GetHdrPathCfg pfPqHalGetHdrPathCfg[HI_PQ_HDR_MODE_BUTT] =
{
    pq_hal_GetHDR2SDRCfg,
    pq_hal_GetHDR2HDRCfg,
    pq_hal_GetHDR2HLGCfg,

    pq_hal_GetHLG2SDRCfg,
    pq_hal_GetHLG2HDRCfg,
    pq_hal_GetHLG2HLGCfg,

    pq_hal_GetSLF2SDRCfg,
    pq_hal_GetSLF2HDRCfg,
    pq_hal_GetSLF2HLGCfg,

    pq_hal_GetSDR2SDRCfg,
    pq_hal_GetSDR2HDRCfg,
    pq_hal_GetSDR2HLGCfg,
};

HI_S32 PQ_HAL_GetHDRCfg(HI_PQ_XDR_FRAME_INFO *pstXdrFrameInfo, HI_PQ_HDR_CFG *pstPqHdrCfg)
{
    HI_S32 s32Ret = HI_SUCCESS;

    PQ_CHECK_NULL_PTR_RE_FAIL(pstXdrFrameInfo);
    PQ_CHECK_NULL_PTR_RE_FAIL(pstPqHdrCfg);
    PQ_CHECK_OVER_RANGE_RE_FAIL(pstXdrFrameInfo->enSrcFrameType, HI_DRV_VIDEO_FRAME_TYPE_BUTT);
    PQ_CHECK_OVER_RANGE_RE_FAIL(pstXdrFrameInfo->enDispType, HI_PQ_DISP_TYPE_BUTT);
    PQ_CHECK_OVER_RANGE_RE_FAIL(pstXdrFrameInfo->stLayerRegionInfo.enPqXdrLayerId, HI_PQ_XDR_LAYER_ID_BUTT);

    pg_stPqHdrCfg = pstPqHdrCfg;

    stDminfo.u32SrcMaxPQ = pstXdrFrameInfo->unHDRInfo.stHDR10Info.stMasteringInfo.u32MaxDisplayMasteringLuminance;
    stDminfo.u32SrcMinPQ = pstXdrFrameInfo->unHDRInfo.stHDR10Info.stMasteringInfo.u32MinDisplayMasteringLuminance;

    sg_enHDRMode = aenPqHalHdrPathMode[pstXdrFrameInfo->enSrcFrameType][pstXdrFrameInfo->enDispType];

    PQ_CHECK_OVER_RANGE_RE_FAIL(sg_enHDRMode, HI_PQ_HDR_MODE_BUTT);

    s32Ret  = pfPqHalGetHdrPathCfg[sg_enHDRMode](&pstXdrFrameInfo->stLayerRegionInfo, pstXdrFrameInfo->enInCS, pstXdrFrameInfo->enOutCS, pstPqHdrCfg);

    return s32Ret;
}

HI_S32 PQ_HAL_InitHDR(PQ_PARAM_S *pstPqParam, HI_BOOL bParaUseTableDefault)
{
    HI_U32 u32StepBinSum0 = 0;
    HI_U32 u32StepBinSum1 = 0;
    HI_U32 u32NumBinSum0  = 0;
    HI_U32 u32NumBinSum1  = 0;
    HI_U32 u32PosBinSum0  = 0;
    HI_U32 u32PosBinSum1  = 0;
    HI_U32 u32TmapBinSum0 = 0;
    HI_U32 u32TmapBinSum1 = 0;

    HI_U32 u32SmStepBinSum0 = 0;
    HI_U32 u32SmStepBinSum1 = 0;
    HI_U32 u32SmNumBinSum0  = 0;
    HI_U32 u32SmNumBinSum1  = 0;
    HI_U32 u32SmPosBinSum0  = 0;
    HI_U32 u32SmPosBinSum1  = 0;
    HI_U32 u32SmBinSum0 = 0;
    HI_U32 u32SmBinSum1 = 0;

    HI_U32 u32DynTuningBinSum0 = 0;
    HI_U32 i = 0;

    sg_pstHdrBinPara = pstPqParam;

    PQ_CHECK_NULL_PTR_RE_FAIL(sg_pstHdrBinPara);

    /* step 1 : check pq bin data : all zero means no effective para from bin */
    /* check pq bin data */
    for (i = 0; i < 8; i++)
    {
        //Tmap
        u32StepBinSum0 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_HDR2SDR][i];
        u32StepBinSum1 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_SDR2HDR][i];
        u32NumBinSum0  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_HDR2SDR][i];
        u32NumBinSum1  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_SDR2HDR][i];
        u32PosBinSum0  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_HDR2SDR][i];
        u32PosBinSum1  += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_SDR2HDR][i];
        u32TmapBinSum0 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_HDR2SDR][i];
        u32TmapBinSum1 += sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_SDR2HDR][i];
        //Smap
        u32SmStepBinSum0 += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Step[PQ_TOOL_HDR2SDR][i];
        u32SmStepBinSum1 += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Step[PQ_TOOL_SDR2HDR][i];
        u32SmNumBinSum0  += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Num[PQ_TOOL_HDR2SDR][i];
        u32SmNumBinSum1  += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Num[PQ_TOOL_SDR2HDR][i];
        u32SmPosBinSum0  += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Pos[PQ_TOOL_HDR2SDR][i];
        u32SmPosBinSum1  += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Pos[PQ_TOOL_SDR2HDR][i];
        u32SmBinSum0     += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Clut[PQ_TOOL_HDR2SDR][i];
        u32SmBinSum1     += sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Clut[PQ_TOOL_SDR2HDR][i];
    }

    u32DynTuningBinSum0 = sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32MaxLumiDisplay
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32DarkDetailGain
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32DarkDetailGmm
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32BrightDetailGain
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32BrightDetailGmm
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32DynTmGain
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32DynTmGmm
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32DarkSceneDynTM
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32DarkLimit
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32BleachingLevel
                          + sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning.u32TemporalSmooth;

    /* step 2 : para use from bin or code */
    /*
        1.use bin para : if bin para not all zero
        2.use code para : if bin para all zero or no bin exist
    */

    /* HDR2SDR : use bin para && bin step para not all 0 */
    /* Tmap step */
    if ((HI_TRUE != bParaUseTableDefault) && (u32StepBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], au32TMapStep, sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR]));
    }

    /* Tmap num */
    if ((HI_TRUE != bParaUseTableDefault) && (u32NumBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR], au32TMapNum, sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR]));
    }

    /* Tmap pos */
    if ((HI_TRUE != bParaUseTableDefault) && (u32PosBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR], au32TMapPos, sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR]));
    }

    /* tmap */
    if ((HI_TRUE != bParaUseTableDefault) && (u32TmapBinSum0 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], au32TMLut_HDR2SDR_1200, sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR]));
    }

    /* HDR2SDR : use bin para && bin step para not all 0 */
    /* Smap step */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmStepBinSum0 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Step[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR], au32SMapStep, sizeof(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_HDR2SDR]));
    }

    /* Smap num */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmNumBinSum0 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Num[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR], au32SMapNum, sizeof(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_HDR2SDR]));
    }

    /* Smap pos */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmPosBinSum0 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Pos[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR], au32SMapPos, sizeof(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_HDR2SDR]));
    }

    /* Smap */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmBinSum0 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Clut[PQ_TOOL_HDR2SDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_HDR2SDR], au32SMLut_HDR2SDR, sizeof(au32SMLut_HDR2SDR));//only 32 segment
    }

    /* SDR2HDR : use bin para && bin step para not all 0 */
    /* Tmap step */
    if ((HI_TRUE != bParaUseTableDefault) && (u32StepBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], au32TMapStep, sizeof(sg_stHdrTmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR]));
    }

    /* Tmap num */
    if ((HI_TRUE != bParaUseTableDefault) && (u32NumBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR], au32TMapNum, sizeof(sg_stHdrTmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR]));
    }

    /* Tmap pos */
    if ((HI_TRUE != bParaUseTableDefault) && (u32PosBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR], au32TMapPos, sizeof(sg_stHdrTmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR]));
    }

    /* tmap */
    if ((HI_TRUE != bParaUseTableDefault) && (u32TmapBinSum1 != 0))
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], au32TMLut_SDR2HDR1000, sizeof(sg_stHdrTmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR]));
    }

    /* SDR2HDR : use bin para && bin step para not all 0 */
    /* Smap step */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmStepBinSum1 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Step[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR], au32SMapStep, sizeof(sg_stHdrSmClutBinOrCode.au32Step[PQ_TOOL_SDR2HDR]));
    }

    /* Smap num */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmNumBinSum1 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Num[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR], au32SMapNum, sizeof(sg_stHdrSmClutBinOrCode.au32Num[PQ_TOOL_SDR2HDR]));
    }

    /* Smap pos */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmPosBinSum1 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Pos[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR], au32SMapPos, sizeof(sg_stHdrSmClutBinOrCode.au32Pos[PQ_TOOL_SDR2HDR]));
    }

    /* Smap */
    if ((HI_TRUE != bParaUseTableDefault) && (u32SmBinSum1 != 0))
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Clut[PQ_TOOL_SDR2HDR], \
               sizeof(sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR]));
    }
    else
    {
        memcpy(sg_stHdrSmClutBinOrCode.au32Clut[PQ_TOOL_SDR2HDR], au32SMLutLinear, sizeof(au32SMLutLinear));//only 32 segment
    }

    /* HDR2SDR : dyn use bin para && bin para not all 0 */
    if ((HI_TRUE != bParaUseTableDefault) && (u32DynTuningBinSum0 != 0))
    {
        memcpy(&(sg_stHdrDynBinOrCode.astHdrDynTuning), &(sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning), \
               sizeof(sg_stHdrDynBinOrCode.astHdrDynTuning));
    }
    else
    {
        memcpy(&(sg_stHdrDynBinOrCode.astHdrDynTuning), &sg_stHdrDynTmTuningInit, sizeof(sg_stHdrDynBinOrCode.astHdrDynTuning));
    }

    /* dyn init tmap clut */
    memcpy(g_u32PrevTMLut, au32TMLut_HDR2SDR_1200, sizeof(g_au32ToolTmClutTmp));

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHDRParaMode(HI_PQ_HDR_PARA_MODE_S *pstMode)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstMode);

    sg_u32ToolHdrTmMode = pstMode->u32HdrTmMode;
    sg_u32ToolHdrSmMode = pstMode->u32HdrSmMode;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHDRParaMode(HI_PQ_HDR_PARA_MODE_S *pstMode)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstMode);

    pstMode->u32HdrTmMode = sg_u32ToolHdrTmMode;
    pstMode->u32HdrSmMode = sg_u32ToolHdrSmMode;

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHdrDynCfg(HI_PQ_HDR_DYN_TM_TUNING_S *pstMode)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstMode);

    memcpy(&(sg_stHdrDynBinOrCode.astHdrDynTuning), pstMode, sizeof(HI_PQ_HDR_DYN_TM_TUNING_S));

    /* copy para from tool to parabin for save para later */
    memcpy(&(sg_pstHdrBinPara->stPQCoef.stHdrDynCfg.astHdrDynTuning), pstMode , sizeof(HI_PQ_HDR_DYN_TM_TUNING_S));
    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHdrDynCfg(HI_PQ_HDR_DYN_TM_TUNING_S *pstMode)
{
    PQ_CHECK_NULL_PTR_RE_FAIL(pstMode);

    memcpy(pstMode, &(sg_stHdrDynBinOrCode.astHdrDynTuning), sizeof(HI_PQ_HDR_DYN_TM_TUNING_S));

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHdrTMap(HI_PQ_HDR_TMAP_S *pstHdrTmap)
{
    HI_U32 i;

    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrTmap);

    memcpy(&g_stToolHdrTmap, pstHdrTmap, sizeof(g_stToolHdrTmap));

    /* Tool Send Clut * 2^16 */
    for (i = 0; i <  64; i++)
    {
        g_stToolHdrTmap.au32Y_LUT[i] = HDR_CLIP3(0, 65535, g_stToolHdrTmap.au32Y_LUT[i] >> (16 - sg_au16ToolTmScale));
    }

    switch (sg_enHDRMode)
    {
        case HI_PQ_HDR_MODE_HDR10_TO_SDR:
            /* Tmap Clut First Para = 0 */
            g_stToolHdrTmap.au32Y_LUT[0] = 0;

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_HDR2SDR], g_stToolHdrTmap.au32X_step, sizeof(g_stToolHdrTmap.au32X_step));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_HDR2SDR],  g_stToolHdrTmap.au32X_num,  sizeof(g_stToolHdrTmap.au32X_num));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_HDR2SDR],  g_stToolHdrTmap.au32X_pos,  sizeof(g_stToolHdrTmap.au32X_pos));

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_HDR2SDR], g_stToolHdrTmap.au32Y_LUT,  sizeof(g_stToolHdrTmap.au32Y_LUT));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HDR10:
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Step[PQ_TOOL_SDR2HDR], g_stToolHdrTmap.au32X_step, sizeof(g_stToolHdrTmap.au32X_step));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Num[PQ_TOOL_SDR2HDR],  g_stToolHdrTmap.au32X_num,  sizeof(g_stToolHdrTmap.au32X_num));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Pos[PQ_TOOL_SDR2HDR],  g_stToolHdrTmap.au32X_pos,  sizeof(g_stToolHdrTmap.au32X_pos));

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrTmCoef.au32Clut[PQ_TOOL_SDR2HDR], g_stToolHdrTmap.au32Y_LUT, sizeof(g_stToolHdrTmap.au32Y_LUT));
            break;
        default:
            HI_ERR_PQ("PQ Tool Only Support Hdr2Sdr & Sdr2Hdr Now \n");
            break;
    }

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHdrTMap(HI_PQ_HDR_TMAP_S *pstHdrTmap)
{
    HI_U32 i;

    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrTmap);

    memcpy(pstHdrTmap, &g_stToolHdrTmap, sizeof(g_stToolHdrTmap));
    /* Tool Recieve Clut * 2^16 */
    for (i = 0; i <  64; i++)
    {
        pstHdrTmap->au32Y_LUT[i] = pstHdrTmap->au32Y_LUT[i] << (16 - sg_au16ToolTmScale);
    }

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_SetHdrSMap(HI_PQ_HDR_SMAP_S *pstHdrSmap)
{
    HI_U32 i;
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrSmap);
    memcpy(&g_stToolHdrSmap, pstHdrSmap, sizeof(g_stToolHdrSmap));

    for (i = 0; i <  32; i++)
    {
        g_stToolHdrSmap.au32Y_LUT[i] = HDR_CLIP3(0, 65535, pstHdrSmap->au32Y_LUT[i] >> (16 - sg_au16ToolSmScale));
    }

    switch (sg_enHDRMode)
    {
        case HI_PQ_HDR_MODE_HDR10_TO_SDR:
            /* Tmap Clut First Para = 0 */
            //g_stToolHdrSmap.au32Y_LUT[0] = 0;

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Step[PQ_TOOL_HDR2SDR], g_stToolHdrSmap.au32X_step, sizeof(g_stToolHdrSmap.au32X_step));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Num[PQ_TOOL_HDR2SDR],  g_stToolHdrSmap.au32X_num,  sizeof(g_stToolHdrSmap.au32X_num));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Pos[PQ_TOOL_HDR2SDR],  g_stToolHdrSmap.au32X_pos,  sizeof(g_stToolHdrSmap.au32X_pos));

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Clut[PQ_TOOL_HDR2SDR], g_stToolHdrSmap.au32Y_LUT,  sizeof(g_stToolHdrSmap.au32Y_LUT));
            break;
        case HI_PQ_HDR_MODE_SDR_TO_HDR10:
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Step[PQ_TOOL_SDR2HDR], g_stToolHdrSmap.au32X_step, sizeof(g_stToolHdrSmap.au32X_step));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Num[PQ_TOOL_SDR2HDR],  g_stToolHdrSmap.au32X_num,  sizeof(g_stToolHdrSmap.au32X_num));
            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Pos[PQ_TOOL_SDR2HDR],  g_stToolHdrSmap.au32X_pos,  sizeof(g_stToolHdrSmap.au32X_pos));

            memcpy(sg_pstHdrBinPara->stPQCoef.stHdrSmCoef.au32Clut[PQ_TOOL_SDR2HDR], g_stToolHdrSmap.au32Y_LUT, sizeof(g_stToolHdrSmap.au32Y_LUT));
            break;
        default:
            HI_ERR_PQ("PQ Tool HdrSmap Only Support Hdr2Sdr & Sdr2Hdr Now \n");
            break;
    }

    return HI_SUCCESS;
}

HI_S32 PQ_HAL_Tool_GetHdrSMap(HI_PQ_HDR_SMAP_S *pstHdrSmap)
{
    HI_U32 i;
    PQ_CHECK_NULL_PTR_RE_FAIL(pstHdrSmap);

    memcpy(pstHdrSmap, &g_stToolHdrSmap, sizeof(g_stToolHdrSmap));

    /* Tool Recieve Clut * 2^16 */
    for (i = 0; i <  32; i++)
    {
        pstHdrSmap->au32Y_LUT[i] = g_stToolHdrSmap.au32Y_LUT[i] << (16 - sg_au16ToolSmScale);
    }

    return HI_SUCCESS;
}

